<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OptiClinic - Planificaci√≥n Financiera y An√°lisis de Mercado</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #2563eb; --primary-dark: #1d4ed8; --accent: #0891b2; --success: #059669; --warning: #d97706; --danger: #dc2626;
      --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-600: #475569; --gray-900: #0f172a;
      --bg: var(--gray-50); --card: var(--white); --text: var(--gray-900); --text-muted: var(--gray-600); --border: var(--gray-200);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1); --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg, var(--gray-50) 0%, #e0f2fe 100%); color: var(--text); font-family: 'Inter', system-ui, sans-serif; line-height: 1.6; min-height: 100vh; }

    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: var(--white); padding: 3rem 0; position: relative; overflow: hidden; }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 1; }
    .brand { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }

    /* ====== LOGO (actualizado) ====== */
 /* Logo grande, sin padding, y con ‚Äúzoom‚Äù en la imagen */
.logo{
  width: 132px;          /* ajusta 120‚Äì160px si quieres */
  height: 132px;
  background: var(--white);
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;            /* sin padding para aprovechar todo */
  overflow: hidden;      /* por si cover recorta */
  flex-shrink: 0;
  box-shadow: 0 4px 10px rgb(0 0 0 / 0.08);
}

.logo img{
  width: 100%;
  height: 100%;
  object-fit: cover;     /* rellena y reduce el borde blanco del JPG */
  display: block;
  border-radius: 14px;
  transform: scale(1.18);  /* ‚Äúzoom‚Äù para compensar margen blanco interno */
  transform-origin: center;
}

@media (max-width: 640px){
  .logo{ width: 96px; height: 96px; }
  .logo img{ transform: scale(1.12); }
}

    /* ====== /LOGO ====== */

    .brand-name { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; margin: 0; }
    .brand-tagline { font-size: 0.875rem; opacity: 0.9; font-weight: 500; }
    .header h1 { font-size: clamp(1.875rem, 4vw, 3rem); font-weight: 700; margin: 0 0 1rem; line-height: 1.2; }
    .header-description { font-size: 1.125rem; opacity: 0.95; max-width: 600px; line-height: 1.6; }

    .container { max-width: 1400px; margin: -2rem auto 0; padding: 0 2rem 4rem; position: relative; z-index: 2; }

    /* Tabs */
    .tabs { display: flex; background: var(--white); border-radius: 16px 16px 0 0; box-shadow: var(--shadow-lg); margin-bottom: 0; overflow-x: auto; }
    .tab { padding: 1rem 2rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; white-space: nowrap; transition: all 0.3s; }
    .tab.active { border-bottom-color: var(--primary); background: var(--gray-50); color: var(--primary); }
    .tab:hover:not(.active) { background: var(--gray-50); }

    .tab-content { display: none; background: var(--white); border-radius: 0 0 16px 16px; box-shadow: var(--shadow-lg); }
    .tab-content.active { display: block; }

    .grid { display: grid; gap: 2rem; grid-template-columns: 1fr; padding: 2rem; }
    @media (min-width: 1200px) { .grid { grid-template-columns: 480px 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow-lg); transition: all 0.3s; overflow: hidden; }
    .card:hover { box-shadow: var(--shadow-xl); transform: translateY(-2px); }
    .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .card-title { margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text); }
    .card-body { padding: 1.5rem; }

    .badge { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary); color: var(--white); padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600; }
    .section-title { margin: 1.5rem 0 0.75rem; font-size: 0.875rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

    .form-row { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    .form-row-3 { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 1024px) { .form-row-3 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .form-row, .form-row-3 { grid-template-columns: 1fr; } }

    label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    input, select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; font: inherit; font-size: 0.875rem; transition: all 0.2s; background: var(--white); color: var(--text); }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1); }
    input[readonly] { background: var(--gray-50); color: var(--text-muted); }

    .switch { display:flex; align-items:center; gap:.5rem; }
    .switch input { width:auto; }

    .btn { cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; }
    .btn-primary { background: var(--primary); color: var(--white); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--white); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--gray-50); }
    .btn-success { background: var(--success); color: var(--white); }

    .kpi-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem; }
    .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
    .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text); margin-bottom: 0.5rem; }
    .kpi-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 600; }

    .status-indicator { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--gray-50); border-radius: 12px; margin-bottom: 1.5rem; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.success { background: var(--success); }
    .status-dot.warning { background: var(--warning); }
    .status-dot.danger { background: var(--danger); }

    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th { background: var(--gray-50); padding: 0.75rem 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
    .table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); }
    .table tbody tr:hover { background: var(--gray-50); }
    .table-success { color: var(--success); font-weight: 600; }
    .table-danger { color: var(--danger); font-weight: 600; }

    .charts-grid { display: grid; gap: 1.5rem; grid-template-columns: 1fr; margin: 2rem 0; }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
    .chart-container { position: relative; height: 300px; background: var(--white); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow-lg); }

    .divider { height: 1px; background: var(--border); margin: 2rem 0; }

    .summary-grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow-lg); }
    .summary-title { font-weight:700; font-size:.95rem; margin:0 0 .5rem; color:#0f172a; }
    .summary-value { font-weight:800; font-size:1.25rem; }
    .summary-muted { color:var(--gray-600); font-size:.85rem; }

    /* Competitor styles */
    .competitor-item { background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .competitor-url { font-family: monospace; color: var(--primary); word-break: break-all; flex: 1; }
    .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-left: 1rem; }
    .status-pending { background: var(--warning); color: white; }
    .status-success { background: var(--success); color: white; }
    
    .analysis-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin: 1.5rem 0; }
    .analysis-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-lg); }
    .analysis-title { margin: 0 0 1rem; font-size: 1.1rem; font-weight: 700; color: var(--primary); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">
          <img
            src="https://i.imgur.com/eRKd3Hp.jpeg"
            alt="Logo OptimClinic"
            loading="lazy"
	    crossorigin="anonymous"
            referrerpolicy="no-referrer"
          />
        </div>
        <div>
          <h1 class="brand-name">OptimClinic</h1>
          <div class="brand-tagline">Consultor√≠a m√©dica especializada</div>
        </div>
      </div>
      <h1>Planificaci√≥n Financiera y An√°lisis de Mercado</h1>
      <p class="header-description">
        Herramienta profesional completa con proyecciones financieras, an√°lisis de competencia y estrategia de mercado.
      </p>
    </div>
  </header>

  <main class="container">
    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('financial')">üìä Planificaci√≥n Financiera</div>
      <div class="tab" onclick="switchTab('competitors')">üîç An√°lisis de Competidores</div>
      <div class="tab" onclick="switchTab('market')">üìà Inteligencia de Mercado</div>
      <div class="tab" onclick="switchTab('reports')">üìã Informes</div>
    </div>

    <!-- Financial Planning Tab (TU C√ìDIGO ORIGINAL COMPLETO) -->
    <div class="tab-content active" id="financial-tab">
      <div class="grid">
        <!-- Configuraci√≥n -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">üìä Configuraci√≥n</h2>
            <div style="display:flex; gap:.75rem; align-items:center;">
              <span class="badge">EUR</span>
              <select id="ivaSel" style="padding:.25rem .5rem; width:auto" title="Tipo de IVA">
                <option value="0" selected>IVA 0%</option>
                <option value="10">IVA 10%</option>
                <option value="21">IVA 21%</option>
              </select>
            </div>
          </div>

          <div class="card-body">
            <div class="section-title">üí∞ Inversi√≥n y Horizonte</div>
            <div class="form-row-3">
              <div><label for="provincia">Provincia</label>
                <select id="provincia" onchange="actualizarDatosMercado()">
                  <option value="Valencia">Valencia</option>
                  <option value="Alicante">Alicante</option>
                  <option value="Castell√≥n">Castell√≥n</option>
                  <option value="Madrid">Madrid</option>
                  <option value="Barcelona">Barcelona</option>
                  <option value="Sevilla">Sevilla</option>
                  <option value="M√°laga">M√°laga</option>
                  <option value="Vizcaya">Vizcaya</option>
                  <option value="Murcia">Murcia</option>
                  <option value="Zaragoza">Zaragoza</option>
                  <option value="Otra">Otra</option>
                </select>
              </div>
              <div><label for="capex">CAPEX (inversi√≥n inicial) ‚Ç¨</label><input id="capex" type="number" value="80000" /></div>
              <div><label for="meses">Meses proyecci√≥n</label><input id="meses" type="number" value="36" min="6" max="84" /></div>
            </div>
            <div class="form-row">
              <div><label for="mesInicio">Mes inicial</label><input id="mesInicio" type="month" /></div>
            </div>

            <div class="section-title">üè¶ Financiaci√≥n del CAPEX</div>
            <div class="form-row-3">
              <div><label for="finImporte">Importe financiado ‚Ç¨</label><input id="finImporte" type="number" value="40000" /></div>
              <div><label for="finInteres">Inter√©s anual %</label><input id="finInteres" type="number" value="6" step="0.1" /></div>
              <div><label for="finPlazo">Plazo (meses)</label><input id="finPlazo" type="number" value="36" min="1" /></div>
            </div>
            <div class="form-row">
              <div><label for="finCarencia">Carencia (meses, solo intereses)</label><input id="finCarencia" type="number" value="0" min="0" /></div>
              <div><label for="tasaDesc">Tasa descuento anual % (VAN/TIR)</label><input id="tasaDesc" type="number" value="10" step="0.1" /></div>
            </div>

            <div class="section-title">üí≥ Mix de Pagadores</div>
            <div class="form-row-3">
              <div><label for="pctPriv">% Privado</label><input id="pctPriv" type="number" value="60" min="0" max="100" /></div>
              <div><label for="tarPriv">Tarifa Privado ‚Ç¨</label><input id="tarPriv" type="number" value="120" /></div>
              <div><label for="pctAseg">% Aseguradora</label><input id="pctAseg" type="number" value="40" min="0" max="100" /></div>
            </div>
            <div class="form-row-3">
              <div><label for="tarAseg">Tarifa Aseguradora ‚Ç¨</label><input id="tarAseg" type="number" value="70" /></div>
              <div><label for="ticketMedio">Ticket medio efectivo ‚Ç¨</label><input id="ticketMedio" type="number" value="0" readonly /></div>
              <div><label for="noShow">No-show / cancelaciones %</label><input id="noShow" type="number" value="8" step="0.1" /></div>
            </div>

            <div class="section-title">üë• Capacidad por Recursos</div>
            <div class="form-row-3">
              <div><label for="profesionales">Profesionales</label><input id="profesionales" type="number" value="2" min="1" /></div>
              <div><label for="horasDia">Horas/d√≠a</label><input id="horasDia" type="number" value="7" step="0.5" /></div>
              <div><label for="diasMes">D√≠as/mes</label><input id="diasMes" type="number" value="22" min="1" /></div>
            </div>
            <div class="form-row">
              <div><label for="minVisita">Minutos por visita</label><input id="minVisita" type="number" value="30" min="5" /></div>
              <div><label for="capacidadCalc">Capacidad calculada pacientes/mes</label><input id="capacidadCalc" type="number" value="0" readonly /></div>
            </div>

            <div class="section-title">üìà Demanda y Marketing</div>
            <div class="form-row-3">
              <div><label for="serviciosMes">Pacientes planificados/mes inicial</label><input id="serviciosMes" type="number" value="180" /></div>
              <div><label for="crecDemanda">Crecimiento org√°nico %/mes</label><input id="crecDemanda" type="number" value="3" step="0.1" /></div>
              <div><label for="mktMes">Presupuesto marketing/mes ‚Ç¨</label><input id="mktMes" type="number" value="800" /></div>
            </div>
            <div class="form-row">
              <div><label for="cpa">CPA (coste por alta) ‚Ç¨</label><input id="cpa" type="number" value="40" /></div>
            </div>
<!-- === Curva de crecimiento y estacionalidad === -->
<div class="card">
  <h3 style="margin:0 0 8px">Crecimiento & Estacionalidad</h3>
  <div class="grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">
    <div>
      <label class="lbl">Perfil de crecimiento</label>
      <select id="growthProfile" class="inp">
        <option value="linear">Lineal (% mensual)</option>
        <option value="ramp">Rampa (adopci√≥n)</option>
        <option value="logistic">Log√≠stica (S-curve)</option>
        <option value="annual_target">Objetivo anual</option>
      </select>
    </div>
    <div>
      <label class="lbl">% crecimiento mensual base</label>
      <input id="growPct" type="number" class="inp" step="0.1" value="2">
      <small class="muted">Solo aplica a Lineal y como punto de partida en Rampa/Log√≠stica</small>
    </div>
    <div id="rampBox">
      <label class="lbl">Rampa (meses hasta madurez)</label>
      <input id="rampMonths" type="number" class="inp" step="1" value="6">
      <small class="muted">Meses en alcanzar velocidad de crucero</small>
    </div>
    <div id="satBox">
      <label class="lbl">Saturaci√≥n m√°x. sobre base (%)</label>
      <input id="saturationPct" type="number" class="inp" step="1" value="60">
      <small class="muted">Tope de crecimiento acumulado (Log√≠stica)</small>
    </div>
    <div id="annualBox" style="display:none">
      <label class="lbl">Objetivo anual de servicios</label>
      <input id="annualTarget" type="number" class="inp" step="1" value="0">
      <small class="muted">Distribuye por estacionalidad y limita por capacidad</small>
    </div>
  </div>

  <hr style="margin:12px 0">

  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button type="button" class="btn" data-preset="generic" id="btnPresetGen">Preset: Gen√©rico</button>
    <button type="button" class="btn" data-preset="summer_es" id="btnPresetSummer">Preset: Verano (ES)</button>
    <button type="button" class="btn" data-preset="q4_peak" id="btnPresetQ4">Preset: Pico Q4</button>
    <button type="button" class="btn" id="btnResetSeason">Reset 1.00</button>
  </div>

  <div style="overflow:auto;margin-top:8px">
    <table style="border-collapse:collapse;min-width:620px">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee">Mes</th>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee">Factor</th>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee">Mes</th>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eee">Factor</th>
        </tr>
      </thead>
      <tbody id="seasonTableBody"></tbody>
    </table>
  </div>
  <small class="muted">Factor 1.00 = normal; 0.85 = ‚àí15% demanda; 1.15 = +15%.</small>
</div>


<div class="section-title">ü§ù Colaboradores (alquiler + revenue share)</div>
<div class="form-row-3">
  <div>
    <label for="colabCount">M√©dicos colaboradores (n¬∫)</label>
    <input id="colabCount" type="number" value="0" min="0" />
  </div>
  <div>
    <label for="colabAlquiler">Alquiler fijo/mes ‚Ç¨</label>
    <input id="colabAlquiler" type="number" value="0" min="0" />
  </div>
  <div>
    <label for="colabShare">% que retenemos</label>
    <input id="colabShare" type="number" value="0" min="0" max="100" step="0.5" />
  </div>
</div>
<div class="form-row-3">
  <div>
    <label for="colabHorasDia">Horas/d√≠a colaborador</label>
    <input id="colabHorasDia" type="number" value="7" step="0.5" />
  </div>
  <div>
    <label for="colabDiasMes">D√≠as/mes</label>
    <input id="colabDiasMes" type="number" value="22" />
  </div>
  <div>
    <label for="colabMinVisita">Minutos/visita</label>
    <input id="colabMinVisita" type="number" value="30" min="5" />
  </div>
</div>
<div class="form-row-3">
  <div>
    <label for="colabTarifa">Tarifa media paciente ‚Ç¨</label>
    <input id="colabTarifa" type="number" value="100" />
  </div>
  <div>
    <label for="colabPacientesIni">Pacientes iniciales/mes</label>
    <input id="colabPacientesIni" type="number" value="50" />
  </div>
  <div>
    <label for="colabCrec">% crecimiento mensual</label>
    <input id="colabCrec" type="number" value="5" step="0.1" />
  </div>
</div>

            <div class="section-title">üí∞ Costes</div>
            <div class="form-row-3">
              <div><label for="costesFijos">Costes fijos/mes ‚Ç¨</label><input id="costesFijos" type="number" value="12000" /></div>
              <div><label for="crecCF">Crec. costes fijos %/a√±o</label><input id="crecCF" type="number" value="3" step="0.1" /></div>
              <div><label for="costeVariable">Coste variable/paciente ‚Ç¨</label><input id="costeVariable" type="number" value="25" /></div>
            </div>

            <div class="section-title">üßæ Impuestos y Cobros</div>
            <div class="form-row-3">
              <div>
                <label for="impSoc">Impuesto sociedades %</label>
                <div class="switch"><input id="toggleImp" type="checkbox" checked /><label for="toggleImp">Aplicar</label></div>
                <input id="impSoc" type="number" value="25" step="0.1" />
              </div>
              <div>
                <label for="dsoAseg">Plazo cobro aseguradora (d√≠as)</label>
                <div class="switch"><input id="toggleDSO" type="checkbox" checked /><label for="toggleDSO">Aplicar</label></div>
                <input id="dsoAseg" type="number" value="60" min="0" step="1" />
              </div>
              <div><label for="amortMeses">Amortizaci√≥n contable (meses)</label><input id="amortMeses" type="number" value="36" min="1" /></div>
            </div>

            <div class="form-row" style="margin-top: 2rem;">
              <button id="calc" class="btn btn-primary" title="Generar an√°lisis completo">üìä Generar An√°lisis Completo</button>
              <button id="reset" class="btn btn-secondary" title="Restablecer par√°metros">üîÑ Restablecer</button>
            </div>
          </div>
        </section>

        <!-- Resultados -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">üìà Resultados</h2>
          </div>
          <div class="card-body">
            <div class="status-indicator">
              <div class="status-dot warning" id="statusDot"></div>
              <div id="statusText">Configure los par√°metros y genere el an√°lisis</div>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card"><div class="kpi-value" id="kpiBreakeven">‚Äî</div><div class="kpi-label">Break-even</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiROI">‚Äî</div><div class="kpi-label">ROI Final</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiNPV">‚Äî</div><div class="kpi-label">VAN (NPV)</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiIRR">‚Äî</div><div class="kpi-label">TIR Anual</div></div>
            </div>

            <h3 style="margin:2rem 0 1rem">üéØ Calculadora de Punto de Equilibrio</h3>
            <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0891b2;">
              <div class="card-body">
                <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="precioMinimo" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Precio M√≠nimo ‚Ç¨</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="pacientesMinimos" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Pacientes M√≠nimos/mes</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="margenActual" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Margen Actual %</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="zonaRentabilidad" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Estado</div></div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 12px;">
                  <h4 style="margin: 0 0 1rem; font-size: 0.95rem; color: #0891b2;">üí° An√°lisis de Viabilidad</h4>
                  <div id="analisisViabilidad" style="font-size: 0.875rem; line-height: 1.6; color: #475569;">Configure los par√°metros y genere el an√°lisis para ver las recomendaciones.</div>
                </div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üéØ An√°lisis de Sensibilidad</h3>
            <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #d97706;">
              <div class="card-body">
                <div style="margin-bottom: 2rem;">
                  <h4 style="margin: 0 0 1rem; font-size: 1rem; color: #92400e;">üìä Tornado Chart - Cambio en ROI Final (p.p.)</h4>
                  <div style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: .5rem; height: 350px;">
                    <canvas id="tornadoChart"></canvas>
                  </div>
                  <div style="text-align:right; font-size:.85rem; color:#64748b; margin-bottom: 1rem;">
                    ROI base: <span id="roiBaseLabel">‚Äî</span>
                  </div>
                  <div style="background: #fef3c7; border-radius: 8px; padding: 1rem; font-size: 0.875rem; line-height: 1.5;">
                    <strong>üí° C√≥mo interpretar este gr√°fico:</strong><br>
                    ‚Ä¢ <span style="color: #dc2626;">Barras rojas:</span> Cu√°nto BAJA el ROI si esa variable empeora un 20%<br>
                    ‚Ä¢ <span style="color: #16a34a;">Barras verdes:</span> Cu√°nto SUBE el ROI si esa variable mejora un 20%<br>
                    ‚Ä¢ <strong>Las variables de arriba tienen m√°s impacto</strong> - son tus palancas m√°s poderosas
                  </div>
                </div>

                <div>
                  <h4 style="margin: 0 0 1rem; font-size: 1rem; color: #92400e;">üîÑ Simulador "¬øQu√© pasar√≠a si...?"</h4>
                  <div style="background: white; border-radius: 12px; padding: 1.5rem;">
                    <div class="form-row" style="margin-bottom: 1rem;">
                      <div>
                        <label for="simTarifa">Tarifa efectiva ‚Ç¨</label>
                        <input id="simTarifa" type="range" min="50" max="200" step="5" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simTarifaValue">‚Äî</div>
                      </div>
                      <div>
                        <label for="simPacientes">Pacientes iniciales</label>
                        <input id="simPacientes" type="range" min="50" max="300" step="10" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simPacientesValue">‚Äî</div>
                      </div>
                    </div>

                    <div class="form-row" style="margin-bottom: 1rem;">
                      <div>
                        <label for="simCrecimiento">Crecimiento %/mes</label>
                        <input id="simCrecimiento" type="range" min="0" max="10" step="0.5" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simCrecimientoValue">‚Äî</div>
                      </div>
                      <div>
                        <label for="simCostesFijos">Costes fijos ‚Ç¨</label>
                        <input id="simCostesFijos" type="range" min="5000" max="20000" step="500" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simCostesFijosValue">‚Äî</div>
                      </div>
                    </div>

                    <div style="background: #f0f9ff; border-radius: 8px; padding: 1rem;">
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af; margin-bottom: 0.25rem;" id="simROI">‚Äî</div>
                          <div style="font-size: 0.875rem; color: #64748b;">ROI Final</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: #059669; margin-bottom: 0.25rem;" id="simEBITDA">‚Äî</div>
                          <div style="font-size: 0.875rem; color: #64748b;">EBITDA √∫ltimo mes</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üìä Evoluci√≥n Financiera</h3>
            <div class="charts-grid">
              <div class="card">
                <div class="card-header"><h4 style="margin:0; font-size:1rem">P&L Operativo</h4></div>
                <div class="chart-container"><canvas id="chartPnl"></canvas></div>
              </div>
              <div class="card">
                <div class="card-header"><h4 style="margin:0; font-size:1rem">Flujo de Caja</h4></div>
                <div class="chart-container"><canvas id="chartCash"></canvas></div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üìã Detalle Mensual</h3>
            <div style="overflow:auto">
              <table class="table" id="tabla">
                <thead><tr>
  <th>Mes</th><th>Planif.</th><th>Efectivos</th><th>Ingresos</th><th>Ing. Colab</th><th>C.Var</th><th>C.Fijos</th><th>EBITDA</th><th>Amort.</th><th>EBIT</th><th>Intereses</th><th>Impuestos</th><th>Principal</th><th>Flujo Caja</th><th>Acumulado</th>
</tr></thead>
                <tbody></tbody>
              </table>
            </div>

<!-- Card resumen descargable a PDF -->
<div id="detalleCompleto" class="card p-4" style="margin-top:1rem; padding:1rem;">
  <div class="flex items-center justify-between mb-3" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem;">
    <img src="img/logo-clinica.png" alt="Logo" style="height: 40px;">
    <h2 class="text-xl font-semibold" style="margin:0;">Informe Financiero ‚Äì Escenario Base</h2>
  </div>

  <p class="text-gray-600 mb-2" style="margin:0 0 .75rem; color:#475569;">
    <strong>Supuestos principales:</strong><br>
    CAPEX: <span id="supCapex"></span> ¬∑ Horizonte: <span id="supMeses"></span> meses<br>
    Financiaci√≥n: <span id="supFinanciacion"></span><br>
    DSO aseguradoras: <span id="supDSO"></span> ¬∑ Impuesto sociedades: <span id="supImp"></span>
  </p>

  <div id="tablaDetalle"></div>

  <button id="btnPDFDetalle" class="btn btn-secondary" style="margin-top: .75rem;">üìÑ Descargar PDF (completo)</button>
</div>


            <div class="divider"></div>
            <h3 style="margin:2rem 0 1rem">üíß Resumen de Caja</h3>
            <div class="summary-grid" id="cashSummary"></div>

<div class="divider"></div>
<h3 style="margin:2rem 0 1rem">üß† An√°lisis con IA para M√©dicos</h3>
<div class="card" style="background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border: 2px solid #6366f1;">
  <div class="card-body">
    <p style="margin-top:0; color:#334155; font-size:0.95rem;">
      Pulsa el bot√≥n para obtener un <strong>resumen en lenguaje claro</strong> y una <strong>gu√≠a de conceptos financieros</strong>.
    </p>
    <div class="form-row" style="margin-bottom: .5rem;">
      <button id="aiAnalyze" class="btn btn-primary">üß† Analizar con IA</button>
    </div>
    <div id="aiSummary" class="analysis-grid" style="display:none; margin-top:1rem;">
      <div class="analysis-card">
        <h3 class="analysis-title">üéØ Resumen Ejecutivo</h3>
        <div id="aiExecutive"></div>
      </div>
      <div class="analysis-card">
        <h3 class="analysis-title">üìö Gu√≠a para no financieros</h3>
        <div id="aiGlossary"></div>
      </div>
      <div class="analysis-card">
        <h3 class="analysis-title">üß© Palancas y Riesgos</h3>
        <div id="aiLevers"></div>
      </div>
    </div>
  </div>
</div>

            <div class="divider"></div>
            <div class="form-row">
              <button id="exportCsv" class="btn btn-primary">üìä Exportar CSV</button>
              <button id="exportXlsx" class="btn btn-secondary">üìä Exportar XLSX</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Competitors Tab -->
    <div class="tab-content" id="competitors-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîç An√°lisis de Competidores</h2>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <span class="badge" id="competitorCount">0 a√±adidos</span>
            <button class="btn btn-success" onclick="loadSampleCompetitors()">üìù Cargar Ejemplo</button>
          </div>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 1rem;">
            <label for="competitorUrl">URL del competidor</label>
<div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
  <input type="url" id="competitorUrl" placeholder="https://clinica-ejemplo.com" style="flex: 2;" />
  <input type="text" id="competitorPrecios" placeholder="Precios (opcional): ej. Consulta ‚Ç¨80, Cirug√≠a ‚Ç¨4500" style="flex: 3;" />
  <button class="btn btn-primary" onclick="addCompetitor()">A√±adir</button>
</div>
<p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">
  üí° Los precios son opcionales. Si los conoces, a√±√°delos manualmente para un an√°lisis m√°s preciso.
</p>
          </div>
          
          <div id="competitorList" style="min-height: 100px;">
            <p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay competidores a√±adidos</p>
          </div>
          
          <div style="margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-success" onclick="analyzeCompetitors()" disabled id="analyzeBtn">üöÄ Analizar Competidores</button>
          </div>
        </div>
      </div>

      <div id="competitorResults" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìä Resultados del An√°lisis</h2>
          </div>
          <div class="card-body">
            <div class="analysis-grid">
              <div class="analysis-card">
                <h3 class="analysis-title">üéØ Resumen Ejecutivo</h3>
                <div id="executiveSummary"></div>
              </div>
              
              <div class="analysis-card">
                <h3 class="analysis-title">üìà An√°lisis de Mercado</h3>
                <div id="marketAnalysis"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

   <!-- Market Intelligence Tab -->
    <div class="tab-content" id="market-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìà Inteligencia de Mercado</h2>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <select id="especialidadScraper" style="padding:.5rem; font-size:0.8rem; display:none">
              <option value="">General</option>
              <option value="traumatologia">Traumatolog√≠a</option>
              <option value="fisioterapia">Fisioterapia</option>
              <option value="dermatologia">Dermatolog√≠a</option>
              <option value="ginecologia">Ginecolog√≠a</option>
              <option value="pediatria">Pediatr√≠a</option>
              <option value="psicologia">Psicolog√≠a</option>
            </select>
            <button id="adminScraperBtn" class="btn btn-secondary" style="font-size:0.8rem; display:none">
              Admin: Actualizar Precios
            </button>
          </div>
        </div>
        <div class="card-body">
          <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid var(--success); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0; color: #059669;">üè• Datos del Sector - <span id="provinciaActual">Valencia</span></h3>
              <a href="https://www.fundacionidis.com/sanidad-privada-aportando-valor" target="_blank" style="color: #059669; text-decoration: none; font-size: 0.875rem;">
                üìä Ver fuente IDIS ‚Üó
              </a>
            </div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="rangoConsulta">‚Ç¨70-130</div>
                <div class="kpi-label">Rango consulta especializada</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="mixPrivado">58%</div>
                <div class="kpi-label">Mix privado estimado</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="crecimientoSector">11%</div>
                <div class="kpi-label">Crecimiento anual estimado</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="dsoPromedio">52 d√≠as</div>
                <div class="kpi-label">DSO promedio aseguradoras</div>
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.75rem; color: #475569;">
              <strong>‚ö†Ô∏è Nota sobre los datos:</strong> Estimaciones basadas en informes sectoriales de IDIS (Fundaci√≥n Instituto para el Desarrollo e Integraci√≥n de la Sanidad), datos del INE sobre renta per c√°pita provincial, y ajustes regionales. Estos valores son aproximados para planificaci√≥n estrat√©gica, no constituyen precios oficiales. Se recomienda validar con investigaci√≥n de mercado local.
            </div>
          </div>

          <div class="analysis-grid">
            <div class="analysis-card">
              <h3 class="analysis-title">üìä Benchmarks Financieros</h3>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <p><strong>EBITDA objetivo:</strong> 25-35% sobre ingresos</p>
                <p><strong>Margen bruto:</strong> 65-75% (consulta - coste variable)</p>
                <p><strong>Costes fijos:</strong> 40-50% sobre ingresos</p>
                <p><strong>Marketing:</strong> 5-8% sobre ingresos</p>
                <p><strong>ROI esperado:</strong> 150-250% a 3 a√±os</p>
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Fuente: Promedios sectoriales IDIS 2024</p>
              </div>
            </div>

            <div class="analysis-card">
              <h3 class="analysis-title">üéØ Factores Cr√≠ticos de √âxito</h3>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <p><strong>Ubicaci√≥n:</strong> Zona de alta renta, f√°cil acceso</p>
                <p><strong>Especializaci√≥n:</strong> Nicho espec√≠fico vs generalista</p>
                <p><strong>Tecnolog√≠a:</strong> Telemedicina, cita online</p>
                <p><strong>Experiencia:</strong> A√±os del equipo m√©dico</p>
                <p><strong>Servicios:</strong> Cartera completa vs especializada</p>
              </div>
            </div>
          </div>

          <div class="card" style="margin: 2rem 0;">
            <div class="card-header">
              <h3 style="margin: 0;">üöÄ Generador de Estrategias</h3>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div>
                  <label for="estrategiaTipo">Tipo de estrategia</label>
                  <select id="estrategiaTipo">
                    <option value="premium">Premium / Diferenciaci√≥n</option>
                    <option value="volumen">Alto Volumen / Precio Competitivo</option>
                    <option value="nicho">Especializaci√≥n / Nicho</option>
                    <option value="mixta">Estrategia Mixta</option>
                  </select>
                </div>
                <div>
                  <label for="ubicacionTipo">Tipo de ubicaci√≥n</label>
                  <select id="ubicacionTipo">
                    <option value="centro">Centro urbano</option>
                    <option value="residencial">Zona residencial</option>
                    <option value="comercial">Centro comercial</option>
                    <option value="hospital">Cerca de hospital</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="generateStrategy()">üß† Generar Estrategia Personalizada</button>
              
              <div id="strategyOutput" style="display: none; margin-top: 1.5rem;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Informes y Exportaci√≥n</h2>
        </div>
        <div class="card-body">
          <div class="analysis-grid">
            <div class="analysis-card">
              <h3 class="analysis-title">üìä Informe Ejecutivo</h3>
              <p>Resumen completo para presentar a bancos, inversores o socios.</p>
              <button class="btn btn-primary" onclick="generateExecutiveReport()">üìã Generar Informe</button>
            </div>

            <div class="analysis-card">
              <h3 class="analysis-title">üìà Dossier para Bancos</h3>
              <p>Documento espec√≠fico para solicitudes de financiaci√≥n.</p>
              <button class="btn btn-primary" onclick="generateBankDossier()">üè¶ Generar Dossier</button>
            </div>

<!-- NUEVO: Informe Integral (TOP) + Generaci√≥n Gamma (Finanzas) -->
<div class="analysis-card">
  <h3 class="analysis-title">üèÜ Informe Integral (TOP)</h3>
  <p>Integra Finanzas + Competidores + Mercado en un √∫nico documento con gr√°ficos y conclusiones.</p>
  <div class="form-row">
    <button class="btn btn-primary" onclick="generateMasterReport()">üß† Generar Informe Integral</button>
    <button class="btn btn-secondary" onclick="exportMasterReportPDF()">üñ®Ô∏è Exportar PDF</button>
  </div>
</div>

<!-- Configuraci√≥n de Informes -->
<div class="card" style="margin: 2rem 0;">
  <div class="card-header">
    <h3 style="margin: 0;">üéØ Configuraci√≥n de Informes</h3>
  </div>
  <div class="card-body">
    <div class="form-row">
      <div>
        <label for="empresaNombre">Nombre de la empresa</label>
        <input id="empresaNombre" type="text" placeholder="Cl√≠nica Ejemplo S.L." />
      </div>
      <div>
        <label for="responsableNombre">Responsable del proyecto</label>
        <input id="responsableNombre" type="text" placeholder="Dr. Juan P√©rez" />
      </div>
    </div>
  </div>
</div>

<!-- NUEVO: Presentaci√≥n Gamma (Finanzas) -->
<div class="analysis-card">
  <h3 class="analysis-title">üéûÔ∏è Presentaci√≥n Gamma (Finanzas)</h3>
  <p>Genera un prompt listo para pegar en Gamma con la parte financiera (autoexplicativa) usando los datos actuales.</p>
  <div class="form-row">
    <button id="btnDossierFin" class="btn btn-primary">Generar dossier (Financiero)</button>
  </div>
  <small style="display:block; margin-top:.5rem; opacity:.75;">
    Tip: primero pulsa <strong>üìä Generar An√°lisis Completo</strong> en Planificaci√≥n Financiera para poblar los datos.
  </small>
</div>

<!-- Vista previa Informe (se mantiene) -->
<div id="reportPreview" style="display: none;">
  <div class="card">
    <div class="card-header">
      <h3 style="margin: 0;">üëÅÔ∏è Vista Previa del Informe</h3>
    </div>
    <div class="card-body" id="reportContent"></div>
  </div>
</div>

<!-- MODAL: Prompt para Gamma (manual) -->
<div id="modalPrompt" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9999;">
  <div style="max-width:900px; margin:5vh auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15);">
    <h3 style="margin-top:0;">Prompt generado (c√≥pialo y p√©galo en Gamma)</h3>
    <p style="margin:.25rem 0 1rem; opacity:.75;">El prompt incluye datos financieros + texto interpretativo. Gamma lo convertir√° en una presentaci√≥n 16:9.</p>
    <textarea id="taPrompt" rows="18" style="width:100%; font-family:ui-monospace,monospace; border:1px solid #e5e7eb; border-radius:8px; padding:10px;"></textarea>
    <div style="display:flex; gap:8px; margin-top:12px;">
      <button id="btnCopy" class="btn-primary">Copiar</button>
      <button id="btnDownload" class="btn-secondary">Descargar .md</button>
      <button id="btnClose" class="btn-tertiary">Cerrar</button>
    </div>
  </div>
</div>

</div>
</div>
</div>
</main>

<script>

    /* ===================== TU C√ìDIGO JAVASCRIPT ORIGINAL COMPLETO ===================== */
    const MONTHS_ES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    
    function parseMonthYYYYMM(v) {
      if (!v || !/^\d{4}-\d{2}$/.test(v)) return new Date();
      const [Y, M] = v.split('-').map(Number);
      return new Date(Y, M - 1, 1);
    }
    
    function addMonths(d, n) { return new Date(d.getFullYear(), d.getMonth() + n, 1); }
    function monthLabel(d) { return `${MONTHS_ES[d.getMonth()]}-${d.getFullYear()}`; }

    function eur(n) {
  var ivaSel = document.getElementById('ivaSel');
  var iva = Number(ivaSel ? ivaSel.value : 0) / 100;
  var x = Math.round(Number(n || 0) * (1 + iva)); // sin decimales
  var neg = x < 0 ? '-' : '';
  var s = Math.abs(x).toString();
  var grouped = s.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // 1.000.000
  return `${neg}${grouped}\u00A0‚Ç¨`; // NBSP evita salto de l√≠nea
}
    
    function getEl(id) { return document.getElementById(id); }
    function num(id) { var el = getEl(id); return Number(el && el.value || 0); }

    function pmt(rate, nper, pv) {
      if (nper <= 0) return 0;
      if (Math.abs(rate) < 1e-12) return pv / nper;
      return pv * rate / (1 - Math.pow(1 + rate, -nper));
    }
    
    function npv(rate, cashflows) { 
      return cashflows.reduce((acc, cf, i) => acc + cf / Math.pow(1 + rate, i), 0); 
    }
    
    function irrMonthly(cashflows) {
      const npvAt = r => npv(r, cashflows);
      let lo = -0.99, hi = 3.0;
      let fLo = npvAt(lo), fHi = npvAt(hi);
      if (isNaN(fLo) || isNaN(fHi)) return NaN;
      if (fLo * fHi > 0) {
        for (let k = 0; k < 20 && fLo * fHi > 0; k++) { hi *= 0.75; fHi = npvAt(hi); }
        if (fLo * fHi > 0) return NaN;
      }
      let x0 = lo, x1 = hi, f0 = fLo, f1 = fHi;
      for (let i = 0; i < 100; i++) {
        const denom = (f1 - f0);
        let x2 = (Math.abs(denom) > 1e-12) ? x1 - f1 * (x1 - x0) / denom : (x0 + x1) / 2;
        if (x2 <= lo || x2 >= hi || !isFinite(x2)) x2 = (lo + hi) / 2;
        const f2 = npvAt(x2);
        if (Math.abs(f2) < 1e-10) return x2;
        if (f0 * f2 <= 0) { hi = x2; f1 = f2; x1 = x2; } 
        else { lo = x2; f0 = f2; x0 = x2; }
        if (Math.abs(hi - lo) < 1e-7) return (lo + hi) / 2;
      }
      return (lo + hi) / 2;
    }

    var charts = { pnl: null, cash: null, tornado: null };
    var lastData = null;
    var competitors = [];

    /* ===================== BASE DE DATOS PROVINCIAS ===================== */
    const datosProvincia = {
      'Valencia': { consulta: '‚Ç¨70-130', mixPrivado: '58%', crecimiento: '11%', dso: '52 d√≠as' },
      'Alicante': { consulta: '‚Ç¨75-135', mixPrivado: '62%', crecimiento: '12%', dso: '50 d√≠as' },
      'Castell√≥n': { consulta: '‚Ç¨65-120', mixPrivado: '54%', crecimiento: '10%', dso: '55 d√≠as' },
      'Madrid': { consulta: '‚Ç¨90-180', mixPrivado: '72%', crecimiento: '14%', dso: '48 d√≠as' },
      'Barcelona': { consulta: '‚Ç¨85-170', mixPrivado: '68%', crecimiento: '13%', dso: '50 d√≠as' },
      'Sevilla': { consulta: '‚Ç¨70-140', mixPrivado: '60%', crecimiento: '11%', dso: '53 d√≠as' },
      'M√°laga': { consulta: '‚Ç¨75-145', mixPrivado: '64%', crecimiento: '13%', dso: '51 d√≠as' },
      'Vizcaya': { consulta: '‚Ç¨85-165', mixPrivado: '70%', crecimiento: '12%', dso: '49 d√≠as' },
      'Murcia': { consulta: '‚Ç¨68-125', mixPrivado: '56%', crecimiento: '10%', dso: '54 d√≠as' },
      'Zaragoza': { consulta: '‚Ç¨72-135', mixPrivado: '59%', crecimiento: '11%', dso: '52 d√≠as' },
      'Otra': { consulta: '‚Ç¨75-140', mixPrivado: '62%', crecimiento: '11%', dso: '52 d√≠as' }
    };

    function actualizarDatosMercado() {
      const provincia = getEl('provincia').value;
      const datos = datosProvincia[provincia];
      
      getEl('provinciaActual').textContent = provincia;
      getEl('rangoConsulta').textContent = datos.consulta;
      getEl('mixPrivado').textContent = datos.mixPrivado;
      getEl('crecimientoSector').textContent = datos.crecimiento;
      getEl('dsoPromedio').textContent = datos.dso;
    }

    function actualizarCalculos() {
      var pctPriv = Math.max(0, num('pctPriv')) / 100;
      var pctAseg = Math.max(0, num('pctAseg')) / 100;
      var tarPriv = Math.max(0, num('tarPriv'));
      var tarAseg = Math.max(0, num('tarAseg'));
      var mixSum = Math.max(0.01, pctPriv + pctAseg);
      var ticketMedio = (pctPriv * tarPriv + pctAseg * tarAseg) / mixSum;
      getEl('ticketMedio').value = ticketMedio.toFixed(2);

      var profesionales = Math.max(1, num('profesionales'));
      var horasDia = Math.max(1, num('horasDia'));
      var diasMes = Math.max(1, num('diasMes'));
      var minVisita = Math.max(5, num('minVisita'));
      var capacidadCalc = Math.floor((profesionales * horasDia * diasMes * 60) / minVisita);
      getEl('capacidadCalc').value = capacidadCalc;
    }

    ['pctPriv','pctAseg','tarPriv','tarAseg','profesionales','horasDia','diasMes','minVisita'].forEach(id=>{
      getEl(id).addEventListener('input', actualizarCalculos);
    });

    function proyectar() {
  actualizarCalculos();

  var meses = Math.max(6, Math.min(84, num('meses')));
  var capex = num('capex');
  var amortMeses = Math.max(1, num('amortMeses'));
  var amortMensual = capex / amortMeses;

  var srv0 = num('serviciosMes');
  var crecM = num('crecDemanda') / 100;
  var noShowPct = num('noShow') / 100;
  var mktMes = num('mktMes');
  var cpa = Math.max(1, num('cpa'));
  var capacidadMax = num('capacidadCalc');

  var cfBase = num('costesFijos');
  var crecCFyear = num('crecCF') / 100;
  var cVar = num('costeVariable');

  var pctPriv = Math.max(0, num('pctPriv')) / 100;
  var pctAseg = Math.max(0, num('pctAseg')) / 100;
  var mixSum = Math.max(0.01, pctPriv + pctAseg);
  var wPriv = pctPriv / mixSum, wAseg = pctAseg / mixSum;
  var tarPriv = Math.max(0, num('tarPriv'));
  var tarAseg = Math.max(0, num('tarAseg'));
  var ticket = num('ticketMedio');

  var finImporte = Math.min(capex, Math.max(0, num('finImporte')));
  var finInteresAnual = Math.max(0, num('finInteres')) / 100;
  var finPlazo = Math.max(0, num('finPlazo'));
  var finCarencia = Math.max(0, num('finCarencia'));
  var rDeuda = Math.pow(1 + finInteresAnual, 1/12) - 1;

  var tasaDescAnual = Math.max(0, num('tasaDesc')) / 100;
  var rDesc = Math.pow(1 + tasaDescAnual, 1/12) - 1;

  var impEnabled = getEl('toggleImp').checked;
  var dsoEnabled = getEl('toggleDSO').checked;

  var impSoc = impEnabled ? Math.max(0, num('impSoc')) / 100 : 0;
  var dsoAsegDias = dsoEnabled ? Math.max(0, num('dsoAseg')) : 0;
  var delayAsegMeses = Math.round(dsoAsegDias / 30);

  var startDate = parseMonthYYYYMM(getEl('mesInicio').value);
  var mesesArr = [], monthLabels = [];
  for (var i = 0; i < meses; i++) { 
    mesesArr.push(i+1); 
    monthLabels.push(monthLabel(addMonths(startDate, i))); 
  }

// === NUEVO: Config demanda y estacionalidad ===
var cfg = (window.getDemandConfig && window.getDemandConfig()) || { profile:'linear', growPct: crecM, rampMonths:6, saturation:0.6, seasonality: Array(12).fill(1), annualTarget: 0 };
var season = (Array.isArray(cfg.seasonality) && cfg.seasonality.length===12) ? cfg.seasonality : Array(12).fill(1);

// Para modo "objetivo anual": preparamos pesos estacionales (se normalizan despu√©s)
var pesos = new Array(meses).fill(0);
var demandaRaw = new Array(meses).fill(0);
var startMonth = startDate.getMonth();
for (var m = 0; m < meses; m++) {
var seasonFactor = season[(startMonth + m) % 12] || 1;
  // Lift sencillo por marketing (altas = mktMes/cpa sobre la base inicial):
  var lift = (mktMes > 0 && cpa > 0 && srv0 > 0) ? (1 + (mktMes / cpa) / srv0) : 1;

  if (cfg.profile === 'annual_target') {
    // guardamos peso (se reparte m√°s tarde)
    pesos[m] = computeMonthlyDemand(srv0, m, cfg, seasonFactor, lift); // devuelve "peso" relativo
  } else {
    demandaRaw[m] = computeMonthlyDemand(srv0, m, cfg, seasonFactor, lift); // demanda te√≥rica del mes
  }
}
// Si hay objetivo anual, distribuimos por los pesos estacionales
if (cfg.profile === 'annual_target' && cfg.annualTarget > 0) {
  var totalPesos = pesos.reduce((a,b)=>a+b,0) || 1;
  for (var m = 0; m < meses; m++) {
    demandaRaw[m] = cfg.annualTarget * (pesos[m] / totalPesos);
  }
}


  // === NUEVO: par√°metros de colaboradores (ingreso puro con capacidad propia) ===
  var colabCount     = Math.max(0, num('colabCount'));
  var colabAlquiler  = Math.max(0, num('colabAlquiler'));
  var colabSharePct  = Math.max(0, Math.min(100, num('colabShare'))) / 100;
  var colabHorasDia  = Math.max(1, num('colabHorasDia'));
  var colabDiasMes   = Math.max(1, num('colabDiasMes'));
  var colabMinVisita = Math.max(5, num('colabMinVisita'));
  var colabTarifa    = Math.max(0, num('colabTarifa'));
  var colabPacIni    = Math.max(0, num('colabPacientesIni'));
  var colabCrec      = Math.max(0, num('colabCrec')) / 100;

  var capColabUnit  = Math.floor((colabHorasDia * colabDiasMes * 60) / colabMinVisita);
  var capColabTotal = colabCount * capColabUnit;

  var pacientesPlanif = [], pacientesEfectivos = [];
  var ingresos = [], ingresosPriv = [], ingresosAseg = [];
  var ingresosColab = [];            // <‚Äî serie nueva
  var pacientesColabArr = [];        // <‚Äî serie nueva (pacientes atendidos por colaboradores)

  var cVariables = [], cfMensual = [], ebitda = [], amortArr = [], ebit = [];
  var intereses = [], principal = [], impuestos = [];
  var cobrosPriv = [], cobrosAseg = [];
  var flujoNeto = [], flujoAcum = [];

  var saldoDeuda = finImporte;
  var cuotaAmort = 0;
  if (finPlazo > finCarencia && saldoDeuda > 0) {
    cuotaAmort = pmt(rDeuda, Math.max(0, finPlazo - finCarencia), saldoDeuda);
  }

  var colaCobrosAseg = new Array(meses + delayAsegMeses + 5).fill(0);
  var equity0 = -(capex - finImporte);
  var cashflows = [equity0];

  for (var i = 1; i <= meses; i++) {
    // ‚Äî‚Äî‚Äî Demanda propia (con curva + estacionalidad) ‚Äî‚Äî‚Äî
var idx = i - 1; // √≠ndice base 0
var teoricos = Math.max(0, Math.round(demandaRaw[idx]));                 // demanda te√≥rica
var planificados = Math.min(teoricos, capacidadMax);                      // l√≠mite por capacidad
var efectivos = Math.round(planificados * (1 - noShowPct));              // aplica no-show

// Reparto por pagador (igual que antes)


    var efectPriv = efectivos * wPriv;
    var efectAseg = efectivos * wAseg;
    var ingPriv = efectPriv * tarPriv;
    var ingAseg = efectAseg * tarAseg;

    // === Colaboradores: pacientes y facturaci√≥n del mes (capados por su capacidad) ===
    var pacColabMes = Math.min(
      Math.round(colabPacIni * Math.pow(1 + colabCrec, i - 1)),
      capColabTotal
    );
    pacientesColabArr.push(pacColabMes);

    var factColabMes = pacColabMes * colabTarifa;
    var ingresoColabMes = (colabCount * colabAlquiler) + (colabSharePct * factColabMes);
    ingresosColab.push(ingresoColabMes);

    // ‚Äî‚Äî‚Äî Ingresos totales del mes (propios + colaboradores) ‚Äî‚Äî‚Äî
    var ingresosMes = ingPriv + ingAseg + ingresoColabMes;

    // ‚Äî‚Äî‚Äî Estructura de costes propia (los colaboradores no impactan en costes) ‚Äî‚Äî‚Äî
    var cVariablesMes = efectivos * cVar;
    var cfMes = cfBase * Math.pow(1 + crecCFyear, (i - 1) / 12) + mktMes;
    var ebitdaMes = ingresosMes - cVariablesMes - cfMes;
    var amortMes = (i <= amortMeses) ? amortMensual : 0;
    var ebitMes = ebitdaMes - amortMes;

    // ‚Äî‚Äî‚Äî Deuda ‚Äî‚Äî‚Äî
    var interesesMes = 0, principalMes = 0;
    if (i <= finPlazo && saldoDeuda > 1e-6) {
      interesesMes = saldoDeuda * rDeuda;
      if (i <= finCarencia) {
        principalMes = 0;
      } else {
        principalMes = Math.min(saldoDeuda, cuotaAmort - interesesMes);
      }
      saldoDeuda -= principalMes;
    }

    // ‚Äî‚Äî‚Äî Impuestos ‚Äî‚Äî‚Äî
    var ebt = ebitMes - interesesMes;
    var impMes = (ebt > 0) ? (ebt * impSoc) : 0;

    // ‚Äî‚Äî‚Äî Cobros ‚Äî‚Äî‚Äî
    // Tratamos el ingreso de colaboradores como cobro inmediato (privado)
    var cobroPrivMes = ingPriv + ingresoColabMes;
    var cobroAsegMes = colaCobrosAseg[i-1] || 0;
    colaCobrosAseg[i - 1 + delayAsegMeses] += ingAseg;

    var flujoMes = (cobroPrivMes + cobroAsegMes) - cVariablesMes - cfMes - (interesesMes + principalMes) - impMes;
    var acumulado = (i === 1 ? equity0 : flujoAcum[i - 2]) + flujoMes;

    pacientesPlanif.push(planificados);
    pacientesEfectivos.push(efectivos);
    ingresos.push(ingresosMes);
    ingresosPriv.push(ingPriv);
    ingresosAseg.push(ingAseg);
    cVariables.push(cVariablesMes);
    cfMensual.push(cfMes);
    ebitda.push(ebitdaMes);
    amortArr.push(amortMes);
    ebit.push(ebitMes);
    intereses.push(interesesMes);
    impuestos.push(impMes);
    principal.push(principalMes);
    cobrosPriv.push(cobroPrivMes);
    cobrosAseg.push(cobroAsegMes);
    flujoNeto.push(flujoMes);
    flujoAcum.push(acumulado);
    cashflows.push(flujoMes);
  }

  var beIndex = flujoAcum.findIndex(v => v >= 0);
  var beMes = (beIndex >= 0) ? (beIndex + 1) : null;
  var roiFinal = (cashflows.reduce((a, b) => a + b, 0) / Math.abs(equity0 || 1)) * 100;
  var npvVal = npv(rDesc, cashflows);
  var irrM = irrMonthly(cashflows);
  var irrAnual = Math.pow(1 + irrM, 12) - 1;

  var utilizacionFinal = capacidadMax > 0 ? (pacientesEfectivos[pacientesEfectivos.length - 1] / capacidadMax * 100) : 0;

  var pacientesMes1 = pacientesEfectivos[0] || 0;
  var cfMes1 = cfBase + mktMes;
  var amortMes1 = capex / amortMeses;
  var precioMinimo = pacientesMes1 > 0 ? (cfMes1 + (pacientesMes1 * cVar) + amortMes1) / pacientesMes1 : 0;
  var pacientesMinimos = (ticket > cVar) ? Math.ceil((cfMes1 + amortMes1) / (ticket - cVar)) : 0;
  var margenActual = ticket > 0 ? ((ticket - cVar) / ticket * 100) : 0;
  var pacientesFinal = pacientesEfectivos[pacientesEfectivos.length - 1] || 0;

  var estadoRentabilidad = 'NO RENTABLE';
  var analisisTexto = '';

  if (pacientesMinimos > 0) {
    if (pacientesMes1 >= pacientesMinimos) {
      var exceso = ((pacientesMes1 - pacientesMinimos) / pacientesMinimos * 100).toFixed(0);
      analisisTexto = '‚úÖ <strong>Rentable desde el inicio:</strong> Con ' + pacientesMes1 + ' pacientes/mes y ticket de ' + eur(ticket) + ', superas el m√≠nimo (' + pacientesMinimos + ') en ' + exceso + '%. Margen ' + margenActual.toFixed(1) + '%.';
      estadoRentabilidad = 'RENTABLE';
    } else if (beMes) {
      if (pacientesFinal >= pacientesMinimos) {
        analisisTexto = 'üìà <strong>Viable con crecimiento:</strong> Break-even en mes ' + beMes + ' (' + monthLabels[beIndex] + ').';
        estadoRentabilidad = 'VIABLE';
      } else {
        analisisTexto = '‚ö†Ô∏è <strong>Break-even temporal:</strong> Llegas a break-even en mes ' + beMes + ' (' + monthLabels[beIndex] + '), pero el nivel final (' + pacientesFinal + ') no supera el m√≠nimo (' + pacientesMinimos + ').';
        estadoRentabilidad = 'TEMPORAL';
      }
    } else {
      analisisTexto = '‚ö†Ô∏è <strong>No viable:</strong> Con ' + pacientesMes1 + ' pacientes iniciales y ' + pacientesFinal + ' finales, no alcanzas rentabilidad. Sube ticket a ' + eur(precioMinimo) + ' o incrementa demanda.';
      estadoRentabilidad = 'NO RENTABLE';
    }
  } else {
    analisisTexto = '‚ö†Ô∏è <strong>Par√°metros incorrectos:</strong> El ticket efectivo debe ser > coste variable.';
    estadoRentabilidad = 'ERROR';
  }

  function sum(a){ return a.reduce((x,y)=>x+y,0); }
  var totalCobrosPriv = sum(cobrosPriv);
  var totalCobrosAsegEf = sum(cobrosAseg);
  var totalCobrosFactAseg = sum(ingresosAseg);
  var totalVar = sum(cVariables);
  var totalFijos = sum(cfMensual);
  var totalIntereses = sum(intereses);
  var totalPrincipal = sum(principal);
  var totalImpuestos = sum(impuestos);
  var minAcum = Math.min.apply(null, flujoAcum);
  var minIndex = flujoAcum.findIndex(v => v === minAcum);
  var necesidadMaxCaja = Math.min(0, minAcum);
  var mesMinCaja = (minIndex >= 0) ? monthLabels[minIndex] : '-';

  lastData = {
    mesesArr, monthLabels,
    pacientesPlanif, pacientesEfectivos,
    ingresos, ingresosPriv, ingresosAseg, ingresosColab, // <‚Äî a√±adimos serie de colaboradores
    cVariables, cfMensual, ebitda, amortArr, ebit, intereses, impuestos, principal,
    cobrosPriv, cobrosAseg,
    flujoNeto, flujoAcum,
    ticket, capacidadMax, utilizacionFinal,
    beMes, roiFinal, npvVal, irrAnual,
    precioMinimo, pacientesMinimos, margenActual, estadoRentabilidad, analisisTexto,
    totalCobrosPriv, totalCobrosAsegEf, totalCobrosFactAseg, totalVar, totalFijos, 
    totalIntereses, totalPrincipal, totalImpuestos, necesidadMaxCaja, mesMinCaja,
    // info colaboradores para depurar/usar despu√©s
    pacientesColabArr, capColabTotal,
	demandaTeorica: demandaRaw,
  	seasonalityUsed: season.slice(0),
  	demandaPerfil: cfg.profile

  };
}

    function simularConParametros(cambios) {
      var original = {};
      Object.keys(cambios).forEach(function(fieldId) {
        var el = getEl(fieldId);
        if (el) { original[fieldId] = el.value; el.value = cambios[fieldId]; }
      });
      actualizarCalculos(); 
      proyectar();
      var res = { roiFinal: lastData.roiFinal, ebitdaFinal: lastData.ebitda[lastData.ebitda.length - 1] || 0 };
      Object.keys(original).forEach(function(fieldId) { getEl(fieldId).value = original[fieldId]; });
      actualizarCalculos(); 
      proyectar();
      return res;
    }

    function calcularSensibilidad() {
      if (!lastData) return null;
      var baseROI = lastData.roiFinal;
      var vars = [
        { label: 'Tarifa Efectiva', field: 'ticketMedio',  variation: 0.20 },
        { label: 'Pacientes',       field: 'serviciosMes', variation: 0.20 },
        { label: 'Crecimiento',     field: 'crecDemanda',  variation: 0.30 },
        { label: 'Costes Fijos',    field: 'costesFijos',  variation: 0.20 },
        { label: 'No-show %',       field: 'noShow',       variation: 0.50 },
        { label: 'Marketing',       field: 'mktMes',       variation: 0.30 },
        { label: 'Coste Variable',  field: 'costeVariable',variation: 0.30 }
      ];
      
      function impactFor(field, variation, sign) {
        if (field === 'ticketMedio') {
          const ticketActual = num('ticketMedio') || 1;
          const factor = (ticketActual * (1 + sign * variation)) / ticketActual;
          return simularConParametros({
            'tarPriv': num('tarPriv') * factor,
            'tarAseg': num('tarAseg') * factor
          }).roiFinal - baseROI;
        } else {
          const base = num(field);
          return simularConParametros({ [field]: base * (1 + sign * variation) }).roiFinal - baseROI;
        }
      }
      
      var impacts = vars.map(v => {
        const plus  = impactFor(v.field, v.variation, +1);
        const minus = impactFor(v.field, v.variation, -1);
        return { name: v.label, positive: plus, negative: minus, total: Math.abs(plus) + Math.abs(minus), variation: v.variation };
      });
      
      impacts.sort((a,b) => b.total - a.total);
      return impacts;
    }

    function renderTornadoChart() {
      var impacts = calcularSensibilidad();
      if (!impacts) return;
      var ctx = getEl('tornadoChart');
      if (charts.tornado) charts.tornado.destroy();
      
      charts.tornado = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: impacts.map(i => i.name),
          datasets: [
            { label: 'Impacto Negativo', data: impacts.map(i => i.negative), backgroundColor: '#ef4444', borderRadius: 4 },
            { label: 'Impacto Positivo', data: impacts.map(i => i.positive), backgroundColor: '#22c55e', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: 'y',
          plugins: {
            legend: { display: true },
            title: { display: true, text: 'Cambio en ROI final (p.p.)' },
            tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + ' p.p.' } }
          },
          scales: { x: { beginAtZero: true, ticks: { callback: (v) => v.toFixed(1) + ' p.p.' } } }
        }
      });
      
      getEl('roiBaseLabel').textContent = lastData.roiFinal.toFixed(1) + '%';
    }

    function initSimulator() {
      getEl('simTarifa').value = num('ticketMedio');
      getEl('simPacientes').value = num('serviciosMes');
      getEl('simCrecimiento').value = num('crecDemanda');
      getEl('simCostesFijos').value = num('costesFijos');
      updateSimulatorValues();
      
      ['simTarifa','simPacientes','simCrecimiento','simCostesFijos'].forEach(id=>{
        getEl(id).addEventListener('input', function(){ updateSimulatorValues(); simulateROI(); });
      });
      
      simulateROI();
    }

    function updateSimulatorValues() {
      getEl('simTarifaValue').textContent = eur(getEl('simTarifa').value);
      getEl('simPacientesValue').textContent = getEl('simPacientes').value;
      getEl('simCrecimientoValue').textContent = getEl('simCrecimiento').value + '%';
      getEl('simCostesFijosValue').textContent = eur(getEl('simCostesFijos').value);
    }

    function simulateROI() {
      if (!lastData) return;
      var tarifaSimulada = Number(getEl('simTarifa').value);
      var pacientesSimulados = Number(getEl('simPacientes').value);
      var crecimientoSimulado = Number(getEl('simCrecimiento').value);
      var costesSimulados = Number(getEl('simCostesFijos').value);
      var ticketActual = num('ticketMedio') || 1;
      var factorTarifa = tarifaSimulada / ticketActual;
      
      var res = simularConParametros({
        'tarPriv': num('tarPriv') * factorTarifa,
        'tarAseg': num('tarAseg') * factorTarifa,
        'serviciosMes': pacientesSimulados,
        'crecDemanda': crecimientoSimulado,
        'costesFijos': costesSimulados
      });
      
      getEl('simROI').textContent = res.roiFinal.toFixed(1) + '%';
      getEl('simROI').style.color = res.roiFinal > 100 ? '#22c55e' : (res.roiFinal > 50 ? '#f59e0b' : '#ef4444');
      getEl('simEBITDA').textContent = eur(res.ebitdaFinal);
      getEl('simEBITDA').style.color = res.ebitdaFinal > 0 ? '#059669' : '#ef4444';
    }

    function render() {
      if (!lastData) return;
      var d = lastData;
      var totalMeses = d.mesesArr.length;

      getEl('kpiBreakeven').textContent = d.beMes ? ('Mes ' + d.beMes + ' / ' + totalMeses) : 'No alcanzado';
      getEl('kpiROI').textContent = isFinite(d.roiFinal) ? d.roiFinal.toFixed(1) + '%' : '‚Äî';
      getEl('kpiNPV').textContent = eur(d.npvVal);
      getEl('kpiIRR').textContent = isFinite(d.irrAnual) ? (d.irrAnual * 100).toFixed(1) + '%' : '‚Äî';

      getEl('precioMinimo').textContent = eur(d.precioMinimo);
      getEl('pacientesMinimos').textContent = d.pacientesMinimos.toLocaleString('es-ES');
      getEl('margenActual').textContent = d.margenActual.toFixed(1) + '%';
      getEl('zonaRentabilidad').textContent = d.estadoRentabilidad;
      getEl('zonaRentabilidad').style.color = d.estadoRentabilidad === 'RENTABLE' ? '#059669' : 
        (d.estadoRentabilidad === 'VIABLE' || d.estadoRentabilidad === 'TEMPORAL') ? '#d97706' : '#dc2626';
      getEl('analisisViabilidad').innerHTML = d.analisisTexto;

      var statusDot = getEl('statusDot');
      var statusText = getEl('statusText');
      if (d.beMes) {
        statusText.textContent = 'Proyecto viable - Break-even mes ' + d.beMes;
        statusDot.className = 'status-dot success';
      } else if (d.roiFinal > 0) {
        statusText.textContent = 'Proyecto con retorno positivo';
        statusDot.className = 'status-dot warning';
      } else {
        statusText.textContent = 'Proyecto no viable';
        statusDot.className = 'status-dot danger';
      }

      var tbody = document.querySelector('#tabla tbody');
      tbody.innerHTML = '';
      d.mesesArr.forEach(function(m, i) {
        var tr = document.createElement('tr');
        var cells = [
  d.monthLabels[i],                                        // 0
  d.pacientesPlanif[i].toLocaleString('es-ES'),            // 1
  d.pacientesEfectivos[i].toLocaleString('es-ES'),         // 2
  eur(d.ingresos[i]),                                      // 3 (totales)
  eur(d.ingresosColab?.[i] || 0),                          // 4 (NUEVO: colaboradores)
  eur(d.cVariables[i]),                                    // 5
  eur(d.cfMensual[i]),                                     // 6
  eur(d.ebitda[i]),                                        // 7
  eur(d.amortArr[i]),                                      // 8
  eur(d.ebit[i]),                                          // 9
  eur(d.intereses[i]),                                     // 10
  eur(d.impuestos[i]),                                     // 11
  eur(d.principal[i]),                                     // 12
  eur(d.flujoNeto[i]),                                     // 13
  eur(d.flujoAcum[i])                                      // 14
];

cells.forEach(function(txt, idx) {
  var td = document.createElement('td');
  td.textContent = txt;
  // actualizar √≠ndices por la nueva columna
  if (idx === 7) td.className = d.ebitda[i] >= 0 ? 'table-success' : 'table-danger';
  else if (idx === 13) td.className = d.flujoNeto[i] >= 0 ? 'table-success' : 'table-danger';
  else if (idx === 14) td.className = d.flujoAcum[i] >= 0 ? 'table-success' : 'table-danger';
  tr.appendChild(td);
});
        tbody.appendChild(tr);
      });

      if (charts.pnl) charts.pnl.destroy();
      charts.pnl = new Chart(getEl('chartPnl'), {
        type: 'line',
        data: {
          labels: d.monthLabels,
          datasets: [
            { label: 'Ingresos', data: d.ingresos, borderColor: '#059669', backgroundColor: 'rgba(5,150,105,0.1)', fill: true, tension: 0.4 },
            { label: 'Costes Totales', data: d.cVariables.map((v, i) => v + d.cfMensual[i]), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.1)', fill: true, tension: 0.4 },
            { label: 'EBITDA', data: d.ebitda, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, 
          plugins: { legend: { display: true } },
          scales: { y: { ticks: { callback: v => eur(v) } } }
        }
      });

      if (charts.cash) charts.cash.destroy();
      charts.cash = new Chart(getEl('chartCash'), {
        type: 'line',
        data: {
          labels: d.monthLabels,
          datasets: [
            { label: 'Flujo Acumulado', data: d.flujoAcum, borderColor: '#9333ea', backgroundColor: 'rgba(147,51,234,0.08)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { ticks: { callback: v => eur(v) } } }
        }
      });

      const cashSummary = getEl('cashSummary');
      cashSummary.innerHTML = '';
      function card(title, value, note='') {
        const div = document.createElement('div');
        div.className = 'summary-card';
        div.innerHTML = `<div class="summary-title">${title}</div>
                         <div class="summary-value">${value}</div>
                         ${note ? `<div class="summary-muted">${note}</div>` : ''}`;
        cashSummary.appendChild(div);
      }
      card('Cobros Privado', eur(d.totalCobrosPriv));
      card('Cobros Aseguradora', eur(d.totalCobrosAsegEf));
      card('Pagos Variables', eur(d.totalVar));
      card('Pagos Fijos', eur(d.totalFijos));
      card('Necesidad m√°x. caja', eur(d.necesidadMaxCaja), 'Mes: ' + d.mesMinCaja);

      setTimeout(function(){ renderTornadoChart(); initSimulator(); }, 100); renderDetalleCompleto(); // ‚Üê para rellenar el card cada vez que pintas

    }

function renderDetalleCompleto(){
  if(!lastData) return;
  const d = lastData;

  // Supuestos
  const finImporte   = num('finImporte');
  const finInteres   = num('finInteres');
  const finPlazo     = num('finPlazo');
  const finCarencia  = num('finCarencia');
  const dsoDias      = getEl('toggleDSO').checked ? num('dsoAseg') : 0;
  const impSocTxt    = getEl('toggleImp').checked ? (num('impSoc').toFixed(1) + '%') : '‚Äî';

  (getEl('supCapex')||{}).textContent        = eur(num('capex'));
  (getEl('supMeses')||{}).textContent        = d.mesesArr.length;
  (getEl('supFinanciacion')||{}).textContent = finImporte>0 ? `${eur(finImporte)} ¬∑ ${finInteres.toFixed(1)}% ¬∑ ${finPlazo}m${finCarencia?` ¬∑ ${finCarencia}m carencia`:''}` : 'Sin financiaci√≥n';
  (getEl('supDSO')||{}).textContent          = dsoDias ? `${dsoDias} d√≠as` : 'No aplica';
  (getEl('supImp')||{}).textContent          = impSocTxt;

  // Tabla (12 meses)
  const n = Math.min(12, d.mesesArr.length);
  let html = `
    <table class="table" style="width:100%; border-collapse:collapse; font-size:.85rem; margin-top:.5rem;">
      <thead>
        <tr>
          <th>Mes</th><th>Efectivos</th><th>Ingresos</th><th>EBITDA</th><th>Flujo</th><th>Acum.</th>
        </tr>
      </thead>
      <tbody>
  `;
  for(let i=0;i<n;i++){
    html += `
      <tr>
        <td>${d.monthLabels[i]}</td>
        <td style="text-align:right">${d.pacientesEfectivos[i].toLocaleString('es-ES')}</td>
        <td style="text-align:right">${eur(d.ingresos[i])}</td>
        <td style="text-align:right; ${d.ebitda[i]>=0?'color:#059669':'color:#dc2626'}">${eur(d.ebitda[i])}</td>
        <td style="text-align:right; ${d.flujoNeto[i]>=0?'color:#059669':'color:#dc2626'}">${eur(d.flujoNeto[i])}</td>
        <td style="text-align:right; ${d.flujoAcum[i]>=0?'color:#059669':'color:#dc2626'}"><strong>${eur(d.flujoAcum[i])}</strong></td>
      </tr>
    `;
  }
  html += `</tbody></table>`;
  const wrap = getEl('tablaDetalle');
  if (wrap) wrap.innerHTML = html;
}


    /* ===================== TAB SWITCHING ===================== */
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      const tabs = ['financial', 'competitors', 'market', 'reports'];
      const index = tabs.indexOf(tabName);
      if (index >= 0) {
        document.querySelectorAll('.tab')[index].classList.add('active');
        getEl(tabName + '-tab').classList.add('active');
      }
    }

    /* ===================== COMPETITORS ===================== */
/* ========== AN√ÅLISIS DE COMPETIDORES (ACTUALIZADO) ========== */

var competitorsData = [];

function addCompetitor() {
  const url = getEl('competitorUrl').value.trim();
  const precios = getEl('competitorPrecios').value.trim();
  if (!url) { alert('Introduce una URL v√°lida'); return; }

  if (competitors.find(c => c.url === url)) {
    alert('Este competidor ya est√° a√±adido'); return;
  }

  competitors.push({ url, precios, status: 'pending', data: null });
  getEl('competitorUrl').value = '';
  getEl('competitorPrecios').value = '';
  getEl('analyzeBtn').disabled = false;
  updateCompetitorCount();
  renderCompetitors();
}

function removeCompetitor(index) {
  competitors.splice(index, 1);
  competitorsData.splice(index, 1);
  getEl('analyzeBtn').disabled = competitors.length === 0;
  updateCompetitorCount();
  renderCompetitors();
}

function renderCompetitors() {
  const list = getEl('competitorList');
  if (competitors.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay competidores a√±adidos</p>';
    return;
  }

  list.innerHTML = competitors.map((c, i) => `
    <div class="competitor-item" style="align-items: flex-start;">
      <div style="flex: 1;">
        <div class="competitor-url">${c.url}</div>
        ${c.data ? `
          <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
            <strong>${c.data.titulo || ''}</strong><br>
            ${c.data.servicios?.length ? 'Servicios: ' + c.data.servicios.slice(0, 4).join(', ') : ''}
            ${c.data.preciosVisibles ? ` | Precios: ‚Ç¨${c.data.preciosVisibles.min}-${c.data.preciosVisibles.max}` : ''}

          </div>
        ` : ''}
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span class="status status-${c.status}">
          ${c.status === 'pending' ? 'Pendiente' :
            c.status === 'analyzing' ? 'Analizando...' :
            c.status === 'success' ? 'Analizado' : 'Error'}
        </span>
        <button onclick="removeCompetitor(${i})" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Eliminar</button>
      </div>
    </div>
  `).join('');
}

function updateCompetitorCount() {
  getEl('competitorCount').textContent = competitors.length + ' a√±adidos';
}

function loadSampleCompetitors() {
  const provincia = getEl('provincia')?.value || 'Valencia';
  const samples = {
    'Valencia': [
      'https://www.imed.es',
      'https://www.quironsalud.es/valencia',
      'https://www.vithas.es/hospital-vithas-valencia'
    ],
    'Alicante': [
      'https://www.imed.es/centros/imed-elche',
      'https://www.quironsalud.es/alicante',
      'https://www.vithas.es/hospital-vithas-medimar'
    ],
    'Madrid': [
      'https://www.quironsalud.es/madrid',
      'https://www.sanchinarro.com',
      'https://www.cun.es'
    ]
  };

  const urls = samples[provincia] || samples['Valencia'];
  competitors = urls.map(url => ({ url, status: 'pending', data: null }));
  getEl('analyzeBtn').disabled = false;
  updateCompetitorCount();
  renderCompetitors();
}

async function analyzeCompetitors() {
  if (!competitors.length) { alert('A√±ade al menos un competidor'); return; }

  const btn = getEl('analyzeBtn');
  btn.disabled = true;
  btn.textContent = 'Analizando ' + competitors.length + ' competidores...';

  competitorsData = [];

  // Fase 1: scraping
  for (let i = 0; i < competitors.length; i++) {
    competitors[i].status = 'analyzing';
    renderCompetitors();

    try {
      const res = await fetch('/api/scrape-competitor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: competitors[i].url })
      });
      const data = await res.json();

      if (data.status === 'success') {
        competitors[i].status = 'success';
        competitors[i].data = data;
        competitorsData.push(data);
      } else {
        competitors[i].status = 'error';
        console.error('Error scraping:', data.error);
      }
    } catch (err) {
      competitors[i].status = 'error';
      console.error('Error:', err);
    }

    renderCompetitors();
  }

  // Fase 2: an√°lisis IA
  if (competitorsData.length) {
    btn.textContent = 'Generando insights con IA...';
    try {
      const contexto = {
        provincia: getEl('provincia')?.value || 'Madrid',
        especialidad: getEl('especialidadScraper')?.value || 'general',
        estrategia: getEl('estrategiaTipo')?.value || 'premium',
        ubicacion: getEl('ubicacionTipo')?.value || 'centro'
      };

      const res = await fetch('/api/analyze-competitors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ competitors: competitorsData, contexto })
      });

      const analysis = await res.json();
compAnalysis = analysis && !analysis.error ? analysis : null;   // <- guarda para el Informe Integral
if (analysis.error) console.warn('Usando an√°lisis base:', analysis.error);

renderAnalysisResults(analysis);
getEl('competitorResults').style.display = 'block';
setTimeout(() => getEl('competitorResults').scrollIntoView({ behavior: 'smooth', block: 'start' }), 300);

    } catch (err) {
      console.error('Error en an√°lisis:', err);
      alert('Error al generar an√°lisis: ' + err.message);
    }
  } else {
    alert('No se pudo analizar ning√∫n competidor. Verifica las URLs.');
  }

  btn.disabled = false;
  btn.textContent = 'Analizar Competidores';
}

function renderAnalysisResults(analysis) {
  const precios = analysis.rangoPrecios || {};
  const digital = analysis.presenciaDigital || {};

  // defensivo para la ‚Äúbolita‚Äù del rango (evitar NaN/Infinity)
  const min = Number(precios.minimo ?? 60);
  const max = Number(precios.maximo ?? 150);
  const avg = Number(precios.promedio ?? 95);
  const pct = max > min ? Math.max(0, Math.min(100, ((avg - min) / (max - min)) * 100)) : 50;

  getEl('executiveSummary').innerHTML = `
    <p style="font-size: 1rem; line-height: 1.6;">${analysis.resumenEjecutivo || 'An√°lisis completado'}</p>

    <div class="kpi-grid" style="margin-top: 1.5rem;">
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">‚Ç¨${avg || '‚Äî'}</div>
        <div class="kpi-label">Precio Promedio</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">${competitorsData.length}</div>
        <div class="kpi-label">Competidores Analizados</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">${digital.nivel || 'Medio'}</div>
        <div class="kpi-label">Nivel Digital</div>
      </div>
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Rango de Precios</h4>
    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span>M√≠nimo: <strong>‚Ç¨${min}</strong></span>
        <span>M√°ximo: <strong>‚Ç¨${max}</strong></span>
      </div>
      <div style="height: 8px; background: linear-gradient(90deg, #ef4444 0%, #eab308 50%, #22c55e 100%); border-radius: 4px; position: relative;">
        <div style="position: absolute; top: -4px; left: ${pct}%; width: 16px; height: 16px; background: #2563eb; border: 2px solid white; border-radius: 50%;"></div>
      </div>
      <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-muted);">${precios.posicionamiento || ''}</p>
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Servicios Comunes</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      ${(analysis.serviciosComunes || []).map(s =>
        `<span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">${s}</span>`
      ).join('')}
    </div>
  `;

  getEl('marketAnalysis').innerHTML = `
    <h4 style="margin: 0 0 0.75rem; font-size: 1rem; color: var(--primary);">Presencia Digital</h4>
    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
      <p><strong>Nivel:</strong> ${digital.nivel || 'Medio'}</p>
      <p style="margin: 0.5rem 0;">${digital.analisis || ''}</p>
      ${digital.redesMasUsadas?.length ? `
        <p style="margin-top: 0.5rem;"><strong>Redes m√°s usadas:</strong> ${digital.redesMasUsadas.join(', ')}</p>
      ` : ''}
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #059669;">Fortalezas de Competidores</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.fortalezasCompetidores || []).map(f => `<li>${f}</li>`).join('')}
    </ul>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #dc2626;">Debilidades Detectadas</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.debilidadesCompetidores || []).map(d => `<li>${d}</li>`).join('')}
    </ul>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #2563eb;">Oportunidades Identificadas</h4>
    ${(analysis.oportunidades || []).map(op => `
      <div style="background: ${op.impacto === 'alto' ? '#dbeafe' : '#fef3c7'}; border-left: 4px solid ${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <strong style="color: ${op.impacto === 'alto' ? '#1e40af' : '#92400e'};">${op.gap}</strong>
          <span style="background: ${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${op.impacto === 'alto' ? 'Alto impacto' : 'Medio impacto'}</span>
        </div>
        <p style="margin: 0.5rem 0 0; color: #475569;">${op.accion}</p>
      </div>
    `).join('')}

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Posicionamiento Recomendado</h4>
    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #059669; padding: 1.5rem; border-radius: 12px;">
      <p style="margin: 0; line-height: 1.6; font-size: 1rem;">${analysis.posicionamientoRecomendado || ''}</p>
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--danger);">Amenazas del Mercado</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.amenazas || []).map(a => `<li>${a}</li>`).join('')}
    </ul>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">KPIs Comparativos</h4>
    <table class="table" style="margin-top: 0.5rem;">
      <thead>
        <tr><th>M√©trica</th><th>Competidores</th><th>Recomendado</th></tr>
      </thead>
      <tbody>
        ${(analysis.kpisComparativos || []).map(kpi => `
          <tr>
            <td><strong>${kpi.metrica}</strong></td>
            <td>${kpi.competidores}</td>
            <td style="color: var(--success); font-weight: 600;">${kpi.recomendado}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// Enter en el input para a√±adir competidor
document.addEventListener('DOMContentLoaded', function() {
  const urlInput = getEl('competitorUrl');
  if (urlInput) {
    urlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addCompetitor(); }
    });
  }
});
/* =================== FIN COMPETITORS =================== */

/* =================== ESTRATEGIA MERCADO =================== */

async function generateStrategy() {
  const out = document.getElementById('strategyOutput');
  out.style.display = 'block';
  out.innerHTML = `
    <div class="analysis-card" style="background:#f0f9ff;">
      <h3 class="analysis-title">üîç Paso 1/3: Obteniendo datos de mercado...</h3>
      <p>Scrapeando precios de Doctoralia...</p>
    </div>
  `;

  try {
    const tipo = document.getElementById('estrategiaTipo')?.value || 'premium';
    const ubicacion = document.getElementById('ubicacionTipo')?.value || 'centro';
    const provincia = (document.getElementById('provincia')?.value) || document.getElementById('provinciaActual')?.textContent || 'Madrid';
    const especialidad = document.getElementById('especialidadScraper')?.value || '';


    // ======= PASO 1: SCRAPING DE DOCTORALIA =======
    console.log('[1/3] Iniciando scraping de Doctoralia...');
    
    const scrapingRes = await fetch('/api/scrape-doctoralia', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        provincia,
        especialidad,
        adminPassword: prompt('Contrase√±a admin (necesaria para scraping):') || ''
      })
    });

    let datosMercado = {
      rangoConsulta: '‚Ç¨90-180',
      mixPrivado: '62%',
      crecimiento: '12%',
      dso: '50 d√≠as'
    };

    if (scrapingRes.ok) {
      const scrapingData = await scrapingRes.json();
      console.log('[1/3] Scraping exitoso:', scrapingData);
      
      if (scrapingData.consulta) {
        datosMercado.rangoConsulta = scrapingData.consulta;
      }
      if (scrapingData.mixPrivado) {
        datosMercado.mixPrivado = scrapingData.mixPrivado;
      }
      if (scrapingData.crecimiento) {
        datosMercado.crecimiento = scrapingData.crecimiento;
      }
      if (scrapingData.dso) {
        datosMercado.dso = scrapingData.dso;
      }

      out.innerHTML = `
        <div class="analysis-card" style="background:#d1fae5;">
          <h3 class="analysis-title">‚úÖ Paso 1/3 completado</h3>
          <p><strong>Datos de mercado actualizados:</strong></p>
          <ul>
            <li>Rango consulta: ${datosMercado.rangoConsulta}</li>
            <li>Mix privado: ${datosMercado.mixPrivado}</li>
            <li>Muestras: ${scrapingData.muestras || 'N/A'}</li>
          </ul>
          <p>ü§ñ Paso 2/3: Generando estrategia con IA...</p>
        </div>
      `;
    } else {
      console.warn('[1/3] Scraping fall√≥, usando datos por defecto');
      out.innerHTML = `
        <div class="analysis-card" style="background:#fef3c7;">
          <h3 class="analysis-title">‚ö†Ô∏è Usando datos estimados</h3>
          <p>No se pudo obtener datos de Doctoralia. Generando estrategia con datos de referencia...</p>
        </div>
      `;
    }

    const ticketMedio = Number(document.getElementById('ticketMedio')?.value || 120);
    const pacientes = Number(document.getElementById('serviciosMes')?.value || 180);
    const costesFijos = Number(document.getElementById('costesFijos')?.value || 12000);
    const margenPct = Number((document.getElementById('margenActual')?.textContent || '65').toString().replace('%','')) || 65;

    console.log('[2/3] Generando estrategia con IA...');
    
    const payload = {
      tipo,
      ubicacion,
      provincia,
      mercado: datosMercado,
      finanzas: { ticketMedio, pacientes, costesFijos, margenPct }
    };

    console.log('[2/3] Payload para IA:', payload);

    const res = await fetch('/api/strategy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const raw = await res.text();
    console.log('[2/3] Respuesta de IA:', raw);

    if (!res.ok) throw new Error(`HTTP ${res.status}: ${raw}`);

    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      throw new Error('La respuesta no es JSON v√°lido: ' + e.message);
    }

    console.log('[3/3] Estrategia generada exitosamente');
    renderStrategyFromAPI(data, { tipo, ubicacion });

  } catch (err) {
    console.error('Error:', err);
    out.innerHTML = `
      <div class="analysis-card" style="background:#fff0f0; border:1px solid #fecaca;">
        <h3 class="analysis-title" style="color:#dc2626;">Error al generar estrategia</h3>
        <p>${err.message}</p>
        <pre style="white-space:pre-wrap; font-size:.85rem; color:#7f1d1d; margin-top:.75rem">${String(err)}</pre>
      </div>
    `;
  }
}

// ========== FUNCIONES AUXILIARES PARA RENDERIZADO ==========

function li(items) {
  if (!items || !items.length) return '<p class="summary-muted">‚Äî</p>';
  return `<ul style="margin:.25rem 0 .25rem .75rem">${items.map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

function rowsKPIs(kpis) {
  if (!Array.isArray(kpis) || !kpis.length) return '<p class="summary-muted">‚Äî</p>';
  return `
    <table class="table" style="margin-top:.5rem">
      <thead><tr><th>KPI</th><th>Objetivo</th></tr></thead>
      <tbody>
        ${kpis.map(k=>`<tr><td>${k.nombre||'-'}</td><td>${k.objetivo||'-'}</td></tr>`).join('')}
      </tbody>
    </table>`;
}

function listCanales(canales) {
  if (!Array.isArray(canales) || !canales.length) return '<p class="summary-muted">‚Äî</p>';
  return canales.map(c => `
    <div class="summary-card">
      <div class="summary-title">${c.canal||'-'} <span class="summary-muted">${c.presupuestoPct?`(${c.presupuestoPct}% presupuesto)`:''}</span></div>
      <div class="summary-muted"><strong>Objetivo:</strong> ${c.objetivo || '-'}</div>
      ${li(c.mensajes || [])}
    </div>
  `).join('');
}

function listPlan(plan) {
  if (!Array.isArray(plan) || !plan.length) return '<p class="summary-muted">‚Äî</p>';
  return plan.map(f => `
    <div class="summary-card">
      <div class="summary-title">D√≠as ${f.fase||'-'}</div>
      ${li(f.acciones || [])}
    </div>
  `).join('');
}

function listCalendario(c) {
  if (!Array.isArray(c) || !c.length) return '<p class="summary-muted">‚Äî</p>';
  return c.map(m => `
    <div class="summary-card">
      <div class="summary-title">${m.mes||'-'}</div>
      ${li(m.ideas || [])}
    </div>
  `).join('');
}

function renderStrategyFromAPI(s, ctx) {
  const presupuestoPct = (typeof s.presupuestoSugeridoPctIngresos === 'string')
    ? s.presupuestoSugeridoPctIngresos.replace('%','')
    : (s.presupuestoSugeridoPctIngresos ?? '');

  const personasList = Array.isArray(s.personas) ? s.personas.map(p =>
    `<li><strong>${p.nombre||'-'}:</strong> dolores: ${p.dolor||'-'}. motivadores: ${p.motivadores||'-'}</li>`
  ).join('') : '';

  const out = document.getElementById('strategyOutput');
  out.innerHTML = `
    <div class="analysis-card" style="background:#eef6ff;border:1px solid #cfe3ff">
      <h3 class="analysis-title">${s.titulo || 'Estrategia Recomendada'}</h3>
      <p><strong>Enfoque:</strong> ${capitalize(ctx.tipo)} ¬∑ <strong>Ubicaci√≥n:</strong> ${capitalize(ctx.ubicacion)}</p>
      ${s.resumen ? `<p style="margin:.5rem 0 1rem">${s.resumen}</p>` : ''}

      <div class="summary-grid" style="margin-top:.5rem">
        <div class="summary-card">
          <div class="summary-title">Precio objetivo</div>
          <div class="summary-value">${s.precioObjetivo || s.precio || '‚Äî'}</div>
        </div>
        <div class="summary-card">
          <div class="summary-title">% Marketing / Ingresos</div>
          <div class="summary-value">${presupuestoPct ? presupuestoPct+'%' : '‚Äî'}</div>
        </div>
      </div>

      <h4 class="section-title">Propuesta de valor</h4>
      ${li(s.propuestaValor)}

      <h4 class="section-title">Personas objetivo</h4>
      ${personasList ? `<ul style="margin:.25rem 0 .25rem .75rem">${personasList}</ul>` : '<p class="summary-muted">‚Äî</p>'}

      <h4 class="section-title">Posicionamiento</h4>
      <p>${s.posicionamiento || '‚Äî'}</p>

      <h4 class="section-title">Mix de canales (presupuesto ~100%)</h4>
      <div class="summary-grid">${listCanales(s.mixCanales || s.canales)}</div>

      <h4 class="section-title">Plan 90 d√≠as</h4>
      <div class="summary-grid">${listPlan(s.plan90dias)}</div>

      <h4 class="section-title">Calendario de contenidos</h4>
      <div class="summary-grid">${listCalendario(s.calendarioContenido)}</div>

      <h4 class="section-title">KPIs</h4>
      ${rowsKPIs(s.kpis)}

      <h4 class="section-title">Riesgos</h4>
      ${li(s.riesgos)}

      <h4 class="section-title">Alianzas</h4>
      ${li(s.alianzas)}

      ${s.notas ? `<div class="summary-muted" style="margin-top:1rem">${s.notas}</div>` : ''}
    </div>
  `;
}

function capitalize(s) { 
  return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); 
}

function getFallbackStrategyHTML(ctx) {
  return `
    <div class="summary-card">
      <p>Estrategia base para: <strong>${ctx.tipo}</strong> en ubicaci√≥n <strong>${ctx.ubicacion}</strong></p>
      <p class="summary-muted">Los datos de mercado no est√°n disponibles. Configure las variables de entorno en Vercel.</p>
    </div>
  `;
}

/* ===================== IA RESUMEN Y EXPLICACIONES ===================== */

function percent(n){ return (Number(n)||0).toFixed(1) + '%'; }
function posNeg(n){ return n >= 0 ? 'positivo' : 'negativo'; }

function textoBreakeven(d){
  if (!d.beMes) return 'No se alcanza el punto de equilibrio (break-even) en el horizonte modelado.';
  return `Se alcanza el punto de equilibrio en el mes ${d.beMes} (${d.monthLabels[d.beMes-1]}).`;
}

function textoROI(d){
  if (!isFinite(d.roiFinal)) return 'El ROI no es calculable con los par√°metros actuales.';
  const tono = d.roiFinal >= 150 ? 'alto' : (d.roiFinal >= 70 ? 'medio' : 'bajo');
  return `ROI proyectado: ${d.roiFinal.toFixed(1)}% (${tono}).`;
}

function textoNPV(d){
  const signo = d.npvVal >= 0 ? 'positivo' : 'negativo';
  return `VAN (valor actual neto) ${signo}: ${eur(d.npvVal)} (descuento anual aplicado).`;
}

function textoIRR(d){
  if (!isFinite(d.irrAnual)) return 'TIR no disponible con estos flujos.';
  return `TIR anual estimada: ${(d.irrAnual*100).toFixed(1)}%.`;
}

function explicacionBreveConceptos(){
  return `
  <ul style="margin:0 0 0 1rem; padding-left:1rem; line-height:1.7;">
    <li><strong>Break-even (punto de equilibrio):</strong> Momento en el que <em>lo que entra</em> (cobros) iguala <em>lo que sale</em> (pagos). A partir de ah√≠, el proyecto ya no ‚Äúcome‚Äù caja.</li>
    <li><strong>ROI:</strong> Porcentaje de retorno sobre la inversi√≥n inicial. Si inviertes 100 y recuperas 250, el ROI es 150%.</li>
    <li><strong>VAN (NPV):</strong> Traduce todos los cobros/pagos futuros a dinero de hoy. <em>Positivo</em> suele indicar proyecto interesante.</li>
    <li><strong>TIR (IRR):</strong> ‚ÄúInter√©s‚Äù anual impl√≠cito del proyecto. √ötil para comparar con otras opciones (p. ej., coste de financiaci√≥n).</li>
    <li><strong>EBITDA:</strong> Resultado operativo antes de amortizaciones e intereses. Se√±al de ‚Äúm√∫sculo‚Äù del negocio en el d√≠a a d√≠a.</li>
    <li><strong>Coste fijo vs variable:</strong> Fijo (alquiler, sueldos base) no cambia con pacientes; variable (material por paciente) s√≠.</li>
    <li><strong>No-show:</strong> Citas que no acuden. Sube la capacidad o baja ingresos si no se gestiona.</li>
    <li><strong>DSO (aseguradoras):</strong> D√≠as que tardan en pagar. Afecta a la caja, no tanto al resultado.</li>
    <li><strong>Carencia y amortizaci√≥n:</strong> Periodo pagando solo intereses (carencia) y reparto del CAPEX en el tiempo (amortizaci√≥n contable).</li>
  </ul>`;
}

function topPalancas(d){
  // Usa tu an√°lisis de sensibilidad para detectar 3 palancas principales
  const impacts = calcularSensibilidad() || [];
  const top3 = impacts.slice(0,3);
  const bullets = top3.map(i=>{
    const mejor = (i.positive>=0?'+':'') + i.positive.toFixed(1);
    const peor  = (i.negative>=0?'+':'') + i.negative.toFixed(1);
    return `<li><strong>${i.name}:</strong> +${i.variation? (i.variation*100):20}% ‚Üí ${mejor} p.p. ROI | -${i.variation? (i.variation*100):20}% ‚Üí ${peor} p.p. ROI.</li>`;
  }).join('');

  let recs = [];
  if (impacts.find(v=>v.name.includes('Tarifa'))) recs.push('Revisar tarifas (pack de servicios, premiumizaci√≥n, diferenciar por complejidad).');
  if (impacts.find(v=>v.name.includes('Pacientes'))) recs.push('Plan comercial/marketing para elevar primeras visitas y fidelizaci√≥n.');
  if (impacts.find(v=>v.name.includes('Costes Fijos'))) recs.push('Negociar alquiler/servicios y ajustar estructura hasta alcanzar tracci√≥n.');
  if (impacts.find(v=>v.name.includes('No-show'))) recs.push('Recordatorios, prepago de se√±al, overbooking prudente en horas pico.');
  if (impacts.find(v=>v.name.includes('Coste Variable'))) recs.push('Acuerdos con proveedores y protocolos que reduzcan consumibles por acto.');
  if (impacts.find(v=>v.name.includes('Marketing'))) recs.push('Optimizar CPA: campa√±as con tracking de conversi√≥n y ramp-up por etapas.');

  return {
    lista:`<ul style="margin:0 0 0 1rem; padding-left:1rem; line-height:1.7;">${bullets||'<li>Genera primero el an√°lisis para ver palancas.</li>'}</ul>`,
    recs:`<ul style="margin:0 0 0 1rem; padding-left:1rem; line-height:1.7;">${recs.map(r=>`<li>${r}</li>`).join('')||'<li>Sin recomendaciones hasta tener sensibilidad.</li>'}</ul>`
  };
}

function generateAISummary(){
  if(!lastData){ alert('Primero genera el an√°lisis financiero.'); return; }
  const d = lastData;

  // Resumen ejecutivo curto y accionable
  const linea1 = textoBreakeven(d);
  const linea2 = `${textoROI(d)} ${textoIRR(d)}`;
  const linea3 = `${textoNPV(d)} Necesidad m√°xima de caja: ${eur(d.necesidadMaxCaja)} (momento m√°s tenso: ${d.mesMinCaja}).`;

  // Palancas / riesgos
  const pal = topPalancas(d);
  const riesgoLiquidez = d.necesidadMaxCaja < 0 ? 
    `Atenci√≥n a la caja: en el peor mes faltar√≠an ${eur(Math.abs(d.necesidadMaxCaja))}. Considera l√≠nea de cr√©dito o escalado de gastos.` :
    `Liquidez suficiente con los supuestos actuales. Mant√©n colch√≥n por si el DSO empeora.`;

  // Render
  document.getElementById('aiExecutive').innerHTML = `
    <p style="margin:0 0 .5rem 0;">${linea1}</p>
    <p style="margin:.25rem 0;">${linea2}</p>
    <p style="margin:.25rem 0;">${linea3}</p>
    <div style="margin-top:1rem; padding:.75rem; background:#ecfeff; border:1px solid #06b6d4; border-radius:8px; color:#0f172a;">
      <strong>Estado de rentabilidad:</strong> ${d.estadoRentabilidad}.
    </div>
  `;
  document.getElementById('aiGlossary').innerHTML = explicacionBreveConceptos();
  document.getElementById('aiLevers').innerHTML = `
    <h4 style="margin:.25rem 0 .5rem; color:#1f2937; font-size:1rem;">Palancas con mayor impacto</h4>
    ${pal.lista}
    <h4 style="margin:1rem 0 .5rem; color:#1f2937; font-size:1rem;">Recomendaciones pr√°cticas</h4>
    ${pal.recs}
    <h4 style="margin:1rem 0 .5rem; color:#1f2937; font-size:1rem;">Riesgo de liquidez</h4>
    <p style="margin:.25rem 0;">${riesgoLiquidez}</p>
  `;

  const wrap = document.getElementById('aiSummary');
  wrap.style.display = 'grid';
  // scroll suave al resultado
  setTimeout(()=>wrap.scrollIntoView({behavior:'smooth', block:'start'}), 100);
}

// Evento del bot√≥n
document.getElementById('aiAnalyze')?.addEventListener('click', generateAISummary);


/* ===================== MASTER REPORT (FINANZAS + COMPETIDORES + MERCADO) ===================== */
var compAnalysis = null; // se setea tras analizar competidores

function chartImgOrNull(chartObj){
  try { return (chartObj && typeof chartObj.toBase64Image === 'function') ? chartObj.toBase64Image() : ''; }
  catch(e){ return ''; }
}

function kpiLine(label, value, note){
  return `<div style="display:flex; justify-content:space-between; gap:1rem; padding:.5rem 0; border-bottom:1px solid #e5e7eb;">
            <div style="font-weight:600; color:#111827;">${label}</div>
            <div style="text-align:right;">
              <div style="font-weight:800; color:#111827;">${value}</div>
              ${note ? `<div style="font-size:.8rem; color:#6b7280;">${note}</div>` : ``}
            </div>
          </div>`;
}

function safePct(n){
  return (isFinite(n) ? n.toFixed(1) + '%' : '‚Äî');
}
function generateMasterReport(){
  const empresa = (document.getElementById('empresaNombre')?.value || 'Cl√≠nica Ejemplo').trim();
  const responsable = (document.getElementById('responsableNombre')?.value || 'Responsable').trim();
  const fecha = new Date().toLocaleDateString('es-ES');

  // Finanzas
  const d = lastData;
  if (!d) {
    alert('Genera primero el an√°lisis financiero en la pesta√±a de Planificaci√≥n Financiera');
    return;
  }

  const beTxt = d.beMes ? `Mes ${d.beMes} (${d.monthLabels[d.beMes-1]})` : 'No alcanzado';
  const roiTxt = safePct(d.roiFinal);
  const irrTxt = (isFinite(d.irrAnual)) ? (d.irrAnual*100).toFixed(1) + '%' : '‚Äî';
  const npvTxt = eur(d.npvVal);
  const cajaTxt = eur(d.necesidadMaxCaja) + (d.mesMinCaja ? ` (${d.mesMinCaja})` : '');

  // Competidores
  const comp = compAnalysis || null;
  const compResumen = comp?.resumenEjecutivo || 'No disponible - Ejecuta el an√°lisis de competidores';
  const compPrecio = comp?.rangoPrecios ? {
    min: comp.rangoPrecios.minimo ?? '‚Äî',
    avg: comp.rangoPrecios.promedio ?? '‚Äî',
    max: comp.rangoPrecios.maximo ?? '‚Äî'
  } : null;
  const compN = Array.isArray(competitors) && competitors.length > 0 ? competitors.length : '‚Äî';
  const compPos = comp?.posicionamientoRecomendado || 'No disponible';

  // Mercado
  const provincia = document.getElementById('provinciaActual')?.textContent || '‚Äî';
  const rangoConsulta = document.getElementById('rangoConsulta')?.textContent || '‚Äî';
  const mixPrivado = document.getElementById('mixPrivado')?.textContent || '‚Äî';
  const crecimientoSector = document.getElementById('crecimientoSector')?.textContent || '‚Äî';
  const dsoPromedio = document.getElementById('dsoPromedio')?.textContent || '‚Äî';

  // Logo
  const logoSrc = document.querySelector('.logo img')?.src || '';

  // Tabla detalle mensual (primeros 12 meses)
  const mesesTabla = Math.min(12, d.mesesArr.length);
  let tablaHtml = `
    <table style="width:100%; border-collapse:collapse; font-size:0.75rem; margin-top:1rem;">
      <thead style="background:#f1f5f9;">
        <tr>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:left;">Mes</th>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">Pacientes</th>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">Ingresos</th>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">EBITDA</th>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">Flujo Mes</th>
          <th style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">Flujo Acum.</th>
        </tr>
      </thead>
      <tbody>`;
  
  for (let i = 0; i < mesesTabla; i++) {
    const flujoColor = d.flujoAcum[i] >= 0 ? '#059669' : '#dc2626';
    tablaHtml += `
      <tr style="border-bottom:1px solid #e5e7eb;">
        <td style="padding:0.5rem; border:1px solid #e5e7eb;">${d.monthLabels[i]}</td>
        <td style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">${d.pacientesEfectivos[i]}</td>
        <td style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">${eur(d.ingresos[i])}</td>
        <td style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right; color:${d.ebitda[i] >= 0 ? '#059669' : '#dc2626'}">${eur(d.ebitda[i])}</td>
        <td style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right;">${eur(d.flujoNeto[i])}</td>
        <td style="padding:0.5rem; border:1px solid #e5e7eb; text-align:right; font-weight:600; color:${flujoColor}">${eur(d.flujoAcum[i])}</td>
      </tr>`;
  }
  tablaHtml += `</tbody></table>`;

  // Palancas
  const pal = topPalancas(d);
  const palancasHtml = `
    <ul style="margin:0.5rem 0 0 1.5rem; line-height:1.7; font-size:0.85rem;">
      ${pal.lista.replace(/<ul[^>]*>|<\/ul>/g, '')}
    </ul>
    <div style="margin-top:1rem;">
      <strong style="color:#1f2937; font-size:0.9rem;">Recomendaciones pr√°cticas:</strong>
      <ul style="margin:0.5rem 0 0 1.5rem; line-height:1.7; font-size:0.85rem;">
        ${pal.recs.replace(/<ul[^>]*>|<\/ul>/g, '')}
      </ul>
    </div>`;

  // Competidores - Oportunidades
  const oportunidadesHtml = comp?.oportunidades ? comp.oportunidades.slice(0, 3).map(op => `
    <div style="padding:0.75rem; background:${op.impacto === 'alto' ? '#dbeafe' : '#fef3c7'}; border-left:3px solid ${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; border-radius:6px; margin-bottom:0.75rem;">
      <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">
        <strong style="font-size:0.9rem; color:#111827;">${op.gap}</strong>
        <span style="font-size:0.7rem; padding:0.15rem 0.5rem; background:${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; color:white; border-radius:10px;">${op.impacto}</span>
      </div>
      <p style="margin:0; font-size:0.8rem; color:#475569;">${op.accion}</p>
    </div>
  `).join('') : '<p style="font-size:0.85rem; color:#6b7280;">No disponible</p>';

  // HTML del informe
  const html = `
  <div style="font-family:Inter, system-ui, sans-serif; color:#111827; max-width:1000px; margin:0 auto; background:white;">
    
    <!-- PORTADA -->
    <div style="background:linear-gradient(135deg, #2563eb 0%, #0891b2 100%); color:white; padding:3rem 2rem; border-radius:16px; margin-bottom:2rem;">
      <div style="display:flex; align-items:center; gap:1.5rem; margin-bottom:1.5rem;">
        ${logoSrc ? `<img src="${logoSrc}" alt="Logo" style="width:96px; height:96px; border-radius:16px; object-fit:cover; background:white; padding:0.5rem;">` : ''}
        <div>
          <h1 style="margin:0; font-size:2.5rem; font-weight:800;">Informe Integral</h1>
          <div style="font-size:1.1rem; opacity:0.95; margin-top:0.5rem;">${empresa}</div>
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; font-size:0.95rem; opacity:0.9;">
        <div>üìÖ Fecha: ${fecha}</div>
        <div>üë§ Responsable: ${responsable}</div>
      </div>
    </div>

    <!-- RESUMEN EJECUTIVO -->
    <div style="background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border:2px solid #059669; border-radius:12px; padding:1.5rem; margin-bottom:2rem;">
      <h2 style="margin:0 0 1rem; font-size:1.3rem; color:#059669;">üìä Resumen Ejecutivo</h2>
      <p style="margin:0; font-size:1rem; line-height:1.6;">
        <strong>${d.analisisTexto.replace(/<[^>]*>/g, '')}</strong>
      </p>
    </div>

    <!-- 1. RESULTADOS FINANCIEROS -->
    <div style="page-break-inside:avoid; margin-bottom:2rem;">
      <h2 style="margin:0 0 1rem; font-size:1.5rem; color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:0.5rem;">
        1Ô∏è‚É£ Resultados Financieros
      </h2>
      
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:1rem; margin-bottom:1.5rem;">
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">Inversi√≥n Inicial</div>
          <div style="font-size:1.8rem; font-weight:800; color:#111827;">${eur(num('capex'))}</div>
        </div>
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">Break-even</div>
          <div style="font-size:1.8rem; font-weight:800; color:#111827;">${beTxt}</div>
        </div>
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">ROI Final</div>
          <div style="font-size:1.8rem; font-weight:800; color:#059669;">${roiTxt}</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:1rem; margin-bottom:1.5rem;">
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">VAN (NPV)</div>
          <div style="font-size:1.5rem; font-weight:800; color:#111827;">${npvTxt}</div>
        </div>
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">TIR Anual</div>
          <div style="font-size:1.5rem; font-weight:800; color:#111827;">${irrTxt}</div>
        </div>
        <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center;">
          <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.5rem;">Necesidad M√°x. Caja</div>
          <div style="font-size:1.5rem; font-weight:800; color:#dc2626;">${cajaTxt}</div>
        </div>
      </div>

      <h3 style="margin:1.5rem 0 0.75rem; font-size:1.1rem; color:#111827;">üìã Detalle Mensual (A√±o 1)</h3>
      ${tablaHtml}
      <p style="font-size:0.75rem; color:#6b7280; margin-top:0.5rem; font-style:italic;">
        * Tabla resumida con primeros 12 meses. Ver pesta√±a Planificaci√≥n Financiera para detalle completo.
      </p>
    </div>

    <!-- 2. COMPETIDORES -->
    <div style="page-break-inside:avoid; margin-bottom:2rem;">
      <h2 style="margin:0 0 1rem; font-size:1.5rem; color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:0.5rem;">
        2Ô∏è‚É£ An√°lisis de Competencia
      </h2>
      
      <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
        <p style="margin:0 0 1rem; font-size:0.95rem; line-height:1.6;">${compResumen}</p>
        
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem;">
          <div style="text-align:center; padding:1rem; background:white; border-radius:8px;">
            <div style="font-size:0.8rem; color:#6b7280;">Competidores Analizados</div>
            <div style="font-size:2rem; font-weight:800; color:#2563eb;">${compN}</div>
          </div>
          <div style="text-align:center; padding:1rem; background:white; border-radius:8px;">
            <div style="font-size:0.8rem; color:#6b7280;">Precio Medio Mercado</div>
            <div style="font-size:2rem; font-weight:800; color:#2563eb;">${compPrecio ? `‚Ç¨${compPrecio.avg}` : '‚Äî'}</div>
            ${compPrecio ? `<div style="font-size:0.75rem; color:#6b7280;">Rango: ‚Ç¨${compPrecio.min} - ‚Ç¨${compPrecio.max}</div>` : ''}
          </div>
        </div>
      </div>

      ${compPos !== 'No disponible' ? `
      <div style="background:#ecfdf5; border:2px solid #059669; border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
        <h3 style="margin:0 0 0.75rem; font-size:1rem; color:#059669;">üéØ Posicionamiento Recomendado</h3>
        <p style="margin:0; font-size:0.9rem; line-height:1.6;">${compPos}</p>
      </div>` : ''}

      <h3 style="margin:1.5rem 0 0.75rem; font-size:1.1rem; color:#111827;">üí° Oportunidades Identificadas</h3>
      ${oportunidadesHtml}
    </div>

    <!-- 3. INTELIGENCIA DE MERCADO -->
    <div style="page-break-inside:avoid; margin-bottom:2rem;">
      <h2 style="margin:0 0 1rem; font-size:1.5rem; color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:0.5rem;">
        3Ô∏è‚É£ Inteligencia de Mercado
      </h2>
      
      <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1.5rem;">
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem;">
          ${kpiLine('üìç √Årea Analizada', provincia, '')}
          ${kpiLine('üí∞ Consulta Especializada', rangoConsulta, '')}
          ${kpiLine('üè• Mix Privado', mixPrivado, '')}
          ${kpiLine('üìà Crecimiento Sector', crecimientoSector, '')}
          ${kpiLine('‚è±Ô∏è DSO Aseguradoras', dsoPromedio, '')}
        </div>
        <div style="margin-top:1rem; padding:0.75rem; background:#fef3c7; border-radius:8px; font-size:0.75rem; color:#92400e;">
          ‚ö†Ô∏è <strong>Nota:</strong> Indicadores orientativos para decisi√≥n estrat√©gica. Validar con investigaci√≥n de mercado local.
        </div>
      </div>
    </div>

    <!-- 4. PALANCAS Y RIESGOS -->
    <div style="page-break-inside:avoid;">
      <h2 style="margin:0 0 1rem; font-size:1.5rem; color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:0.5rem;">
        4Ô∏è‚É£ Palancas de Crecimiento y Riesgos
      </h2>
      
      <div style="background:#f8fafc; border:2px solid #e5e7eb; border-radius:12px; padding:1.5rem; margin-bottom:1rem;">
        <h3 style="margin:0 0 0.75rem; font-size:1rem; color:#111827;">üéØ Top 3 Palancas de Impacto</h3>
        ${palancasHtml}
      </div>

      <div style="background:${d.necesidadMaxCaja < 0 ? '#fee2e2' : '#ecfdf5'}; border:2px solid ${d.necesidadMaxCaja < 0 ? '#dc2626' : '#059669'}; border-radius:12px; padding:1.5rem;">
        <h3 style="margin:0 0 0.75rem; font-size:1rem; color:${d.necesidadMaxCaja < 0 ? '#dc2626' : '#059669'};">üíß Riesgo de Liquidez</h3>
        <p style="margin:0; font-size:0.9rem; line-height:1.6;">
          ${d.necesidadMaxCaja < 0
            ? `<strong>‚ö†Ô∏è Atenci√≥n:</strong> En el peor momento (${d.mesMinCaja}) faltar√≠an ${eur(Math.abs(d.necesidadMaxCaja))}. Considera l√≠nea de cr√©dito o escalado gradual de gastos.`
            : `<strong>‚úÖ Situaci√≥n favorable:</strong> Liquidez suficiente con los supuestos actuales. Mant√©n colch√≥n de seguridad por si el DSO de aseguradoras empeora.`}
        </p>
      </div>
    </div>

    <!-- FOOTER -->
    <div style="margin-top:3rem; padding-top:1.5rem; border-top:2px solid #e5e7eb; text-align:center; color:#6b7280; font-size:0.75rem;">
      <p style="margin:0;">Generado con OptimClinic - Planificaci√≥n Financiera y An√°lisis de Mercado</p>
      <p style="margin:0.25rem 0 0;">${fecha}</p>
    </div>

  </div>`;

  // Mostrar vista previa
  document.getElementById('reportContent').innerHTML = html;
  document.getElementById('reportPreview').style.display = 'block';
  setTimeout(()=>document.getElementById('reportPreview').scrollIntoView({behavior:'smooth', block:'start'}), 200);
}

function exportMasterReportPDF(){
  const content = document.getElementById('reportContent')?.innerHTML || '';
  if(!content){ alert('Genera primero el Informe Integral.'); return; }

  const css = `
  @page { size: A4; margin: 14mm; }
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#111827; }
  img { max-width: 100%; height: auto; }
  h2, h3, h4 { break-after: avoid; }
  .page-break { page-break-before: always; }
  `;

  const w = window.open('', '_blank');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Informe Integral</title><style>${css}</style></head><body>${content}</body></html>`);
  w.document.close();
  w.focus();
  // esperar a que carguen im√°genes base64 antes de imprimir
  setTimeout(() => { w.print(); w.close(); }, 500);
}

    /* ===================== REPORTS ===================== */
    function generateExecutiveReport() {
      const empresa = getEl('empresaNombre').value || 'Cl√≠nica Ejemplo';
      const responsable = getEl('responsableNombre').value || 'Responsable';
      
      getEl('reportContent').innerHTML = `
        <h3>Informe Ejecutivo - ${empresa}</h3>
        <p><strong>Responsable:</strong> ${responsable}</p>
        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
        <hr style="margin: 1rem 0;">
        <h4>Resumen Financiero</h4>
        ${lastData ? `
          <p>Inversi√≥n inicial: ${eur(num('capex'))}</p>
          <p>Break-even: ${lastData.beMes ? 'Mes ' + lastData.beMes : 'No alcanzado'}</p>
          <p>ROI proyectado: ${lastData.roiFinal.toFixed(1)}%</p>
        ` : '<p>Genera primero el an√°lisis financiero</p>'}
      `;
      getEl('reportPreview').style.display = 'block';
    }

    function generateBankDossier() {
      generateExecutiveReport();
    }

    /* ===================== EVENTOS ===================== */
    getEl('calc').addEventListener('click', function(){ proyectar(); render(); });
    getEl('reset').addEventListener('click', function(){ if (confirm('¬øRestablecer par√°metros?')) location.reload(); });
    
    getEl('exportCsv').addEventListener('click', function() {
      if (!lastData) return alert('Genere el an√°lisis primero');
      var d = lastData;
      var rows = d.mesesArr.map(function(_, i) {
        return [
  d.monthLabels[i], d.pacientesPlanif[i], d.pacientesEfectivos[i],
  d.ingresos[i], d.ingresosColab?.[i] || 0,
  d.cVariables[i], d.cfMensual[i], d.ebitda[i],
  d.amortArr[i], d.ebit[i], d.intereses[i], d.impuestos[i],
  d.principal[i], d.flujoNeto[i], d.flujoAcum[i]
].join(',');
      });
      var csv = ['Mes,Planif,Efectivos,Ingresos,Ing.Colab,C.Var,C.Fijos,EBITDA,Amort,EBIT,Intereses,Impuestos,Principal,Flujo,Acumulado', ...rows].join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'opticlinic_analisis.csv';
      a.click();
    });

    getEl('exportXlsx').addEventListener('click', function() {
      if (!lastData) return alert('Genere el an√°lisis primero');
      var d = lastData;
      var data = [['Mes','Planif','Efectivos','Ingresos','Ing.Colab','C.Var','C.Fijos','EBITDA','Amort','EBIT','Intereses','Impuestos','Principal','Flujo','Acumulado']];
      d.mesesArr.forEach(function(_, i) {
        data.push([
  d.monthLabels[i], d.pacientesPlanif[i], d.pacientesEfectivos[i],
  d.ingresos[i], d.ingresosColab?.[i] || 0,
  d.cVariables[i], d.cfMensual[i], d.ebitda[i],
  d.amortArr[i], d.ebit[i], d.intereses[i], d.impuestos[i],
  d.principal[i], d.flujoNeto[i], d.flujoAcum[i]
]);

      });
      var wb = XLSX.utils.book_new();
      var ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis');
      XLSX.writeFile(wb, 'opticlinic_analisis.xlsx');
    });

document.getElementById('btnPDFDetalle')?.addEventListener('click', async (e) => {
  e.preventDefault();
  const btn = e.currentTarget;
  btn.disabled = true;
  const original = btn.textContent;
  btn.textContent = 'Generando PDF...';
  try {
    await exportFinancialPDFjsPDF();
  } catch (err) {
    console.error(err);
    alert('No se pudo generar el PDF: ' + (err?.message || err));
  } finally {
    btn.disabled = false;
    btn.textContent = original || 'üìÑ Descargar PDF';
  }
});

/* ====== Formateadores consistentes ====== */
function intFmt(n){
  return new Intl.NumberFormat('es-ES', {
    useGrouping: true,
    maximumFractionDigits: 0
  }).format(Math.round(n || 0));
}
function eurFmt(n){
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(Number(n || 0)).replace(/\u00A0/g, ' ');
}
function pctFmt(n){
  if (!isFinite(n)) return '‚Äî';
  return new Intl.NumberFormat('es-ES', {
    maximumFractionDigits: 1
  }).format(n) + '%';
}
function sum(arr){ return (arr||[]).reduce((a,b)=>a+(Number(b)||0),0); }

/* ====== Utilidades logo ====== */
async function imgToDataURL(url){
  try {
    const res = await fetch(url, { mode: 'cors' });
    if (!res.ok) return null;
    const blob = await res.blob();
    return await new Promise(r=>{
      const f = new FileReader();
      f.onload = ()=>r(f.result);
      f.readAsDataURL(blob);
    });
  } catch {
    return null;
  }
}

/* ====== Generaci√≥n del PDF ====== */
async function exportFinancialPDFjsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;

  const nfEUR = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
  const nfINT = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 });
  const eurFmt = v => nfEUR.format(Math.round(Number(v || 0)));
  const intFmt = v => nfINT.format(Math.round(Number(v || 0)));

  const empresa = document.getElementById('empresa')?.value || '‚Äî';
  const responsable = document.getElementById('responsable')?.value || '‚Äî';
  const d = window.lastData;

  const addLogo = async () => {
    const url = (document.querySelector('.logo img')?.src) || 'https://i.imgur.com/eRKd3Hp.jpg';
    try {
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) return;
      const blob = await res.blob();
      await new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => { try { doc.addImage(fr.result, 'JPEG', margin, margin - 6, 64, 64); } catch {} r(); };
        fr.readAsDataURL(blob);
      });
    } catch {}
  };

  await addLogo();

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(26);
  doc.text('Informe Financiero ‚Äì Escenario Base', pageW / 2, margin + 10, { align: 'center' });

  let y = margin + 56;

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(12);
  doc.text('Empresa: ' + empresa, margin + 74, margin + 8);
  doc.text('Responsable: ' + responsable, margin + 74, margin + 26);

  const capex = document.getElementById('capex')?.value || 0;
  const finImporte = document.getElementById('finImporte')?.value || 0;
  const finInteres = document.getElementById('finInteres')?.value || 0;
  const finPlazo = document.getElementById('finPlazo')?.value || 0;
  const dsoTxt = document.getElementById('toggleDSO')?.checked ? (document.getElementById('dsoAseg')?.value + ' d√≠as') : 'No aplica';
  const impTxt = document.getElementById('toggleImp')?.checked ? (Number(document.getElementById('impSoc')?.value || 0).toFixed(1) + '%') : '‚Äî';

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(13);
  doc.text('Supuestos principales', margin, y); y += 16;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(12);
  [
    'CAPEX: ' + eurFmt(capex) + ' ¬∑ Horizonte: ' + d.mesesArr.length + ' meses',
    'Financiaci√≥n: ' + eurFmt(finImporte) + ' ¬∑ ' + Number(finInteres).toFixed(1) + '% ¬∑ ' + finPlazo + 'm',
    'DSO aseguradoras: ' + dsoTxt + ' ¬∑ Impuesto sociedades: ' + impTxt
  ].forEach(line => { doc.text(line, margin, y); y += 16; });

  y += 10;

  const kpi = [
    ['Break-even', d.beMes ? ('Mes ' + d.beMes + ' (' + d.monthLabels[d.beMes - 1] + ')') : 'No alcanzado'],
    ['ROI Final', isFinite(d.roiFinal) ? (Math.round(d.roiFinal) + '%') : '‚Äî'],
    ['VAN (NPV)', eurFmt(d.npvVal)],
    ['TIR Anual', isFinite(d.irrAnual) ? (Math.round(d.irrAnual * 100) + '%') : '‚Äî'],
    ['Necesidad m√°x. caja', eurFmt(d.necesidadMaxCaja) + (d.mesMinCaja ? (' (' + d.mesMinCaja + ')') : '')]
  ];
  const colW = (pageW - margin * 2) / 5;
  doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
  for (let i = 0; i < kpi.length; i++) doc.text(kpi[i][0], margin + i * colW, y);
  doc.setFont('helvetica', 'normal'); doc.setFontSize(18); y += 20;
  for (let i = 0; i < kpi.length; i++) doc.text(String(kpi[i][1]), margin + i * colW, y);
  y += 18;

  const head = [[
    'Mes','Planif.','Efectivos','Ingresos','Ing. Colab','C.Var','C.Fijos','EBITDA','Amort.','EBIT','Intereses','Impuestos','Principal','Flujo','Acum.'
  ]];

  const body = d.mesesArr.map((_, i) => ([
    d.monthLabels[i],
    intFmt(d.pacientesPlanif[i]),
    intFmt(d.pacientesEfectivos[i]),
    eurFmt(d.ingresos[i]),
    eurFmt((d.ingresosColab?.[i] || 0)),
    eurFmt(d.cVariables[i]),
    eurFmt(d.cfMensual[i]),
    eurFmt(d.ebitda[i]),
    eurFmt(d.amortArr[i]),
    eurFmt(d.ebit[i]),
    eurFmt(d.intereses[i]),
    eurFmt(d.impuestos[i]),
    eurFmt(d.principal[i]),
    eurFmt(d.flujoNeto[i]),
    eurFmt(d.flujoAcum[i])
  ]));

  const totals = {
    planif: d.pacientesPlanif.reduce((a,b)=>a+(+b||0),0),
    efect: d.pacientesEfectivos.reduce((a,b)=>a+(+b||0),0),
    ingresos: d.ingresos.reduce((a,b)=>a+(+b||0),0),
    ingColab: (d.ingresosColab||[]).reduce((a,b)=>a+(+b||0),0),
    cvar: d.cVariables.reduce((a,b)=>a+(+b||0),0),
    cfijos: d.cfMensual.reduce((a,b)=>a+(+b||0),0),
    ebitda: d.ebitda.reduce((a,b)=>a+(+b||0),0),
    amort: d.amortArr.reduce((a,b)=>a+(+b||0),0),
    ebit: d.ebit.reduce((a,b)=>a+(+b||0),0),
    intereses: d.intereses.reduce((a,b)=>a+(+b||0),0),
    impuestos: d.impuestos.reduce((a,b)=>a+(+b||0),0),
    principal: d.principal.reduce((a,b)=>a+(+b||0),0),
    flujo: d.flujoNeto.reduce((a,b)=>a+(+b||0),0),
    acum: (d.flujoAcum && d.flujoAcum.length ? d.flujoAcum[d.flujoAcum.length - 1] : 0)
  };

  const foot = [[
    'Totales',
    intFmt(totals.planif),
    intFmt(totals.efect),
    eurFmt(totals.ingresos),
    eurFmt(totals.ingColab),
    eurFmt(totals.cvar),
    eurFmt(totals.cfijos),
    eurFmt(totals.ebitda),
    eurFmt(totals.amort),
    eurFmt(totals.ebit),
    eurFmt(totals.intereses),
    eurFmt(totals.impuestos),
    eurFmt(totals.principal),
    eurFmt(totals.flujo),
    eurFmt(totals.acum)
  ]];

  const rightCols = [1,2,3,4,5,6,7,8,9,10,11,12,13,14];

  doc.autoTable({
    head,
    body,
    foot,
    startY: y + 10,
    theme: 'grid',
    styles: { font: 'helvetica', fontSize: 10, cellPadding: 4 },
    headStyles: { fillColor: [37,99,235], textColor: 255 },
    footStyles: { fillColor: [241,245,249], textColor: [17,24,39], fontStyle: 'bold' },
    columnStyles: Object.assign({ 0: { halign: 'left' } }, Object.fromEntries(rightCols.map(c => [c, { halign: 'right' }]))),
    didParseCell: function(data) {
      const col = data.column.index;
      if (data.section === 'body') {
        if (col === 7 || col === 13 || col === 14) {
          const raw = [d.ebitda, d.flujoNeto, d.flujoAcum][[7,13,14].indexOf(col)][data.row.index];
          if (raw < 0) data.cell.styles.textColor = [220,38,38];
          if (raw > 0) data.cell.styles.textColor = [5,150,105];
        }
      }
      if (data.section === 'foot') {
        if (col === 0) data.cell.styles.halign = 'center';
        if (col === 7 || col === 13 || col === 14) {
          const raw = [totals.ebitda, totals.flujo, totals.acum][[7,13,14].indexOf(col)];
          if (raw < 0) data.cell.styles.textColor = [220,38,38];
          if (raw > 0) data.cell.styles.textColor = [5,150,105];
        }
      }
    },
    margin: { left: margin, right: margin, top: margin, bottom: margin },
    didDrawPage: function () {
      doc.setFontSize(9);
      doc.text('P√°gina ' + doc.internal.getNumberOfPages(), pageW - margin, pageH - 12, { align: 'right' });
    }
  });

  doc.save('Informe_Financiero.pdf');
}



function addFooter(doc){
  const pageCount = doc.getNumberOfPages();
  const pageW = doc.internal.pageSize.getWidth();
  doc.setFontSize(9); doc.setTextColor(140);
  doc.text(`P√°gina ${pageCount}`, pageW - 60, doc.internal.pageSize.getHeight() - 10);
  doc.setTextColor(0);
}

// Dibuja KPIs en cajas
function drawKPIs(doc, items, x, y, width){
  const col = items.length;
  const w = Math.min(180, Math.floor(width / col) - 6);
  for (let i=0;i<items.length;i++){
    const xi = x + i*(w+6);
    doc.setDrawColor(229,231,235); doc.setFillColor(248,250,252);
    doc.roundedRect(xi, y, w, 60, 6, 6, 'FD');
    doc.setFontSize(10); doc.setTextColor(80); doc.text(items[i][0], xi+10, y+18);
    doc.setFontSize(14); doc.setFont('helvetica','bold'); doc.setTextColor(0); doc.text(String(items[i][1]), xi+10, y+40);
    doc.setFont('helvetica','normal');
  }
}

// Carga una imagen externa en base64 y la a√±ade (silenciosamente si falla)
function addImageIfPossible(doc, src, x, y, w, h){
  return new Promise((resolve)=> {
    if(!src) return resolve();
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => { 
      try { doc.addImage(img, 'PNG', x, y, w, h, undefined, 'FAST'); } catch(e){}
      resolve();
    };
    img.onerror = () => resolve();
    img.src = src;
  });
}



    /* ===================== INICIALIZACI√ìN ===================== */
    (function initStartMonth(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      getEl('mesInicio').value = `${y}-${m}`;
    })();

    setTimeout(function() { 
      actualizarCalculos(); 
      proyectar(); 
      render(); 
    }, 200);
// ========== ADMIN: SCRAPER DE DOCTORALIA ==========

document.getElementById('adminScraperBtn')?.addEventListener('click', async function() {
  const provincia = document.getElementById('provincia').value;
  const especialidad = document.getElementById('especialidadScraper').value;
  const password = prompt('Contrase√±a de admin:');
  
  if (!password) return;
  
  const btn = this;
  btn.disabled = true;
  btn.textContent = 'Scrapeando...';
  
  try {
    const res = await fetch('/api/scrape-doctoralia', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provincia, especialidad, adminPassword: password })
    });
    
    const data = await res.json();
    
    if (!res.ok) throw new Error(data.error || 'Error en scraping');
    
    // Mostrar datos temporalmente en la interfaz
    mostrarDatosTemporales(data);
    
    // Log para copiar al c√≥digo si quieres
    console.log('=====================================');
    console.log('DATOS PARA ' + provincia + ' - ' + (data.especialidad || 'general').toUpperCase());
    console.log('=====================================');
    console.log("'" + provincia + "': {");
    console.log('  consulta: ' + data.codigoActualizar.consulta + ',');
    console.log('  mixPrivado: ' + data.codigoActualizar.mixPrivado + ',');
    console.log('  crecimiento: ' + data.codigoActualizar.crecimiento + ',');
    console.log('  dso: ' + data.codigoActualizar.dso);
    console.log('},');
    console.log('URL usada: ' + data.urlUsada);
    console.log('Muestras: ' + data.muestras);
    console.log('=====================================');
    
    alert('Scraping exitoso!\n\n' + 
          'Provincia: ' + provincia + '\n' +
          'Especialidad: ' + (data.especialidad || 'general') + '\n' +
          'Muestras: ' + data.muestras + '\n' +
          'Rango: ' + data.consulta + '\n\n' +
          'Datos actualizados en la interfaz temporalmente');
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Admin: Actualizar Precios';
  }
});

// NUEVA FUNCI√ìN: Mostrar datos scrapeados temporalmente
function mostrarDatosTemporales(data) {
  // Actualizar KPIs con datos scrapeados
  getEl('rangoConsulta').textContent = data.consulta;
  getEl('mixPrivado').textContent = data.mixPrivado;
  getEl('crecimientoSector').textContent = data.crecimiento;
  getEl('dsoPromedio').textContent = data.dso;
  getEl('provinciaActual').textContent = data.provincia + ' - ' + (data.especialidad || 'general');
  
  // Crear/actualizar banner de datos temporales
  let banner = document.getElementById('bannerDatosTemp');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'bannerDatosTemp';
    banner.style = 'background:#fef3c7; padding:1rem; border-radius:8px; margin:1rem 0; border:2px solid #f59e0b';
    
    // Insertar antes de la secci√≥n de Inteligencia de Mercado
    const marketSection = document.querySelector('#market-tab .card-body > div');
    if (marketSection) {
      marketSection.insertAdjacentElement('beforebegin', banner);
    }
  }
  
  banner.innerHTML = `
    <strong>Datos actualizados para esta sesi√≥n:</strong><br>
    ${data.provincia} - <strong>${data.especialidad || 'general'}</strong><br>
    Rango: ${data.consulta} (${data.muestras} muestras)<br>
    Mix privado: ${data.mixPrivado} | Crecimiento: ${data.crecimiento} | DSO: ${data.dso}<br>
    <small style="color:#92400e">Estos datos son temporales y no modifican la configuraci√≥n base. V√°lidos solo para esta sesi√≥n de trabajo con el cliente.</small>
    <button onclick="this.parentElement.remove()" style="float:right; margin-top:-1.5rem; background:transparent; border:none; cursor:pointer; font-size:1.2rem">√ó</button>
  `;
}

// Mostrar selector de especialidad cuando se activa modo admin
(function initAdminScraper() {
  let adminClicks = 0;
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
      adminClicks++;
      if (adminClicks >= 3) {
        document.getElementById('adminScraperBtn').style.display = 'block';
        document.getElementById('especialidadScraper').style.display = 'block';
        console.log('Modo admin activado');
        adminClicks = 0;
      }
      setTimeout(() => { adminClicks = 0; }, 2000);
    }
  });
})();
  </script>

<!-- 2A: UI estacionalidad + presets + getDemandConfig (IIFE corregido) -->
<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const monthsES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

  // Estado de estacionalidad (array 12)
  window.seasonality = (window.seasonality && window.seasonality.length===12)
    ? window.seasonality
    : [1,1,1,1,1,0.9,0.85,0.85,0.95,1.05,1.1,1.05];

  function renderSeasonTable(){
    const tb = $('seasonTableBody');
    if(!tb) return;
    const rows = [];
    for(let i=0;i<6;i++){
      const m1=i, m2=i+6;
      rows.push(`
        <tr>
          <td style="padding:6px 8px">${monthsES[m1]}</td>
          <td style="padding:6px 8px">
            <input type="number" step="0.01" min="0" class="inp season-input" data-month="${m1}" value="${Number(window.seasonality[m1]).toFixed(2)}">
          </td>
          <td style="padding:6px 8px">${monthsES[m2]}</td>
          <td style="padding:6px 8px">
            <input type="number" step="0.01" min="0" class="inp season-input" data-month="${m2}" value="${Number(window.seasonality[m2]).toFixed(2)}">
          </td>
        </tr>`);
    }
    tb.innerHTML = rows.join('');
    tb.querySelectorAll('.season-input').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const idx = Number(e.target.dataset.month);
        const v = Number(e.target.value);
        window.seasonality[idx] = isFinite(v) ? v : 1;
        window.saveDemandConfig?.(); // guarda al vuelo
      });
    });
  }

  // Presets r√°pidos
  const PRESETS = {
    generic:   [1.00,1.00,1.02,1.03,1.05,0.95,0.90,0.92,1.00,1.06,1.08,1.08],
    summer_es: [1.02,1.02,1.03,1.05,1.03,0.90,0.85,0.85,0.95,1.05,1.10,1.10],
    q4_peak:   [0.98,1.00,1.02,1.03,1.04,0.96,0.92,0.92,1.00,1.08,1.12,1.13]
  };

  $('btnPresetGen')?.addEventListener('click', ()=>{
    window.seasonality=[...PRESETS.generic];
    renderSeasonTable();
    window.saveDemandConfig?.();
  });
  $('btnPresetSummer')?.addEventListener('click', ()=>{
    window.seasonality=[...PRESETS.summer_es];
    renderSeasonTable();
    window.saveDemandConfig?.();
  });
  $('btnPresetQ4')?.addEventListener('click', ()=>{
    window.seasonality=[...PRESETS.q4_peak];
    renderSeasonTable();
    window.saveDemandConfig?.();
  });
  $('btnResetSeason')?.addEventListener('click', ()=>{
    window.seasonality = Array(12).fill(1);
    renderSeasonTable();
    window.saveDemandConfig?.();
  });

  // Mostrar/ocultar controles seg√∫n perfil
  function toggleGrowthUI(){
    const prof = $('growthProfile')?.value || 'linear';
    $('annualBox')?.style && ( $('annualBox').style.display = (prof==='annual_target') ? 'block' : 'none' );
    $('rampBox')?.style   && ( $('rampBox').style.display   = (prof==='ramp' || prof==='logistic') ? 'block' : 'none' );
    $('satBox')?.style    && ( $('satBox').style.display    = (prof==='logistic') ? 'block' : 'none' );
  }
  $('growthProfile')?.addEventListener('change', ()=>{
    toggleGrowthUI();
    window.saveDemandConfig?.();
  });
  toggleGrowthUI();

  renderSeasonTable();

  // Exponer lector de par√°metros
  window.getDemandConfig = function(){
    return {
      profile: $('growthProfile')?.value || 'linear',
      growPct: num($('growPct'), 2) / 100,         // % mensual base
      rampMonths: Math.max(1, num($('rampMonths'), 6)),
      saturation: Math.max(0, num($('saturationPct'), 60)/100), // tope crecimiento acumulado
      annualTarget: Math.max(0, num($('annualTarget'), 0)),
      seasonality: window.seasonality.slice(0,12)
    };
  };

  // Exponer render para que la persistencia pueda repintar al cargar
  window.renderSeasonTable = renderSeasonTable;

  function num(el, def=0){ const v = Number(el?.value); return isFinite(v) ? v : def; }
})();
</script>

<!-- Persistencia: guarda/carga config de demanda -->
<script>
(function(){
  const KEY = 'opti_demand_cfg_v1';

  window.saveDemandConfig = function(){
    const cfg = window.getDemandConfig?.();
    if (!cfg) return;
    try { localStorage.setItem(KEY, JSON.stringify(cfg)); } catch {}
  };

  window.loadDemandConfig = function(){
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return;
      const cfg = JSON.parse(raw);
      // Rellena UI
      if (cfg.profile) document.getElementById('growthProfile').value = cfg.profile;
      if (cfg.growPct!=null) document.getElementById('growPct').value = (cfg.growPct*100).toFixed(1);
      if (cfg.rampMonths!=null) document.getElementById('rampMonths').value = cfg.rampMonths;
      if (cfg.saturation!=null) document.getElementById('saturationPct').value = Math.round(cfg.saturation*100);
      if (cfg.annualTarget!=null) document.getElementById('annualTarget').value = cfg.annualTarget;
      if (Array.isArray(cfg.seasonality) && cfg.seasonality.length===12) {
        window.seasonality = cfg.seasonality.slice(0,12);
      }
      // Re-render de la tabla + mostrar/ocultar controles
      document.getElementById('growthProfile').dispatchEvent(new Event('change'));
      if (typeof renderSeasonTable === 'function') renderSeasonTable();
    } catch {}
  };

  // Guarda al cambiar algo (seguro)
  document.addEventListener('change', (e)=>{
    const ids = ['growthProfile','growPct','rampMonths','saturationPct','annualTarget'];
    if (ids.includes(e.target.id) || e.target.classList?.contains('season-input')) {
      window.saveDemandConfig?.();
    }
  });

  // Carga al entrar
  document.addEventListener('DOMContentLoaded', ()=> window.loadDemandConfig?.());
})();
</script>

<!-- 2B: growthFactor / computeMonthlyDemand (funciones puras) -->
<script>
function growthFactor(m, cfg){
  const g = cfg.growPct || 0;         // p.ej. 0.02 = +2%/mes
  const R = Math.max(1, cfg.rampMonths || 6);
  const S = Math.max(0, cfg.saturation || 0.6); // 0.6 = +60% tope acumulado

  switch (cfg.profile) {
    case 'linear':   return Math.pow(1+g, m);
    case 'ramp':     return 1 + g * Math.min(m, R);
    case 'logistic': {
      const k = 6 / R; // pendiente
      return 1 + (S / (1 + Math.exp(-k*(m - R/2))));
    }
    case 'annual_target': return 1.0;
    default: return 1.0;
  }
}

function computeMonthlyDemand(base, m, cfg, season, marketingLift=1){
  if (cfg.profile === 'annual_target') {
    // modo objetivo anual: devolvemos el peso estacional
    return season;
  }
  const gf = growthFactor(m, cfg);
  return base * gf * season * marketingLift;
}
</script>



<!-- NUEVO: generador de prompt para Gamma -->
  <script src="api/gamma-prompt.js"></script>
</body>
</html>