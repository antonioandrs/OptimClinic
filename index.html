<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OptiClinic - Planificaci√≥n Financiera y An√°lisis de Mercado</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb; --primary-dark: #1d4ed8; --accent: #0891b2; --success: #059669; --warning: #d97706; --danger: #dc2626;
      --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-600: #475569; --gray-900: #0f172a;
      --bg: var(--gray-50); --card: var(--white); --text: var(--gray-900); --text-muted: var(--gray-600); --border: var(--gray-200);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1); --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: linear-gradient(135deg, var(--gray-50) 0%, #e0f2fe 100%); color: var(--text); font-family: 'Inter', system-ui, sans-serif; line-height: 1.6; min-height: 100vh; }

    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: var(--white); padding: 3rem 0; position: relative; overflow: hidden; }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 1; }
    .brand { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }

    /* ====== LOGO (actualizado) ====== */
 /* Logo grande, sin padding, y con ‚Äúzoom‚Äù en la imagen */
.logo{
  width: 132px;          /* ajusta 120‚Äì160px si quieres */
  height: 132px;
  background: var(--white);
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;            /* sin padding para aprovechar todo */
  overflow: hidden;      /* por si cover recorta */
  flex-shrink: 0;
  box-shadow: 0 4px 10px rgb(0 0 0 / 0.08);
}

.logo img{
  width: 100%;
  height: 100%;
  object-fit: cover;     /* rellena y reduce el borde blanco del JPG */
  display: block;
  border-radius: 14px;
  transform: scale(1.18);  /* ‚Äúzoom‚Äù para compensar margen blanco interno */
  transform-origin: center;
}

@media (max-width: 640px){
  .logo{ width: 96px; height: 96px; }
  .logo img{ transform: scale(1.12); }
}

    /* ====== /LOGO ====== */

    .brand-name { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; margin: 0; }
    .brand-tagline { font-size: 0.875rem; opacity: 0.9; font-weight: 500; }
    .header h1 { font-size: clamp(1.875rem, 4vw, 3rem); font-weight: 700; margin: 0 0 1rem; line-height: 1.2; }
    .header-description { font-size: 1.125rem; opacity: 0.95; max-width: 600px; line-height: 1.6; }

    .container { max-width: 1400px; margin: -2rem auto 0; padding: 0 2rem 4rem; position: relative; z-index: 2; }

    /* Tabs */
    .tabs { display: flex; background: var(--white); border-radius: 16px 16px 0 0; box-shadow: var(--shadow-lg); margin-bottom: 0; overflow-x: auto; }
    .tab { padding: 1rem 2rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; white-space: nowrap; transition: all 0.3s; }
    .tab.active { border-bottom-color: var(--primary); background: var(--gray-50); color: var(--primary); }
    .tab:hover:not(.active) { background: var(--gray-50); }

    .tab-content { display: none; background: var(--white); border-radius: 0 0 16px 16px; box-shadow: var(--shadow-lg); }
    .tab-content.active { display: block; }

    .grid { display: grid; gap: 2rem; grid-template-columns: 1fr; padding: 2rem; }
    @media (min-width: 1200px) { .grid { grid-template-columns: 480px 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow-lg); transition: all 0.3s; overflow: hidden; }
    .card:hover { box-shadow: var(--shadow-xl); transform: translateY(-2px); }
    .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .card-title { margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text); }
    .card-body { padding: 1.5rem; }

    .badge { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary); color: var(--white); padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600; }
    .section-title { margin: 1.5rem 0 0.75rem; font-size: 0.875rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

    .form-row { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    .form-row-3 { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 1024px) { .form-row-3 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .form-row, .form-row-3 { grid-template-columns: 1fr; } }

    label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    input, select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; font: inherit; font-size: 0.875rem; transition: all 0.2s; background: var(--white); color: var(--text); }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1); }
    input[readonly] { background: var(--gray-50); color: var(--text-muted); }

    .switch { display:flex; align-items:center; gap:.5rem; }
    .switch input { width:auto; }

    .btn { cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; }
    .btn-primary { background: var(--primary); color: var(--white); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--white); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--gray-50); }
    .btn-success { background: var(--success); color: var(--white); }

    .kpi-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem; }
    .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.3s; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
    .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text); margin-bottom: 0.5rem; }
    .kpi-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 600; }

    .status-indicator { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--gray-50); border-radius: 12px; margin-bottom: 1.5rem; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.success { background: var(--success); }
    .status-dot.warning { background: var(--warning); }
    .status-dot.danger { background: var(--danger); }

    .table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .table th { background: var(--gray-50); padding: 0.75rem 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
    .table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); }
    .table tbody tr:hover { background: var(--gray-50); }
    .table-success { color: var(--success); font-weight: 600; }
    .table-danger { color: var(--danger); font-weight: 600; }

    .charts-grid { display: grid; gap: 1.5rem; grid-template-columns: 1fr; margin: 2rem 0; }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
    .chart-container { position: relative; height: 300px; background: var(--white); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow-lg); }

    .divider { height: 1px; background: var(--border); margin: 2rem 0; }

    .summary-grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow-lg); }
    .summary-title { font-weight:700; font-size:.95rem; margin:0 0 .5rem; color:#0f172a; }
    .summary-value { font-weight:800; font-size:1.25rem; }
    .summary-muted { color:var(--gray-600); font-size:.85rem; }

    /* Competitor styles */
    .competitor-item { background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .competitor-url { font-family: monospace; color: var(--primary); word-break: break-all; flex: 1; }
    .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-left: 1rem; }
    .status-pending { background: var(--warning); color: white; }
    .status-success { background: var(--success); color: white; }
    
    .analysis-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin: 1.5rem 0; }
    .analysis-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-lg); }
    .analysis-title { margin: 0 0 1rem; font-size: 1.1rem; font-weight: 700; color: var(--primary); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">
          <img
            src="https://i.imgur.com/eRKd3Hp.jpeg"
            alt="Logo OptimClinic"
            loading="lazy"
            referrerpolicy="no-referrer"
          />
        </div>
        <div>
          <h1 class="brand-name">OptimClinic</h1>
          <div class="brand-tagline">Consultor√≠a m√©dica especializada</div>
        </div>
      </div>
      <h1>Planificaci√≥n Financiera y An√°lisis de Mercado</h1>
      <p class="header-description">
        Herramienta profesional completa con proyecciones financieras, an√°lisis de competencia y estrategia de mercado.
      </p>
    </div>
  </header>

  <main class="container">
    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('financial')">üìä Planificaci√≥n Financiera</div>
      <div class="tab" onclick="switchTab('competitors')">üîç An√°lisis de Competidores</div>
      <div class="tab" onclick="switchTab('market')">üìà Inteligencia de Mercado</div>
      <div class="tab" onclick="switchTab('reports')">üìã Informes</div>
    </div>

    <!-- Financial Planning Tab (TU C√ìDIGO ORIGINAL COMPLETO) -->
    <div class="tab-content active" id="financial-tab">
      <div class="grid">
        <!-- Configuraci√≥n -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">üìä Configuraci√≥n</h2>
            <div style="display:flex; gap:.75rem; align-items:center;">
              <span class="badge">EUR</span>
              <select id="ivaSel" style="padding:.25rem .5rem; width:auto" title="Tipo de IVA">
                <option value="0" selected>IVA 0%</option>
                <option value="10">IVA 10%</option>
                <option value="21">IVA 21%</option>
              </select>
            </div>
          </div>

          <div class="card-body">
            <div class="section-title">üí∞ Inversi√≥n y Horizonte</div>
            <div class="form-row-3">
              <div><label for="provincia">Provincia</label>
                <select id="provincia" onchange="actualizarDatosMercado()">
                  <option value="Valencia">Valencia</option>
                  <option value="Alicante">Alicante</option>
                  <option value="Castell√≥n">Castell√≥n</option>
                  <option value="Madrid">Madrid</option>
                  <option value="Barcelona">Barcelona</option>
                  <option value="Sevilla">Sevilla</option>
                  <option value="M√°laga">M√°laga</option>
                  <option value="Vizcaya">Vizcaya</option>
                  <option value="Murcia">Murcia</option>
                  <option value="Zaragoza">Zaragoza</option>
                  <option value="Otra">Otra</option>
                </select>
              </div>
              <div><label for="capex">CAPEX (inversi√≥n inicial) ‚Ç¨</label><input id="capex" type="number" value="80000" /></div>
              <div><label for="meses">Meses proyecci√≥n</label><input id="meses" type="number" value="36" min="6" max="84" /></div>
            </div>
            <div class="form-row">
              <div><label for="mesInicio">Mes inicial</label><input id="mesInicio" type="month" /></div>
            </div>

            <div class="section-title">üè¶ Financiaci√≥n del CAPEX</div>
            <div class="form-row-3">
              <div><label for="finImporte">Importe financiado ‚Ç¨</label><input id="finImporte" type="number" value="40000" /></div>
              <div><label for="finInteres">Inter√©s anual %</label><input id="finInteres" type="number" value="6" step="0.1" /></div>
              <div><label for="finPlazo">Plazo (meses)</label><input id="finPlazo" type="number" value="36" min="1" /></div>
            </div>
            <div class="form-row">
              <div><label for="finCarencia">Carencia (meses, solo intereses)</label><input id="finCarencia" type="number" value="0" min="0" /></div>
              <div><label for="tasaDesc">Tasa descuento anual % (VAN/TIR)</label><input id="tasaDesc" type="number" value="10" step="0.1" /></div>
            </div>

            <div class="section-title">üí≥ Mix de Pagadores</div>
            <div class="form-row-3">
              <div><label for="pctPriv">% Privado</label><input id="pctPriv" type="number" value="60" min="0" max="100" /></div>
              <div><label for="tarPriv">Tarifa Privado ‚Ç¨</label><input id="tarPriv" type="number" value="120" /></div>
              <div><label for="pctAseg">% Aseguradora</label><input id="pctAseg" type="number" value="40" min="0" max="100" /></div>
            </div>
            <div class="form-row-3">
              <div><label for="tarAseg">Tarifa Aseguradora ‚Ç¨</label><input id="tarAseg" type="number" value="70" /></div>
              <div><label for="ticketMedio">Ticket medio efectivo ‚Ç¨</label><input id="ticketMedio" type="number" value="0" readonly /></div>
              <div><label for="noShow">No-show / cancelaciones %</label><input id="noShow" type="number" value="8" step="0.1" /></div>
            </div>

            <div class="section-title">üë• Capacidad por Recursos</div>
            <div class="form-row-3">
              <div><label for="profesionales">Profesionales</label><input id="profesionales" type="number" value="2" min="1" /></div>
              <div><label for="horasDia">Horas/d√≠a</label><input id="horasDia" type="number" value="7" step="0.5" /></div>
              <div><label for="diasMes">D√≠as/mes</label><input id="diasMes" type="number" value="22" min="1" /></div>
            </div>
            <div class="form-row">
              <div><label for="minVisita">Minutos por visita</label><input id="minVisita" type="number" value="30" min="5" /></div>
              <div><label for="capacidadCalc">Capacidad calculada pacientes/mes</label><input id="capacidadCalc" type="number" value="0" readonly /></div>
            </div>

            <div class="section-title">üìà Demanda y Marketing</div>
            <div class="form-row-3">
              <div><label for="serviciosMes">Pacientes planificados/mes inicial</label><input id="serviciosMes" type="number" value="180" /></div>
              <div><label for="crecDemanda">Crecimiento org√°nico %/mes</label><input id="crecDemanda" type="number" value="3" step="0.1" /></div>
              <div><label for="mktMes">Presupuesto marketing/mes ‚Ç¨</label><input id="mktMes" type="number" value="800" /></div>
            </div>
            <div class="form-row">
              <div><label for="cpa">CPA (coste por alta) ‚Ç¨</label><input id="cpa" type="number" value="40" /></div>
            </div>

<div class="section-title">ü§ù Colaboradores (alquiler + revenue share)</div>
<div class="form-row-3">
  <div>
    <label for="colabCount">M√©dicos colaboradores (n¬∫)</label>
    <input id="colabCount" type="number" value="0" min="0" />
  </div>
  <div>
    <label for="colabAlquiler">Alquiler fijo/mes ‚Ç¨</label>
    <input id="colabAlquiler" type="number" value="0" min="0" />
  </div>
  <div>
    <label for="colabShare">% que retenemos</label>
    <input id="colabShare" type="number" value="0" min="0" max="100" step="0.5" />
  </div>
</div>
<div class="form-row-3">
  <div>
    <label for="colabHorasDia">Horas/d√≠a colaborador</label>
    <input id="colabHorasDia" type="number" value="7" step="0.5" />
  </div>
  <div>
    <label for="colabDiasMes">D√≠as/mes</label>
    <input id="colabDiasMes" type="number" value="22" />
  </div>
  <div>
    <label for="colabMinVisita">Minutos/visita</label>
    <input id="colabMinVisita" type="number" value="30" min="5" />
  </div>
</div>
<div class="form-row-3">
  <div>
    <label for="colabTarifa">Tarifa media paciente ‚Ç¨</label>
    <input id="colabTarifa" type="number" value="100" />
  </div>
  <div>
    <label for="colabPacientesIni">Pacientes iniciales/mes</label>
    <input id="colabPacientesIni" type="number" value="50" />
  </div>
  <div>
    <label for="colabCrec">% crecimiento mensual</label>
    <input id="colabCrec" type="number" value="5" step="0.1" />
  </div>
</div>

            <div class="section-title">üí∞ Costes</div>
            <div class="form-row-3">
              <div><label for="costesFijos">Costes fijos/mes ‚Ç¨</label><input id="costesFijos" type="number" value="12000" /></div>
              <div><label for="crecCF">Crec. costes fijos %/a√±o</label><input id="crecCF" type="number" value="3" step="0.1" /></div>
              <div><label for="costeVariable">Coste variable/paciente ‚Ç¨</label><input id="costeVariable" type="number" value="25" /></div>
            </div>

            <div class="section-title">üßæ Impuestos y Cobros</div>
            <div class="form-row-3">
              <div>
                <label for="impSoc">Impuesto sociedades %</label>
                <div class="switch"><input id="toggleImp" type="checkbox" checked /><label for="toggleImp">Aplicar</label></div>
                <input id="impSoc" type="number" value="25" step="0.1" />
              </div>
              <div>
                <label for="dsoAseg">Plazo cobro aseguradora (d√≠as)</label>
                <div class="switch"><input id="toggleDSO" type="checkbox" checked /><label for="toggleDSO">Aplicar</label></div>
                <input id="dsoAseg" type="number" value="60" min="0" step="1" />
              </div>
              <div><label for="amortMeses">Amortizaci√≥n contable (meses)</label><input id="amortMeses" type="number" value="36" min="1" /></div>
            </div>

            <div class="form-row" style="margin-top: 2rem;">
              <button id="calc" class="btn btn-primary" title="Generar an√°lisis completo">üìä Generar An√°lisis Completo</button>
              <button id="reset" class="btn btn-secondary" title="Restablecer par√°metros">üîÑ Restablecer</button>
            </div>
          </div>
        </section>

        <!-- Resultados -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">üìà Resultados</h2>
          </div>
          <div class="card-body">
            <div class="status-indicator">
              <div class="status-dot warning" id="statusDot"></div>
              <div id="statusText">Configure los par√°metros y genere el an√°lisis</div>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card"><div class="kpi-value" id="kpiBreakeven">‚Äî</div><div class="kpi-label">Break-even</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiROI">‚Äî</div><div class="kpi-label">ROI Final</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiNPV">‚Äî</div><div class="kpi-label">VAN (NPV)</div></div>
              <div class="kpi-card"><div class="kpi-value" id="kpiIRR">‚Äî</div><div class="kpi-label">TIR Anual</div></div>
            </div>

            <h3 style="margin:2rem 0 1rem">üéØ Calculadora de Punto de Equilibrio</h3>
            <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0891b2;">
              <div class="card-body">
                <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="precioMinimo" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Precio M√≠nimo ‚Ç¨</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="pacientesMinimos" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Pacientes M√≠nimos/mes</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="margenActual" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Margen Actual %</div></div>
                  <div class="kpi-card" style="background: white;"><div class="kpi-value" id="zonaRentabilidad" style="color: #0891b2;">‚Äî</div><div class="kpi-label">Estado</div></div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 12px;">
                  <h4 style="margin: 0 0 1rem; font-size: 0.95rem; color: #0891b2;">üí° An√°lisis de Viabilidad</h4>
                  <div id="analisisViabilidad" style="font-size: 0.875rem; line-height: 1.6; color: #475569;">Configure los par√°metros y genere el an√°lisis para ver las recomendaciones.</div>
                </div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üéØ An√°lisis de Sensibilidad</h3>
            <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #d97706;">
              <div class="card-body">
                <div style="margin-bottom: 2rem;">
                  <h4 style="margin: 0 0 1rem; font-size: 1rem; color: #92400e;">üìä Tornado Chart - Cambio en ROI Final (p.p.)</h4>
                  <div style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: .5rem; height: 350px;">
                    <canvas id="tornadoChart"></canvas>
                  </div>
                  <div style="text-align:right; font-size:.85rem; color:#64748b; margin-bottom: 1rem;">
                    ROI base: <span id="roiBaseLabel">‚Äî</span>
                  </div>
                  <div style="background: #fef3c7; border-radius: 8px; padding: 1rem; font-size: 0.875rem; line-height: 1.5;">
                    <strong>üí° C√≥mo interpretar este gr√°fico:</strong><br>
                    ‚Ä¢ <span style="color: #dc2626;">Barras rojas:</span> Cu√°nto BAJA el ROI si esa variable empeora un 20%<br>
                    ‚Ä¢ <span style="color: #16a34a;">Barras verdes:</span> Cu√°nto SUBE el ROI si esa variable mejora un 20%<br>
                    ‚Ä¢ <strong>Las variables de arriba tienen m√°s impacto</strong> - son tus palancas m√°s poderosas
                  </div>
                </div>

                <div>
                  <h4 style="margin: 0 0 1rem; font-size: 1rem; color: #92400e;">üîÑ Simulador "¬øQu√© pasar√≠a si...?"</h4>
                  <div style="background: white; border-radius: 12px; padding: 1.5rem;">
                    <div class="form-row" style="margin-bottom: 1rem;">
                      <div>
                        <label for="simTarifa">Tarifa efectiva ‚Ç¨</label>
                        <input id="simTarifa" type="range" min="50" max="200" step="5" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simTarifaValue">‚Äî</div>
                      </div>
                      <div>
                        <label for="simPacientes">Pacientes iniciales</label>
                        <input id="simPacientes" type="range" min="50" max="300" step="10" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simPacientesValue">‚Äî</div>
                      </div>
                    </div>

                    <div class="form-row" style="margin-bottom: 1rem;">
                      <div>
                        <label for="simCrecimiento">Crecimiento %/mes</label>
                        <input id="simCrecimiento" type="range" min="0" max="10" step="0.5" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simCrecimientoValue">‚Äî</div>
                      </div>
                      <div>
                        <label for="simCostesFijos">Costes fijos ‚Ç¨</label>
                        <input id="simCostesFijos" type="range" min="5000" max="20000" step="500" style="width: 100%;" />
                        <div style="text-align: center; font-weight: bold; margin-top: 0.5rem;" id="simCostesFijosValue">‚Äî</div>
                      </div>
                    </div>

                    <div style="background: #f0f9ff; border-radius: 8px; padding: 1rem;">
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af; margin-bottom: 0.25rem;" id="simROI">‚Äî</div>
                          <div style="font-size: 0.875rem; color: #64748b;">ROI Final</div>
                        </div>
                        <div style="text-align: center;">
                          <div style="font-size: 1.5rem; font-weight: bold; color: #059669; margin-bottom: 0.25rem;" id="simEBITDA">‚Äî</div>
                          <div style="font-size: 0.875rem; color: #64748b;">EBITDA √∫ltimo mes</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üìä Evoluci√≥n Financiera</h3>
            <div class="charts-grid">
              <div class="card">
                <div class="card-header"><h4 style="margin:0; font-size:1rem">P&L Operativo</h4></div>
                <div class="chart-container"><canvas id="chartPnl"></canvas></div>
              </div>
              <div class="card">
                <div class="card-header"><h4 style="margin:0; font-size:1rem">Flujo de Caja</h4></div>
                <div class="chart-container"><canvas id="chartCash"></canvas></div>
              </div>
            </div>

            <h3 style="margin:2rem 0 1rem">üìã Detalle Mensual</h3>
            <div style="overflow:auto">
              <table class="table" id="tabla">
                <<thead><tr>
  <th>Mes</th><th>Planif.</th><th>Efectivos</th><th>Ingresos</th><th>Ing. Colab</th><th>C.Var</th><th>C.Fijos</th><th>EBITDA</th><th>Amort.</th><th>EBIT</th><th>Intereses</th><th>Impuestos</th><th>Principal</th><th>Flujo Caja</th><th>Acumulado</th>
</tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="divider"></div>
            <h3 style="margin:2rem 0 1rem">üíß Resumen de Caja</h3>
            <div class="summary-grid" id="cashSummary"></div>

            <div class="divider"></div>
            <div class="form-row">
              <button id="exportCsv" class="btn btn-primary">üìä Exportar CSV</button>
              <button id="exportXlsx" class="btn btn-secondary">üìä Exportar XLSX</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Competitors Tab -->
    <div class="tab-content" id="competitors-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîç An√°lisis de Competidores</h2>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <span class="badge" id="competitorCount">0 a√±adidos</span>
            <button class="btn btn-success" onclick="loadSampleCompetitors()">üìù Cargar Ejemplo</button>
          </div>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 1rem;">
            <label for="competitorUrl">URL del competidor</label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="url" id="competitorUrl" placeholder="https://clinica-ejemplo.com" />
              <button class="btn btn-primary" onclick="addCompetitor()">A√±adir</button>
            </div>
          </div>
          
          <div id="competitorList" style="min-height: 100px;">
            <p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay competidores a√±adidos</p>
          </div>
          
          <div style="margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-success" onclick="analyzeCompetitors()" disabled id="analyzeBtn">üöÄ Analizar Competidores</button>
          </div>
        </div>
      </div>

      <div id="competitorResults" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìä Resultados del An√°lisis</h2>
          </div>
          <div class="card-body">
            <div class="analysis-grid">
              <div class="analysis-card">
                <h3 class="analysis-title">üéØ Resumen Ejecutivo</h3>
                <div id="executiveSummary"></div>
              </div>
              
              <div class="analysis-card">
                <h3 class="analysis-title">üìà An√°lisis de Mercado</h3>
                <div id="marketAnalysis"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

   <!-- Market Intelligence Tab -->
    <div class="tab-content" id="market-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìà Inteligencia de Mercado</h2>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <select id="especialidadScraper" style="padding:.5rem; font-size:0.8rem; display:none">
              <option value="">General</option>
              <option value="traumatologia">Traumatolog√≠a</option>
              <option value="fisioterapia">Fisioterapia</option>
              <option value="dermatologia">Dermatolog√≠a</option>
              <option value="ginecologia">Ginecolog√≠a</option>
              <option value="pediatria">Pediatr√≠a</option>
              <option value="psicologia">Psicolog√≠a</option>
            </select>
            <button id="adminScraperBtn" class="btn btn-secondary" style="font-size:0.8rem; display:none">
              Admin: Actualizar Precios
            </button>
          </div>
        </div>
        <div class="card-body">
          <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid var(--success); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0; color: #059669;">üè• Datos del Sector - <span id="provinciaActual">Valencia</span></h3>
              <a href="https://www.fundacionidis.com/sanidad-privada-aportando-valor" target="_blank" style="color: #059669; text-decoration: none; font-size: 0.875rem;">
                üìä Ver fuente IDIS ‚Üó
              </a>
            </div>
            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="rangoConsulta">‚Ç¨70-130</div>
                <div class="kpi-label">Rango consulta especializada</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="mixPrivado">58%</div>
                <div class="kpi-label">Mix privado estimado</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="crecimientoSector">11%</div>
                <div class="kpi-label">Crecimiento anual estimado</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-value" style="color: #059669;" id="dsoPromedio">52 d√≠as</div>
                <div class="kpi-label">DSO promedio aseguradoras</div>
              </div>
            </div>
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.75rem; color: #475569;">
              <strong>‚ö†Ô∏è Nota sobre los datos:</strong> Estimaciones basadas en informes sectoriales de IDIS (Fundaci√≥n Instituto para el Desarrollo e Integraci√≥n de la Sanidad), datos del INE sobre renta per c√°pita provincial, y ajustes regionales. Estos valores son aproximados para planificaci√≥n estrat√©gica, no constituyen precios oficiales. Se recomienda validar con investigaci√≥n de mercado local.
            </div>
          </div>

          <div class="analysis-grid">
            <div class="analysis-card">
              <h3 class="analysis-title">üìä Benchmarks Financieros</h3>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <p><strong>EBITDA objetivo:</strong> 25-35% sobre ingresos</p>
                <p><strong>Margen bruto:</strong> 65-75% (consulta - coste variable)</p>
                <p><strong>Costes fijos:</strong> 40-50% sobre ingresos</p>
                <p><strong>Marketing:</strong> 5-8% sobre ingresos</p>
                <p><strong>ROI esperado:</strong> 150-250% a 3 a√±os</p>
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Fuente: Promedios sectoriales IDIS 2024</p>
              </div>
            </div>

            <div class="analysis-card">
              <h3 class="analysis-title">üéØ Factores Cr√≠ticos de √âxito</h3>
              <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <p><strong>Ubicaci√≥n:</strong> Zona de alta renta, f√°cil acceso</p>
                <p><strong>Especializaci√≥n:</strong> Nicho espec√≠fico vs generalista</p>
                <p><strong>Tecnolog√≠a:</strong> Telemedicina, cita online</p>
                <p><strong>Experiencia:</strong> A√±os del equipo m√©dico</p>
                <p><strong>Servicios:</strong> Cartera completa vs especializada</p>
              </div>
            </div>
          </div>

          <div class="card" style="margin: 2rem 0;">
            <div class="card-header">
              <h3 style="margin: 0;">üöÄ Generador de Estrategias</h3>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div>
                  <label for="estrategiaTipo">Tipo de estrategia</label>
                  <select id="estrategiaTipo">
                    <option value="premium">Premium / Diferenciaci√≥n</option>
                    <option value="volumen">Alto Volumen / Precio Competitivo</option>
                    <option value="nicho">Especializaci√≥n / Nicho</option>
                    <option value="mixta">Estrategia Mixta</option>
                  </select>
                </div>
                <div>
                  <label for="ubicacionTipo">Tipo de ubicaci√≥n</label>
                  <select id="ubicacionTipo">
                    <option value="centro">Centro urbano</option>
                    <option value="residencial">Zona residencial</option>
                    <option value="comercial">Centro comercial</option>
                    <option value="hospital">Cerca de hospital</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="generateStrategy()">üß† Generar Estrategia Personalizada</button>
              
              <div id="strategyOutput" style="display: none; margin-top: 1.5rem;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Informes y Exportaci√≥n</h2>
        </div>
        <div class="card-body">
          <div class="analysis-grid">
            <div class="analysis-card">
              <h3 class="analysis-title">üìä Informe Ejecutivo</h3>
              <p>Resumen completo para presentar a bancos, inversores o socios.</p>
              <button class="btn btn-primary" onclick="generateExecutiveReport()">üìã Generar Informe</button>
            </div>

            <div class="analysis-card">
              <h3 class="analysis-title">üìà Dossier para Bancos</h3>
              <p>Documento espec√≠fico para solicitudes de financiaci√≥n.</p>
              <button class="btn btn-primary" onclick="generateBankDossier()">üè¶ Generar Dossier</button>
            </div>
          </div>

          <div class="card" style="margin: 2rem 0;">
            <div class="card-header">
              <h3 style="margin: 0;">üéØ Configuraci√≥n de Informes</h3>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div>
                  <label for="empresaNombre">Nombre de la empresa</label>
                  <input id="empresaNombre" type="text" placeholder="Cl√≠nica Ejemplo S.L." />
                </div>
                <div>
                  <label for="responsableNombre">Responsable del proyecto</label>
                  <input id="responsableNombre" type="text" placeholder="Dr. Juan P√©rez" />
                </div>
              </div>
            </div>
          </div>

          <div id="reportPreview" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 style="margin: 0;">üëÅÔ∏è Vista Previa del Informe</h3>
              </div>
              <div class="card-body" id="reportContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* ===================== TU C√ìDIGO JAVASCRIPT ORIGINAL COMPLETO ===================== */
    const MONTHS_ES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    
    function parseMonthYYYYMM(v) {
      if (!v || !/^\d{4}-\d{2}$/.test(v)) return new Date();
      const [Y, M] = v.split('-').map(Number);
      return new Date(Y, M - 1, 1);
    }
    
    function addMonths(d, n) { return new Date(d.getFullYear(), d.getMonth() + n, 1); }
    function monthLabel(d) { return `${MONTHS_ES[d.getMonth()]}-${d.getFullYear()}`; }

    function eur(n) {
  var ivaSel = document.getElementById('ivaSel');
  var iva = Number(ivaSel ? ivaSel.value : 0) / 100;
  var x = Math.round(Number(n || 0) * (1 + iva)); // sin decimales
  var neg = x < 0 ? '-' : '';
  var s = Math.abs(x).toString();
  var grouped = s.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // 1.000.000
  return `${neg}${grouped}\u00A0‚Ç¨`; // NBSP evita salto de l√≠nea
}
    
    function getEl(id) { return document.getElementById(id); }
    function num(id) { var el = getEl(id); return Number(el && el.value || 0); }

    function pmt(rate, nper, pv) {
      if (nper <= 0) return 0;
      if (Math.abs(rate) < 1e-12) return pv / nper;
      return pv * rate / (1 - Math.pow(1 + rate, -nper));
    }
    
    function npv(rate, cashflows) { 
      return cashflows.reduce((acc, cf, i) => acc + cf / Math.pow(1 + rate, i), 0); 
    }
    
    function irrMonthly(cashflows) {
      const npvAt = r => npv(r, cashflows);
      let lo = -0.99, hi = 3.0;
      let fLo = npvAt(lo), fHi = npvAt(hi);
      if (isNaN(fLo) || isNaN(fHi)) return NaN;
      if (fLo * fHi > 0) {
        for (let k = 0; k < 20 && fLo * fHi > 0; k++) { hi *= 0.75; fHi = npvAt(hi); }
        if (fLo * fHi > 0) return NaN;
      }
      let x0 = lo, x1 = hi, f0 = fLo, f1 = fHi;
      for (let i = 0; i < 100; i++) {
        const denom = (f1 - f0);
        let x2 = (Math.abs(denom) > 1e-12) ? x1 - f1 * (x1 - x0) / denom : (x0 + x1) / 2;
        if (x2 <= lo || x2 >= hi || !isFinite(x2)) x2 = (lo + hi) / 2;
        const f2 = npvAt(x2);
        if (Math.abs(f2) < 1e-10) return x2;
        if (f0 * f2 <= 0) { hi = x2; f1 = f2; x1 = x2; } 
        else { lo = x2; f0 = f2; x0 = x2; }
        if (Math.abs(hi - lo) < 1e-7) return (lo + hi) / 2;
      }
      return (lo + hi) / 2;
    }

    var charts = { pnl: null, cash: null, tornado: null };
    var lastData = null;
    var competitors = [];

    /* ===================== BASE DE DATOS PROVINCIAS ===================== */
    const datosProvincia = {
      'Valencia': { consulta: '‚Ç¨70-130', mixPrivado: '58%', crecimiento: '11%', dso: '52 d√≠as' },
      'Alicante': { consulta: '‚Ç¨75-135', mixPrivado: '62%', crecimiento: '12%', dso: '50 d√≠as' },
      'Castell√≥n': { consulta: '‚Ç¨65-120', mixPrivado: '54%', crecimiento: '10%', dso: '55 d√≠as' },
      'Madrid': { consulta: '‚Ç¨90-180', mixPrivado: '72%', crecimiento: '14%', dso: '48 d√≠as' },
      'Barcelona': { consulta: '‚Ç¨85-170', mixPrivado: '68%', crecimiento: '13%', dso: '50 d√≠as' },
      'Sevilla': { consulta: '‚Ç¨70-140', mixPrivado: '60%', crecimiento: '11%', dso: '53 d√≠as' },
      'M√°laga': { consulta: '‚Ç¨75-145', mixPrivado: '64%', crecimiento: '13%', dso: '51 d√≠as' },
      'Vizcaya': { consulta: '‚Ç¨85-165', mixPrivado: '70%', crecimiento: '12%', dso: '49 d√≠as' },
      'Murcia': { consulta: '‚Ç¨68-125', mixPrivado: '56%', crecimiento: '10%', dso: '54 d√≠as' },
      'Zaragoza': { consulta: '‚Ç¨72-135', mixPrivado: '59%', crecimiento: '11%', dso: '52 d√≠as' },
      'Otra': { consulta: '‚Ç¨75-140', mixPrivado: '62%', crecimiento: '11%', dso: '52 d√≠as' }
    };

    function actualizarDatosMercado() {
      const provincia = getEl('provincia').value;
      const datos = datosProvincia[provincia];
      
      getEl('provinciaActual').textContent = provincia;
      getEl('rangoConsulta').textContent = datos.consulta;
      getEl('mixPrivado').textContent = datos.mixPrivado;
      getEl('crecimientoSector').textContent = datos.crecimiento;
      getEl('dsoPromedio').textContent = datos.dso;
    }

    function actualizarCalculos() {
      var pctPriv = Math.max(0, num('pctPriv')) / 100;
      var pctAseg = Math.max(0, num('pctAseg')) / 100;
      var tarPriv = Math.max(0, num('tarPriv'));
      var tarAseg = Math.max(0, num('tarAseg'));
      var mixSum = Math.max(0.01, pctPriv + pctAseg);
      var ticketMedio = (pctPriv * tarPriv + pctAseg * tarAseg) / mixSum;
      getEl('ticketMedio').value = ticketMedio.toFixed(2);

      var profesionales = Math.max(1, num('profesionales'));
      var horasDia = Math.max(1, num('horasDia'));
      var diasMes = Math.max(1, num('diasMes'));
      var minVisita = Math.max(5, num('minVisita'));
      var capacidadCalc = Math.floor((profesionales * horasDia * diasMes * 60) / minVisita);
      getEl('capacidadCalc').value = capacidadCalc;
    }

    ['pctPriv','pctAseg','tarPriv','tarAseg','profesionales','horasDia','diasMes','minVisita'].forEach(id=>{
      getEl(id).addEventListener('input', actualizarCalculos);
    });

    function proyectar() {
  actualizarCalculos();

  var meses = Math.max(6, Math.min(84, num('meses')));
  var capex = num('capex');
  var amortMeses = Math.max(1, num('amortMeses'));
  var amortMensual = capex / amortMeses;

  var srv0 = num('serviciosMes');
  var crecM = num('crecDemanda') / 100;
  var noShowPct = num('noShow') / 100;
  var mktMes = num('mktMes');
  var cpa = Math.max(1, num('cpa'));
  var capacidadMax = num('capacidadCalc');

  var cfBase = num('costesFijos');
  var crecCFyear = num('crecCF') / 100;
  var cVar = num('costeVariable');

  var pctPriv = Math.max(0, num('pctPriv')) / 100;
  var pctAseg = Math.max(0, num('pctAseg')) / 100;
  var mixSum = Math.max(0.01, pctPriv + pctAseg);
  var wPriv = pctPriv / mixSum, wAseg = pctAseg / mixSum;
  var tarPriv = Math.max(0, num('tarPriv'));
  var tarAseg = Math.max(0, num('tarAseg'));
  var ticket = num('ticketMedio');

  var finImporte = Math.min(capex, Math.max(0, num('finImporte')));
  var finInteresAnual = Math.max(0, num('finInteres')) / 100;
  var finPlazo = Math.max(0, num('finPlazo'));
  var finCarencia = Math.max(0, num('finCarencia'));
  var rDeuda = Math.pow(1 + finInteresAnual, 1/12) - 1;

  var tasaDescAnual = Math.max(0, num('tasaDesc')) / 100;
  var rDesc = Math.pow(1 + tasaDescAnual, 1/12) - 1;

  var impEnabled = getEl('toggleImp').checked;
  var dsoEnabled = getEl('toggleDSO').checked;

  var impSoc = impEnabled ? Math.max(0, num('impSoc')) / 100 : 0;
  var dsoAsegDias = dsoEnabled ? Math.max(0, num('dsoAseg')) : 0;
  var delayAsegMeses = Math.round(dsoAsegDias / 30);

  var startDate = parseMonthYYYYMM(getEl('mesInicio').value);
  var mesesArr = [], monthLabels = [];
  for (var i = 0; i < meses; i++) { 
    mesesArr.push(i+1); 
    monthLabels.push(monthLabel(addMonths(startDate, i))); 
  }

  // === NUEVO: par√°metros de colaboradores (ingreso puro con capacidad propia) ===
  var colabCount     = Math.max(0, num('colabCount'));
  var colabAlquiler  = Math.max(0, num('colabAlquiler'));
  var colabSharePct  = Math.max(0, Math.min(100, num('colabShare'))) / 100;
  var colabHorasDia  = Math.max(1, num('colabHorasDia'));
  var colabDiasMes   = Math.max(1, num('colabDiasMes'));
  var colabMinVisita = Math.max(5, num('colabMinVisita'));
  var colabTarifa    = Math.max(0, num('colabTarifa'));
  var colabPacIni    = Math.max(0, num('colabPacientesIni'));
  var colabCrec      = Math.max(0, num('colabCrec')) / 100;

  var capColabUnit  = Math.floor((colabHorasDia * colabDiasMes * 60) / colabMinVisita);
  var capColabTotal = colabCount * capColabUnit;

  var pacientesPlanif = [], pacientesEfectivos = [];
  var ingresos = [], ingresosPriv = [], ingresosAseg = [];
  var ingresosColab = [];            // <‚Äî serie nueva
  var pacientesColabArr = [];        // <‚Äî serie nueva (pacientes atendidos por colaboradores)

  var cVariables = [], cfMensual = [], ebitda = [], amortArr = [], ebit = [];
  var intereses = [], principal = [], impuestos = [];
  var cobrosPriv = [], cobrosAseg = [];
  var flujoNeto = [], flujoAcum = [];

  var saldoDeuda = finImporte;
  var cuotaAmort = 0;
  if (finPlazo > finCarencia && saldoDeuda > 0) {
    cuotaAmort = pmt(rDeuda, Math.max(0, finPlazo - finCarencia), saldoDeuda);
  }

  var colaCobrosAseg = new Array(meses + delayAsegMeses + 5).fill(0);
  var equity0 = -(capex - finImporte);
  var cashflows = [equity0];

  for (var i = 1; i <= meses; i++) {
    // ‚Äî‚Äî‚Äî Demanda propia ‚Äî‚Äî‚Äî
    var organicos = Math.round(srv0 * Math.pow(1 + crecM, i - 1));
    var mktPacientes = Math.floor(mktMes / cpa);
    var planificados = Math.min(organicos + mktPacientes, capacidadMax);
    var efectivos = Math.round(planificados * (1 - noShowPct));

    var efectPriv = efectivos * wPriv;
    var efectAseg = efectivos * wAseg;
    var ingPriv = efectPriv * tarPriv;
    var ingAseg = efectAseg * tarAseg;

    // === Colaboradores: pacientes y facturaci√≥n del mes (capados por su capacidad) ===
    var pacColabMes = Math.min(
      Math.round(colabPacIni * Math.pow(1 + colabCrec, i - 1)),
      capColabTotal
    );
    pacientesColabArr.push(pacColabMes);

    var factColabMes = pacColabMes * colabTarifa;
    var ingresoColabMes = (colabCount * colabAlquiler) + (colabSharePct * factColabMes);
    ingresosColab.push(ingresoColabMes);

    // ‚Äî‚Äî‚Äî Ingresos totales del mes (propios + colaboradores) ‚Äî‚Äî‚Äî
    var ingresosMes = ingPriv + ingAseg + ingresoColabMes;

    // ‚Äî‚Äî‚Äî Estructura de costes propia (los colaboradores no impactan en costes) ‚Äî‚Äî‚Äî
    var cVariablesMes = efectivos * cVar;
    var cfMes = cfBase * Math.pow(1 + crecCFyear, (i - 1) / 12) + mktMes;
    var ebitdaMes = ingresosMes - cVariablesMes - cfMes;
    var amortMes = (i <= amortMeses) ? amortMensual : 0;
    var ebitMes = ebitdaMes - amortMes;

    // ‚Äî‚Äî‚Äî Deuda ‚Äî‚Äî‚Äî
    var interesesMes = 0, principalMes = 0;
    if (i <= finPlazo && saldoDeuda > 1e-6) {
      interesesMes = saldoDeuda * rDeuda;
      if (i <= finCarencia) {
        principalMes = 0;
      } else {
        principalMes = Math.min(saldoDeuda, cuotaAmort - interesesMes);
      }
      saldoDeuda -= principalMes;
    }

    // ‚Äî‚Äî‚Äî Impuestos ‚Äî‚Äî‚Äî
    var ebt = ebitMes - interesesMes;
    var impMes = (ebt > 0) ? (ebt * impSoc) : 0;

    // ‚Äî‚Äî‚Äî Cobros ‚Äî‚Äî‚Äî
    // Tratamos el ingreso de colaboradores como cobro inmediato (privado)
    var cobroPrivMes = ingPriv + ingresoColabMes;
    var cobroAsegMes = colaCobrosAseg[i-1] || 0;
    colaCobrosAseg[i - 1 + delayAsegMeses] += ingAseg;

    var flujoMes = (cobroPrivMes + cobroAsegMes) - cVariablesMes - cfMes - (interesesMes + principalMes) - impMes;
    var acumulado = (i === 1 ? equity0 : flujoAcum[i - 2]) + flujoMes;

    pacientesPlanif.push(planificados);
    pacientesEfectivos.push(efectivos);
    ingresos.push(ingresosMes);
    ingresosPriv.push(ingPriv);
    ingresosAseg.push(ingAseg);
    cVariables.push(cVariablesMes);
    cfMensual.push(cfMes);
    ebitda.push(ebitdaMes);
    amortArr.push(amortMes);
    ebit.push(ebitMes);
    intereses.push(interesesMes);
    impuestos.push(impMes);
    principal.push(principalMes);
    cobrosPriv.push(cobroPrivMes);
    cobrosAseg.push(cobroAsegMes);
    flujoNeto.push(flujoMes);
    flujoAcum.push(acumulado);
    cashflows.push(flujoMes);
  }

  var beIndex = flujoAcum.findIndex(v => v >= 0);
  var beMes = (beIndex >= 0) ? (beIndex + 1) : null;
  var roiFinal = (cashflows.reduce((a, b) => a + b, 0) / Math.abs(equity0 || 1)) * 100;
  var npvVal = npv(rDesc, cashflows);
  var irrM = irrMonthly(cashflows);
  var irrAnual = Math.pow(1 + irrM, 12) - 1;

  var utilizacionFinal = capacidadMax > 0 ? (pacientesEfectivos[pacientesEfectivos.length - 1] / capacidadMax * 100) : 0;

  var pacientesMes1 = pacientesEfectivos[0] || 0;
  var cfMes1 = cfBase + mktMes;
  var amortMes1 = capex / amortMeses;
  var precioMinimo = pacientesMes1 > 0 ? (cfMes1 + (pacientesMes1 * cVar) + amortMes1) / pacientesMes1 : 0;
  var pacientesMinimos = (ticket > cVar) ? Math.ceil((cfMes1 + amortMes1) / (ticket - cVar)) : 0;
  var margenActual = ticket > 0 ? ((ticket - cVar) / ticket * 100) : 0;
  var pacientesFinal = pacientesEfectivos[pacientesEfectivos.length - 1] || 0;

  var estadoRentabilidad = 'NO RENTABLE';
  var analisisTexto = '';

  if (pacientesMinimos > 0) {
    if (pacientesMes1 >= pacientesMinimos) {
      var exceso = ((pacientesMes1 - pacientesMinimos) / pacientesMinimos * 100).toFixed(0);
      analisisTexto = '‚úÖ <strong>Rentable desde el inicio:</strong> Con ' + pacientesMes1 + ' pacientes/mes y ticket de ' + eur(ticket) + ', superas el m√≠nimo (' + pacientesMinimos + ') en ' + exceso + '%. Margen ' + margenActual.toFixed(1) + '%.';
      estadoRentabilidad = 'RENTABLE';
    } else if (beMes) {
      if (pacientesFinal >= pacientesMinimos) {
        analisisTexto = 'üìà <strong>Viable con crecimiento:</strong> Break-even en mes ' + beMes + ' (' + monthLabels[beIndex] + ').';
        estadoRentabilidad = 'VIABLE';
      } else {
        analisisTexto = '‚ö†Ô∏è <strong>Break-even temporal:</strong> Llegas a break-even en mes ' + beMes + ' (' + monthLabels[beIndex] + '), pero el nivel final (' + pacientesFinal + ') no supera el m√≠nimo (' + pacientesMinimos + ').';
        estadoRentabilidad = 'TEMPORAL';
      }
    } else {
      analisisTexto = '‚ö†Ô∏è <strong>No viable:</strong> Con ' + pacientesMes1 + ' pacientes iniciales y ' + pacientesFinal + ' finales, no alcanzas rentabilidad. Sube ticket a ' + eur(precioMinimo) + ' o incrementa demanda.';
      estadoRentabilidad = 'NO RENTABLE';
    }
  } else {
    analisisTexto = '‚ö†Ô∏è <strong>Par√°metros incorrectos:</strong> El ticket efectivo debe ser > coste variable.';
    estadoRentabilidad = 'ERROR';
  }

  function sum(a){ return a.reduce((x,y)=>x+y,0); }
  var totalCobrosPriv = sum(cobrosPriv);
  var totalCobrosAsegEf = sum(cobrosAseg);
  var totalCobrosFactAseg = sum(ingresosAseg);
  var totalVar = sum(cVariables);
  var totalFijos = sum(cfMensual);
  var totalIntereses = sum(intereses);
  var totalPrincipal = sum(principal);
  var totalImpuestos = sum(impuestos);
  var minAcum = Math.min.apply(null, flujoAcum);
  var minIndex = flujoAcum.findIndex(v => v === minAcum);
  var necesidadMaxCaja = Math.min(0, minAcum);
  var mesMinCaja = (minIndex >= 0) ? monthLabels[minIndex] : '-';

  lastData = {
    mesesArr, monthLabels,
    pacientesPlanif, pacientesEfectivos,
    ingresos, ingresosPriv, ingresosAseg, ingresosColab, // <‚Äî a√±adimos serie de colaboradores
    cVariables, cfMensual, ebitda, amortArr, ebit, intereses, impuestos, principal,
    cobrosPriv, cobrosAseg,
    flujoNeto, flujoAcum,
    ticket, capacidadMax, utilizacionFinal,
    beMes, roiFinal, npvVal, irrAnual,
    precioMinimo, pacientesMinimos, margenActual, estadoRentabilidad, analisisTexto,
    totalCobrosPriv, totalCobrosAsegEf, totalCobrosFactAseg, totalVar, totalFijos, 
    totalIntereses, totalPrincipal, totalImpuestos, necesidadMaxCaja, mesMinCaja,
    // info colaboradores para depurar/usar despu√©s
    pacientesColabArr, capColabTotal
  };
}

    function simularConParametros(cambios) {
      var original = {};
      Object.keys(cambios).forEach(function(fieldId) {
        var el = getEl(fieldId);
        if (el) { original[fieldId] = el.value; el.value = cambios[fieldId]; }
      });
      actualizarCalculos(); 
      proyectar();
      var res = { roiFinal: lastData.roiFinal, ebitdaFinal: lastData.ebitda[lastData.ebitda.length - 1] || 0 };
      Object.keys(original).forEach(function(fieldId) { getEl(fieldId).value = original[fieldId]; });
      actualizarCalculos(); 
      proyectar();
      return res;
    }

    function calcularSensibilidad() {
      if (!lastData) return null;
      var baseROI = lastData.roiFinal;
      var vars = [
        { label: 'Tarifa Efectiva', field: 'ticketMedio',  variation: 0.20 },
        { label: 'Pacientes',       field: 'serviciosMes', variation: 0.20 },
        { label: 'Crecimiento',     field: 'crecDemanda',  variation: 0.30 },
        { label: 'Costes Fijos',    field: 'costesFijos',  variation: 0.20 },
        { label: 'No-show %',       field: 'noShow',       variation: 0.50 },
        { label: 'Marketing',       field: 'mktMes',       variation: 0.30 },
        { label: 'Coste Variable',  field: 'costeVariable',variation: 0.30 }
      ];
      
      function impactFor(field, variation, sign) {
        if (field === 'ticketMedio') {
          const ticketActual = num('ticketMedio') || 1;
          const factor = (ticketActual * (1 + sign * variation)) / ticketActual;
          return simularConParametros({
            'tarPriv': num('tarPriv') * factor,
            'tarAseg': num('tarAseg') * factor
          }).roiFinal - baseROI;
        } else {
          const base = num(field);
          return simularConParametros({ [field]: base * (1 + sign * variation) }).roiFinal - baseROI;
        }
      }
      
      var impacts = vars.map(v => {
        const plus  = impactFor(v.field, v.variation, +1);
        const minus = impactFor(v.field, v.variation, -1);
        return { name: v.label, positive: plus, negative: minus, total: Math.abs(plus) + Math.abs(minus) };
      });
      
      impacts.sort((a,b) => b.total - a.total);
      return impacts;
    }

    function renderTornadoChart() {
      var impacts = calcularSensibilidad();
      if (!impacts) return;
      var ctx = getEl('tornadoChart');
      if (charts.tornado) charts.tornado.destroy();
      
      charts.tornado = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: impacts.map(i => i.name),
          datasets: [
            { label: 'Impacto Negativo', data: impacts.map(i => i.negative), backgroundColor: '#ef4444', borderRadius: 4 },
            { label: 'Impacto Positivo', data: impacts.map(i => i.positive), backgroundColor: '#22c55e', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: 'y',
          plugins: {
            legend: { display: true },
            title: { display: true, text: 'Cambio en ROI final (p.p.)' },
            tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + ' p.p.' } }
          },
          scales: { x: { beginAtZero: true, ticks: { callback: (v) => v.toFixed(1) + ' p.p.' } } }
        }
      });
      
      getEl('roiBaseLabel').textContent = lastData.roiFinal.toFixed(1) + '%';
    }

    function initSimulator() {
      getEl('simTarifa').value = num('ticketMedio');
      getEl('simPacientes').value = num('serviciosMes');
      getEl('simCrecimiento').value = num('crecDemanda');
      getEl('simCostesFijos').value = num('costesFijos');
      updateSimulatorValues();
      
      ['simTarifa','simPacientes','simCrecimiento','simCostesFijos'].forEach(id=>{
        getEl(id).addEventListener('input', function(){ updateSimulatorValues(); simulateROI(); });
      });
      
      simulateROI();
    }

    function updateSimulatorValues() {
      getEl('simTarifaValue').textContent = eur(getEl('simTarifa').value);
      getEl('simPacientesValue').textContent = getEl('simPacientes').value;
      getEl('simCrecimientoValue').textContent = getEl('simCrecimiento').value + '%';
      getEl('simCostesFijosValue').textContent = eur(getEl('simCostesFijos').value);
    }

    function simulateROI() {
      if (!lastData) return;
      var tarifaSimulada = Number(getEl('simTarifa').value);
      var pacientesSimulados = Number(getEl('simPacientes').value);
      var crecimientoSimulado = Number(getEl('simCrecimiento').value);
      var costesSimulados = Number(getEl('simCostesFijos').value);
      var ticketActual = num('ticketMedio') || 1;
      var factorTarifa = tarifaSimulada / ticketActual;
      
      var res = simularConParametros({
        'tarPriv': num('tarPriv') * factorTarifa,
        'tarAseg': num('tarAseg') * factorTarifa,
        'serviciosMes': pacientesSimulados,
        'crecDemanda': crecimientoSimulado,
        'costesFijos': costesSimulados
      });
      
      getEl('simROI').textContent = res.roiFinal.toFixed(1) + '%';
      getEl('simROI').style.color = res.roiFinal > 100 ? '#22c55e' : (res.roiFinal > 50 ? '#f59e0b' : '#ef4444');
      getEl('simEBITDA').textContent = eur(res.ebitdaFinal);
      getEl('simEBITDA').style.color = res.ebitdaFinal > 0 ? '#059669' : '#ef4444';
    }

    function render() {
      if (!lastData) return;
      var d = lastData;
      var totalMeses = d.mesesArr.length;

      getEl('kpiBreakeven').textContent = d.beMes ? ('Mes ' + d.beMes + ' / ' + totalMeses) : 'No alcanzado';
      getEl('kpiROI').textContent = isFinite(d.roiFinal) ? d.roiFinal.toFixed(1) + '%' : '‚Äî';
      getEl('kpiNPV').textContent = eur(d.npvVal);
      getEl('kpiIRR').textContent = isFinite(d.irrAnual) ? (d.irrAnual * 100).toFixed(1) + '%' : '‚Äî';

      getEl('precioMinimo').textContent = eur(d.precioMinimo);
      getEl('pacientesMinimos').textContent = d.pacientesMinimos.toLocaleString('es-ES');
      getEl('margenActual').textContent = d.margenActual.toFixed(1) + '%';
      getEl('zonaRentabilidad').textContent = d.estadoRentabilidad;
      getEl('zonaRentabilidad').style.color = d.estadoRentabilidad === 'RENTABLE' ? '#059669' : 
        (d.estadoRentabilidad === 'VIABLE' || d.estadoRentabilidad === 'TEMPORAL') ? '#d97706' : '#dc2626';
      getEl('analisisViabilidad').innerHTML = d.analisisTexto;

      var statusDot = getEl('statusDot');
      var statusText = getEl('statusText');
      if (d.beMes) {
        statusText.textContent = 'Proyecto viable - Break-even mes ' + d.beMes;
        statusDot.className = 'status-dot success';
      } else if (d.roiFinal > 0) {
        statusText.textContent = 'Proyecto con retorno positivo';
        statusDot.className = 'status-dot warning';
      } else {
        statusText.textContent = 'Proyecto no viable';
        statusDot.className = 'status-dot danger';
      }

      var tbody = document.querySelector('#tabla tbody');
      tbody.innerHTML = '';
      d.mesesArr.forEach(function(m, i) {
        var tr = document.createElement('tr');
        var cells = [
  d.monthLabels[i],                                        // 0
  d.pacientesPlanif[i].toLocaleString('es-ES'),            // 1
  d.pacientesEfectivos[i].toLocaleString('es-ES'),         // 2
  eur(d.ingresos[i]),                                      // 3 (totales)
  eur(d.ingresosColab?.[i] || 0),                          // 4 (NUEVO: colaboradores)
  eur(d.cVariables[i]),                                    // 5
  eur(d.cfMensual[i]),                                     // 6
  eur(d.ebitda[i]),                                        // 7
  eur(d.amortArr[i]),                                      // 8
  eur(d.ebit[i]),                                          // 9
  eur(d.intereses[i]),                                     // 10
  eur(d.impuestos[i]),                                     // 11
  eur(d.principal[i]),                                     // 12
  eur(d.flujoNeto[i]),                                     // 13
  eur(d.flujoAcum[i])                                      // 14
];

cells.forEach(function(txt, idx) {
  var td = document.createElement('td');
  td.textContent = txt;
  // actualizar √≠ndices por la nueva columna
  if (idx === 7) td.className = d.ebitda[i] >= 0 ? 'table-success' : 'table-danger';
  else if (idx === 13) td.className = d.flujoNeto[i] >= 0 ? 'table-success' : 'table-danger';
  else if (idx === 14) td.className = d.flujoAcum[i] >= 0 ? 'table-success' : 'table-danger';
  tr.appendChild(td);
});
        tbody.appendChild(tr);
      });

      if (charts.pnl) charts.pnl.destroy();
      charts.pnl = new Chart(getEl('chartPnl'), {
        type: 'line',
        data: {
          labels: d.monthLabels,
          datasets: [
            { label: 'Ingresos', data: d.ingresos, borderColor: '#059669', backgroundColor: 'rgba(5,150,105,0.1)', fill: true, tension: 0.4 },
            { label: 'Costes Totales', data: d.cVariables.map((v, i) => v + d.cfMensual[i]), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.1)', fill: true, tension: 0.4 },
            { label: 'EBITDA', data: d.ebitda, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, 
          plugins: { legend: { display: true } },
          scales: { y: { ticks: { callback: v => eur(v) } } }
        }
      });

      if (charts.cash) charts.cash.destroy();
      charts.cash = new Chart(getEl('chartCash'), {
        type: 'line',
        data: {
          labels: d.monthLabels,
          datasets: [
            { label: 'Flujo Acumulado', data: d.flujoAcum, borderColor: '#9333ea', backgroundColor: 'rgba(147,51,234,0.08)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: { y: { ticks: { callback: v => eur(v) } } }
        }
      });

      const cashSummary = getEl('cashSummary');
      cashSummary.innerHTML = '';
      function card(title, value, note='') {
        const div = document.createElement('div');
        div.className = 'summary-card';
        div.innerHTML = `<div class="summary-title">${title}</div>
                         <div class="summary-value">${value}</div>
                         ${note ? `<div class="summary-muted">${note}</div>` : ''}`;
        cashSummary.appendChild(div);
      }
      card('Cobros Privado', eur(d.totalCobrosPriv));
      card('Cobros Aseguradora', eur(d.totalCobrosAsegEf));
      card('Pagos Variables', eur(d.totalVar));
      card('Pagos Fijos', eur(d.totalFijos));
      card('Necesidad m√°x. caja', eur(d.necesidadMaxCaja), 'Mes: ' + d.mesMinCaja);

      setTimeout(function(){ renderTornadoChart(); initSimulator(); }, 100);
    }

    /* ===================== TAB SWITCHING ===================== */
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      const tabs = ['financial', 'competitors', 'market', 'reports'];
      const index = tabs.indexOf(tabName);
      if (index >= 0) {
        document.querySelectorAll('.tab')[index].classList.add('active');
        getEl(tabName + '-tab').classList.add('active');
      }
    }

    /* ===================== COMPETITORS ===================== */
    /* ========== AN√ÅLISIS DE COMPETIDORES (ACTUALIZADO) ========== */

var competitors = [];
var competitorsData = [];

function addCompetitor() {
  const url = getEl('competitorUrl').value.trim();
  if (!url) return alert('Introduce una URL v√°lida');
  
  if (competitors.find(c => c.url === url)) {
    return alert('Este competidor ya est√° a√±adido');
  }
  
  competitors.push({ url, status: 'pending', data: null });
  getEl('competitorUrl').value = '';
  getEl('analyzeBtn').disabled = false;
  updateCompetitorCount();
  renderCompetitors();
}

function removeCompetitor(index) {
  competitors.splice(index, 1);
  competitorsData.splice(index, 1);
  if (competitors.length === 0) {
    getEl('analyzeBtn').disabled = true;
  }
  updateCompetitorCount();
  renderCompetitors();
}

function renderCompetitors() {
  const list = getEl('competitorList');
  if (competitors.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay competidores a√±adidos</p>';
    return;
  }
  
  list.innerHTML = competitors.map((c, i) => `
    <div class="competitor-item" style="align-items: flex-start;">
      <div style="flex: 1;">
        <div class="competitor-url">${c.url}</div>
        ${c.data ? `
          <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
            <strong>${c.data.titulo}</strong><br>
            ${c.data.servicios?.length > 0 ? 'Servicios: ' + c.data.servicios.slice(0, 4).join(', ') : ''}
            ${c.data.preciosVisibles ? ` | Precios: ‚Ç¨${c.data.preciosVisibles.min}-${c.data.preciosVisibles.max}` : ''}
          </div>
        ` : ''}
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span class="status status-${c.status}">
          ${c.status === 'pending' ? 'Pendiente' : c.status === 'analyzing' ? 'Analizando...' : c.status === 'success' ? 'Analizado' : 'Error'}
        </span>
        <button onclick="removeCompetitor(${i})" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Eliminar</button>
      </div>
    </div>
  `).join('');
}

function updateCompetitorCount() {
  getEl('competitorCount').textContent = competitors.length + ' a√±adidos';
}

function loadSampleCompetitors() {
  const provincia = getEl('provincia')?.value || 'Valencia';
  const samples = {
    'Valencia': [
      'https://www.imed.es',
      'https://www.quironsalud.es/valencia',
      'https://www.vithas.es/hospital-vithas-valencia'
    ],
    'Alicante': [
      'https://www.imed.es/centros/imed-elche',
      'https://www.quironsalud.es/alicante',
      'https://www.vithas.es/hospital-vithas-medimar'
    ],
    'Madrid': [
      'https://www.quironsalud.es/madrid',
      'https://www.sanchinarro.com',
      'https://www.cun.es'
    ]
  };
  
  const urls = samples[provincia] || samples['Valencia'];
  competitors = urls.map(url => ({ url, status: 'pending', data: null }));
  getEl('analyzeBtn').disabled = false;
  updateCompetitorCount();
  renderCompetitors();
}

async function analyzeCompetitors() {
  if (competitors.length === 0) {
    return alert('A√±ade al menos un competidor');
  }
  
  const btn = getEl('analyzeBtn');
  btn.disabled = true;
  btn.textContent = 'Analizando ' + competitors.length + ' competidores...';
  
  competitorsData = [];
  
  // Fase 1: Scraping de cada competidor
  for (let i = 0; i < competitors.length; i++) {
    competitors[i].status = 'analyzing';
    renderCompetitors();
    
    try {
      const res = await fetch('/api/scrape-competitor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: competitors[i].url })
      });
      
      const data = await res.json();
      
      if (data.status === 'success') {
        competitors[i].status = 'success';
        competitors[i].data = data;
        competitorsData.push(data);
      } else {
        competitors[i].status = 'error';
        console.error('Error scraping:', data.error);
      }
    } catch (error) {
      competitors[i].status = 'error';
      console.error('Error:', error);
    }
    
    renderCompetitors();
  }
  
  // Fase 2: An√°lisis con IA
  if (competitorsData.length > 0) {
    btn.textContent = 'Generando insights con IA...';
    
    try {
      const contexto = {
        provincia: getEl('provincia')?.value || 'Madrid',
        especialidad: getEl('especialidadScraper')?.value || 'general',
        estrategia: getEl('estrategiaTipo')?.value || 'premium',
        ubicacion: getEl('ubicacionTipo')?.value || 'centro'
      };
      
      const res = await fetch('/api/analyze-competitors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ competitors: competitorsData, contexto })
      });
      
      const analysis = await res.json();
      
      if (analysis.error) {
        console.warn('Usando an√°lisis base:', analysis.error);
      }
      
      renderAnalysisResults(analysis);
      getEl('competitorResults').style.display = 'block';
      
      // Scroll suave a resultados
      setTimeout(() => {
        getEl('competitorResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
      
    } catch (error) {
      console.error('Error en an√°lisis:', error);
      alert('Error al generar an√°lisis: ' + error.message);
    }
  } else {
    alert('No se pudo analizar ning√∫n competidor. Verifica las URLs.');
  }
  
  btn.disabled = false;
  btn.textContent = 'Analizar Competidores';
}

function renderAnalysisResults(analysis) {
  const precios = analysis.rangoPrecios || {};
  const digital = analysis.presenciaDigital || {};
  const min = Number.isFinite(precios.minimo) ? precios.minimo : 60;
  const max = Number.isFinite(precios.maximo) ? precios.maximo : 150;
  const prom = Number.isFinite(precios.promedio) ? precios.promedio : Math.round((min + max) / 2);
  const posPct = (max > min) ? ((prom - min) / (max - min) * 100) : 50;

  const showDisclaimer = !analysis.rangoPrecios || !Number.isFinite(analysis.rangoPrecios.promedio);
  const disclaimerHtml = showDisclaimer ? `
    <div style="background:#fef3c7; padding:1rem; border-radius:8px; margin-bottom:1rem; border:1px solid #f59e0b;">
      <strong>Nota:</strong> Precios agregados aproximados. Valida p√°ginas de precios/servicios de cada competidor.
    </div>
  ` : '';

  getEl('executiveSummary').innerHTML = `
    ${disclaimerHtml}
    <p style="font-size: 1rem; line-height: 1.6;">${analysis.resumenEjecutivo || 'An√°lisis completado'}</p>
    <div class="kpi-grid" style="margin-top: 1.5rem;">
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">${eur(prom)}</div>
        <div class="kpi-label">Precio Promedio</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">${(analysis.competitors || []).length}</div>
        <div class="kpi-label">Competidores Analizados</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" style="color: #2563eb;">${digital.nivel || 'Medio'}</div>
        <div class="kpi-label">Nivel Digital</div>
      </div>
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Rango de Precios</h4>
    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span>M√≠nimo: <strong>${eur(min)}</strong></span>
        <span>M√°ximo: <strong>${eur(max)}</strong></span>
      </div>
      <div style="height: 8px; background: linear-gradient(90deg, #ef4444 0%, #eab308 50%, #22c55e 100%); border-radius: 4px; position: relative;">
        <div style="position: absolute; top: -4px; left: ${Math.max(0, Math.min(100, posPct))}%; width: 16px; height: 16px; background: #2563eb; border: 2px solid white; border-radius: 50%;"></div>
      </div>
    </div>

    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Servicios Comunes</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      ${(analysis.serviciosTop || analysis.serviciosComunes || []).map(s => 
        `<span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">${s}</span>`
      ).join('')}
    </div>
  `;

  getEl('marketAnalysis').innerHTML = `
    <h4 style="margin: 0 0 0.75rem; font-size: 1rem; color: var(--primary);">Presencia Digital</h4>
    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
      <p><strong>Nivel:</strong> ${digital.nivel || 'Medio'}</p>
      <p style="margin: 0.5rem 0;">${digital.analisis || 'Sin conclusiones espec√≠ficas.'}</p>
      ${digital.redesMasUsadas?.length > 0 ? `
        <p style="margin-top: 0.5rem;"><strong>Redes m√°s usadas:</strong> ${digital.redesMasUsadas.join(', ')}</p>
      ` : ''}
    </div>
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #059669;">Fortalezas de Competidores</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.fortalezasCompetidores || []).map(f => `<li>${f}</li>`).join('')}
    </ul>
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #dc2626;">Debilidades Detectadas</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.debilidadesCompetidores || []).map(d => `<li>${d}</li>`).join('')}
    </ul>
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: #2563eb;">Oportunidades Identificadas</h4>
    ${(analysis.oportunidades || []).map(op => `
      <div style="background: ${op.impacto === 'alto' ? '#dbeafe' : '#fef3c7'}; border-left: 4px solid ${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <strong style="color: ${op.impacto === 'alto' ? '#1e40af' : '#92400e'};">${op.gap}</strong>
          <span style="background: ${op.impacto === 'alto' ? '#2563eb' : '#f59e0b'}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${op.impacto === 'alto' ? 'Alto impacto' : 'Medio impacto'}</span>
        </div>
        <p style="margin: 0.5rem 0 0; color: #475569;">${op.accion}</p>
      </div>
    `).join('')}
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">Posicionamiento Recomendado</h4>
    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #059669; padding: 1.5rem; border-radius: 12px;">
      <p style="margin: 0; line-height: 1.6; font-size: 1rem;">${analysis.posicionamientoRecomendado || ''}</p>
    </div>
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--danger);">Amenazas del Mercado</h4>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
      ${(analysis.amenazas || []).map(a => `<li>${a}</li>`).join('')}
    </ul>
    
    <h4 style="margin: 1.5rem 0 0.75rem; font-size: 1rem; color: var(--primary);">KPIs Comparativos</h4>
    <table class="table" style="margin-top: 0.5rem;">
      <thead>
        <tr>
          <th>M√©trica</th>
          <th>Competidores</th>
          <th>Recomendado</th>
        </tr>
      </thead>
      <tbody>
        ${(analysis.kpisComparativos || []).map(kpi => `
          <tr>
            <td><strong>${kpi.metrica}</strong></td>
            <td>${kpi.competidores}</td>
            <td style="color: var(--success); font-weight: 600;">${kpi.recomendado}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// Agregar input listener para Enter key
document.addEventListener('DOMContentLoaded', function() {
  const urlInput = getEl('competitorUrl');
  if (urlInput) {
    urlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addCompetitor();
      }
    });
  }
});

    /* ===================== REPORTS ===================== */
    function generateExecutiveReport() {
      const empresa = getEl('empresaNombre').value || 'Cl√≠nica Ejemplo';
      const responsable = getEl('responsableNombre').value || 'Responsable';
      
      getEl('reportContent').innerHTML = `
        <h3>Informe Ejecutivo - ${empresa}</h3>
        <p><strong>Responsable:</strong> ${responsable}</p>
        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
        <hr style="margin: 1rem 0;">
        <h4>Resumen Financiero</h4>
        ${lastData ? `
          <p>Inversi√≥n inicial: ${eur(num('capex'))}</p>
          <p>Break-even: ${lastData.beMes ? 'Mes ' + lastData.beMes : 'No alcanzado'}</p>
          <p>ROI proyectado: ${lastData.roiFinal.toFixed(1)}%</p>
        ` : '<p>Genera primero el an√°lisis financiero</p>'}
      `;
      getEl('reportPreview').style.display = 'block';
    }

    function generateBankDossier() {
      generateExecutiveReport();
    }

    /* ===================== EVENTOS ===================== */
    getEl('calc').addEventListener('click', function(){ proyectar(); render(); });
    getEl('reset').addEventListener('click', function(){ if (confirm('¬øRestablecer par√°metros?')) location.reload(); });
    
    getEl('exportCsv').addEventListener('click', function() {
      if (!lastData) return alert('Genere el an√°lisis primero');
      var d = lastData;
      var rows = d.mesesArr.map(function(_, i) {
        return [
  d.monthLabels[i], d.pacientesPlanif[i], d.pacientesEfectivos[i],
  d.ingresos[i], d.ingresosColab?.[i] || 0,
  d.cVariables[i], d.cfMensual[i], d.ebitda[i],
  d.amortArr[i], d.ebit[i], d.intereses[i], d.impuestos[i],
  d.principal[i], d.flujoNeto[i], d.flujoAcum[i]
].join(',');
      });
      var csv = ['Mes,Planif,Efectivos,Ingresos,Ing.Colab,C.Var,C.Fijos,EBITDA,Amort,EBIT,Intereses,Impuestos,Principal,Flujo,Acumulado', ...rows].join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'opticlinic_analisis.csv';
      a.click();
    });

    getEl('exportXlsx').addEventListener('click', function() {
      if (!lastData) return alert('Genere el an√°lisis primero');
      var d = lastData;
      var data = [['Mes','Planif','Efectivos','Ingresos','Ing.Colab','C.Var','C.Fijos','EBITDA','Amort','EBIT','Intereses','Impuestos','Principal','Flujo','Acumulado']];
      d.mesesArr.forEach(function(_, i) {
        data.push([
  d.monthLabels[i], d.pacientesPlanif[i], d.pacientesEfectivos[i],
  d.ingresos[i], d.ingresosColab?.[i] || 0,
  d.cVariables[i], d.cfMensual[i], d.ebitda[i],
  d.amortArr[i], d.ebit[i], d.intereses[i], d.impuestos[i],
  d.principal[i], d.flujoNeto[i], d.flujoAcum[i]
]);
      });
      var wb = XLSX.utils.book_new();
      var ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis');
      XLSX.writeFile(wb, 'opticlinic_analisis.xlsx');
    });

    /* ===================== INICIALIZACI√ìN ===================== */
    (function initStartMonth(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      getEl('mesInicio').value = `${y}-${m}`;
    })();

    setTimeout(function() { 
      actualizarCalculos(); 
      proyectar(); 
      render(); 
    }, 200);
// ========== ADMIN: SCRAPER DE DOCTORALIA ==========
(function initAdminScraper() {
  let adminClicks = 0;
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
      adminClicks++;
      if (adminClicks >= 3) {
        document.getElementById('adminScraperBtn').style.display = 'block';
        console.log('Modo admin activado'); // SIN EMOJI
        adminClicks = 0;
      }
      setTimeout(() => { adminClicks = 0; }, 2000);
    }
  });
})();

document.getElementById('adminScraperBtn')?.addEventListener('click', async function() {
  const provincia = document.getElementById('provincia').value;
  const especialidad = document.getElementById('especialidadScraper').value;
  const password = prompt('Contrase√±a de admin:');
  
  if (!password) return;
  
  const btn = this;
  btn.disabled = true;
  btn.textContent = 'Scrapeando...';
  
  try {
    const res = await fetch('/api/scrape-doctoralia', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provincia, especialidad, adminPassword: password })
    });
    
    const data = await res.json();
    
    if (!res.ok) throw new Error(data.error || 'Error en scraping');
    
    // Mostrar datos temporalmente en la interfaz
    mostrarDatosTemporales(data);
    
    // Log para copiar al c√≥digo si quieres
    console.log('=====================================');
    console.log('DATOS PARA ' + provincia + ' - ' + (data.especialidad || 'general').toUpperCase());
    console.log('=====================================');
    console.log("'" + provincia + "': {");
    console.log('  consulta: ' + data.codigoActualizar.consulta + ',');
    console.log('  mixPrivado: ' + data.codigoActualizar.mixPrivado + ',');
    console.log('  crecimiento: ' + data.codigoActualizar.crecimiento + ',');
    console.log('  dso: ' + data.codigoActualizar.dso);
    console.log('},');
    console.log('URL usada: ' + data.urlUsada);
    console.log('Muestras: ' + data.muestras);
    console.log('=====================================');
    
    alert('Scraping exitoso!\n\n' + 
          'Provincia: ' + provincia + '\n' +
          'Especialidad: ' + (data.especialidad || 'general') + '\n' +
          'Muestras: ' + data.muestras + '\n' +
          'Rango: ' + data.consulta + '\n\n' +
          'Datos actualizados en la interfaz temporalmente');
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Admin: Actualizar Precios';
  }
});

// NUEVA FUNCI√ìN: Mostrar datos scrapeados temporalmente
function mostrarDatosTemporales(data) {
  // Actualizar KPIs con datos scrapeados
  getEl('rangoConsulta').textContent = data.consulta;
  getEl('mixPrivado').textContent = data.mixPrivado;
  getEl('crecimientoSector').textContent = data.crecimiento;
  getEl('dsoPromedio').textContent = data.dso;
  getEl('provinciaActual').textContent = data.provincia + ' - ' + (data.especialidad || 'general');
  
  // Crear/actualizar banner de datos temporales
  let banner = document.getElementById('bannerDatosTemp');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'bannerDatosTemp';
    banner.style = 'background:#fef3c7; padding:1rem; border-radius:8px; margin:1rem 0; border:2px solid #f59e0b';
    
    // Insertar antes de la secci√≥n de Inteligencia de Mercado
    const marketSection = document.querySelector('#market-tab .card-body > div');
    if (marketSection) {
      marketSection.insertAdjacentElement('beforebegin', banner);
    }
  }
  
  banner.innerHTML = `
    <strong>Datos actualizados para esta sesi√≥n:</strong><br>
    ${data.provincia} - <strong>${data.especialidad || 'general'}</strong><br>
    Rango: ${data.consulta} (${data.muestras} muestras)<br>
    Mix privado: ${data.mixPrivado} | Crecimiento: ${data.crecimiento} | DSO: ${data.dso}<br>
    <small style="color:#92400e">Estos datos son temporales y no modifican la configuraci√≥n base. V√°lidos solo para esta sesi√≥n de trabajo con el cliente.</small>
    <button onclick="this.parentElement.remove()" style="float:right; margin-top:-1.5rem; background:transparent; border:none; cursor:pointer; font-size:1.2rem">√ó</button>
  `;
}

// Mostrar selector de especialidad cuando se activa modo admin
(function initAdminScraper() {
  let adminClicks = 0;
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
      adminClicks++;
      if (adminClicks >= 3) {
        document.getElementById('adminScraperBtn').style.display = 'block';
        document.getElementById('especialidadScraper').style.display = 'block';
        console.log('Modo admin activado');
        adminClicks = 0;
      }
      setTimeout(() => { adminClicks = 0; }, 2000);
    }
  });
})();
  </script>
</body>
</html>